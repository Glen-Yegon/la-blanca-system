import{auth,db,onAuthStateChanged,collection,serverTimestamp,onSnapshot,query,where,orderBy,doc,updateDoc,getDocs,deleteDoc,Timestamp}from"./firebase-config.js";const loader=document.getElementById("loader"),toastEl=document.getElementById("toast"),pendingCountEl=document.getElementById("pendingCount"),inProgressCountEl=document.getElementById("inProgressCount"),completedCountEl=document.getElementById("completedCount"),revenueSumEl=document.getElementById("revenueSum"),activeStaffEl=document.getElementById("activeStaff"),quickJobsListEl=document.getElementById("quickJobsList"),jobsTableBody=document.querySelector("#jobsTable tbody"),filterStatusSelect=document.getElementById("filterStatus"),searchInput=document.getElementById("searchInput"),refreshJobsBtn=document.getElementById("refreshJobs"),staffGridEl=document.getElementById("staffGrid"),reportsListEl=document.getElementById("reportsList"),cashReportListEl=document.getElementById("cashReportList"),usersListEl=document.getElementById("usersList"),activityLogEl=document.getElementById("activityLog"),dateFilterSelect=document.getElementById("dateFilter"),applyFilterBtn=document.getElementById("applyFilterBtn");let unsubOverview=null,unsubJobs=null,unsubStaff=null,unsubActivity=null;function showLoader(){loader&&(loader.style.display="flex")}function hideLoader(){loader&&(loader.style.display="none")}function toast(t,e=3e3){toastEl?(toastEl.textContent=t,toastEl.classList.add("visible"),setTimeout(()=>toastEl.classList.remove("visible"),e)):console.log("TOAST:",t)}function formatCurrency(t){try{return`Ksh ${Number(t).toLocaleString()}`}catch(e){return`Ksh ${t}`}}function formatDate(t){if(!t)return"—";return(t.toDate?t.toDate():new Date(t)).toLocaleString()}function startOfRange(t){const e=new Date;if("today"===t){const t=new Date(e.getFullYear(),e.getMonth(),e.getDate());return Timestamp.fromDate(t)}if("week"===t){const t=new Date(e);return t.setDate(e.getDate()-7),Timestamp.fromDate(t)}if("month"===t){const t=new Date(e);return t.setMonth(e.getMonth()-1),Timestamp.fromDate(t)}if("3months"===t){const t=new Date(e);return t.setMonth(e.getMonth()-3),Timestamp.fromDate(t)}if("year"===t){const t=new Date(e);return t.setFullYear(e.getFullYear()-1),Timestamp.fromDate(t)}return null}function startOverviewListener(t="all"){unsubOverview&&unsubOverview(),showLoader();const e=collection(db,"jobs"),a=startOfRange(t),s=a?query(e,where("createdAt",">=",a),orderBy("createdAt","desc")):query(e,orderBy("createdAt","desc"));unsubOverview=onSnapshot(s,t=>{let e=0,a=0,s=0,o=0;const n=[];if(t.forEach(t=>{const r=t.data(),l=r.status;"pending"===l?e++:"in_progress"===l?a++:"completed"===l&&(s++,o+=Number(r.total||0)),n.push({id:t.id,plate:r.plate,status:l,total:r.total||0,createdAt:r.createdAt||null,assignedTo:r.assignedTo||null})}),pendingCountEl&&(pendingCountEl.textContent=e),inProgressCountEl&&(inProgressCountEl.textContent=a),completedCountEl&&(completedCountEl.textContent=s),revenueSumEl&&(revenueSumEl.textContent=formatCurrency(o)),activeStaffEl){const t=new Set(n.filter(t=>t.assignedTo).map(t=>t.assignedTo));activeStaffEl.textContent=t.size||"0"}quickJobsListEl&&(quickJobsListEl.innerHTML=n.slice(0,8).map(t=>`\n      <div class="quick-item">\n        <div class="plate">${t.plate||"—"}</div>\n        <div class="meta">${(t.status||"—").replace("_"," ")} • ${formatCurrency(t.total)}</div>\n        <div class="time">${t.createdAt?formatDate(t.createdAt):""}</div>\n      </div>\n    `).join("")),hideLoader()},t=>{hideLoader(),console.error("Overview listener error",t),toast("Failed to load overview (permissions?)")})}function startJobsListener({status:t="all",search:e="",dateRange:a="all"}={}){unsubJobs&&unsubJobs(),showLoader();const s=collection(db,"jobs"),o=startOfRange(a),n=[];let r;t&&"all"!==t&&n.push(where("status","==",t)),o&&n.push(where("createdAt",">=",o)),r=n.length?query(s,...n,orderBy("createdAt","desc")):query(s,orderBy("createdAt","desc")),unsubJobs=onSnapshot(r,t=>{const a=[];t.forEach(t=>a.push({id:t.id,...t.data()}));renderJobsTable(a.filter(t=>{if(!e)return!0;const a=e.toLowerCase();return t.plate&&t.plate.toLowerCase().includes(a)||t.id&&t.id.toLowerCase().includes(a)})),hideLoader()},t=>{console.error("Jobs listener error",t),toast("Failed to load jobs (permissions?)"),hideLoader()})}function renderJobsTable(t=[]){jobsTableBody&&(t.length?(jobsTableBody.innerHTML=t.map(t=>{const e=t.assignedTo||"—",a=t.status?t.status.replace("_"," "):"—",s=formatCurrency(t.total||0);t.createdAt&&formatDate(t.createdAt);return`\n      <tr data-id="${t.id}">\n        <td>${t.id}</td>\n        <td>${t.plate||"—"}</td>\n        <td>${t.model||"—"}</td>\n        <td>${e}</td>\n        <td>${a}</td>\n        <td>${s}</td>\n        <td>\n          ${"pending"===t.status?`<button class="btn small start-btn" data-id="${t.id}">Start</button>`:""}\n          ${"in_progress"===t.status?`<button class="btn small complete-btn" data-id="${t.id}">Complete</button>`:""}\n          <button class="btn small details-btn" data-id="${t.id}">Details</button>\n          <button class="btn small danger delete-btn" data-id="${t.id}">Delete</button>\n        </td>\n      </tr>\n    `}).join(""),jobsTableBody.querySelectorAll(".start-btn").forEach(t=>t.onclick=async t=>{const e=t.target.dataset.id;try{await updateDoc(doc(db,"jobs",e),{status:"in_progress",startedAt:serverTimestamp()}),toast("Job started")}catch(t){console.error(t),toast("Failed to start job")}}),jobsTableBody.querySelectorAll(".complete-btn").forEach(t=>t.onclick=async t=>{const e=t.target.dataset.id;try{await updateDoc(doc(db,"jobs",e),{status:"completed",completedAt:serverTimestamp()}),toast("Job marked completed")}catch(t){console.error(t),toast("Failed to complete job")}}),jobsTableBody.querySelectorAll(".delete-btn").forEach(t=>t.onclick=async t=>{const e=t.target.dataset.id;if(confirm("Delete this job? This cannot be undone."))try{await deleteDoc(doc(db,"jobs",e)),toast("Job deleted")}catch(t){console.error(t),toast("Failed to delete job")}}),jobsTableBody.querySelectorAll(".details-btn").forEach(t=>t.onclick=t=>{const e=t.target.dataset.id,a=new CustomEvent("niapay:openJob",{detail:{id:e}});window.dispatchEvent(a)})):jobsTableBody.innerHTML='<tr><td colspan="7" class="muted">No jobs found</td></tr>')}function startStaffListener(t="all"){unsubStaff&&unsubStaff();const e=collection(db,"users"),a=startOfRange(t),s=query(e,where("role","==","staff"),orderBy("displayName","asc"));unsubStaff=onSnapshot(s,async t=>{const e=[];for(const a of t.docs)e.push({id:a.id,...a.data()});renderStaffGrid(await Promise.all(e.map(async t=>{const e=collection(db,"jobs"),s=[where("assignedTo","==",t.uid||t.id)];a&&s.push(where("createdAt",">=",a));const o=query(e,...s),n=await getDocs(o),r=[];n.forEach(t=>r.push({id:t.id,...t.data()}));const l=r.length,i=r.reduce((t,e)=>t+(e.timeMinutes||0),0);return{...t,totalCars:l,timeSpent:i,jobs:r}})))},t=>{console.error("Staff listener err",t),toast("Failed to load staff")})}function renderStaffGrid(t=[]){staffGridEl&&(t.length?staffGridEl.innerHTML=t.map(t=>`\n    <div class="staff-card">\n      <div class="top">\n        <div class="avatar">${t.displayName?t.displayName[0].toUpperCase():"S"}</div>\n        <div class="info">\n          <div class="name">${t.displayName||t.email||t.id}</div>\n          <div class="meta">Cars: ${t.totalCars} • Time: ${t.timeSpent} min</div>\n        </div>\n      </div>\n      <div class="jobs-list">\n        ${t.jobs.slice(0,5).map(t=>`<div class="job-small">${t.plate||t.id} • ${t.status}</div>`).join("")}\n      </div>\n    </div>\n  `).join(""):staffGridEl.innerHTML='<div class="muted">No staff found</div>')}function startActivityListener(t="all"){unsubActivity&&unsubActivity();const e=collection(db,"activity"),a=startOfRange(t),s=a?query(e,where("createdAt",">=",a),orderBy("createdAt","desc")):query(e,orderBy("createdAt","desc"));unsubActivity=onSnapshot(s,t=>{activityLogEl&&(t.size?activityLogEl.innerHTML=t.docs.map(t=>{const e=t.data();return`<div class="activity-item">\n        <div class="act-time">${formatDate(e.createdAt)}</div>\n        <div class="act-text">${e.text||e.action||JSON.stringify(e)}</div>\n      </div>`}).join(""):activityLogEl.innerHTML='<div class="muted">No activity</div>')},t=>{console.error("Activity listener err",t),toast("Failed to load activity")})}async function generateCashReport(t="all"){showLoader();try{const e=collection(db,"jobs"),a=startOfRange(t),s=[where("status","==","completed")];a&&s.push(where("createdAt",">=",a));const o=query(e,...s,orderBy("createdAt","desc")),n=await getDocs(o),r=[];let l=0;return n.forEach(t=>{const e=t.data();r.push({id:t.id,plate:e.plate,total:e.total||0,date:e.createdAt||null,assignedTo:e.assignedTo||null}),l+=Number(e.total||0)}),cashReportListEl&&(cashReportListEl.innerHTML=`\n        <div class="report-summary">\n          <div>Total completed jobs: ${r.length}</div>\n          <div>Total revenue: ${formatCurrency(l)}</div>\n        </div>\n        <div class="report-items">\n          ${r.map(t=>`<div class="report-row">${formatDate(t.date)} • ${t.plate||"—"} • ${formatCurrency(t.total)} • ${t.assignedTo||"—"}</div>`).join("")}\n        </div>\n      `),hideLoader(),{items:r,total:l}}catch(t){return console.error(t),hideLoader(),toast("Failed to generate cash report"),{items:[],total:0}}}async function assignJobTo(t,e){try{await updateDoc(doc(db,"jobs",t),{assignedTo:e,updatedAt:serverTimestamp()}),toast("Assigned")}catch(t){console.error(t),toast("Assign failed")}}async function deleteJobById(t){try{await deleteDoc(doc(db,"jobs",t)),toast("Job deleted")}catch(t){console.error(t),toast("Delete failed")}}function wireUI(){if(applyFilterBtn&&dateFilterSelect&&(applyFilterBtn.onclick=()=>{const t=dateFilterSelect.value||"all";startOverviewListener(t),startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput?searchInput.value:"",dateRange:t}),startStaffListener(t),startActivityListener(t),generateCashReport(t),toast(`Applied filter: ${t}`)}),refreshJobsBtn&&(refreshJobsBtn.onclick=()=>{const t=dateFilterSelect?dateFilterSelect.value:"all";startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput?searchInput.value:"",dateRange:t}),toast("Jobs refreshed")}),filterStatusSelect&&(filterStatusSelect.onchange=()=>{const t=dateFilterSelect?dateFilterSelect.value:"all";startJobsListener({status:filterStatusSelect.value,search:searchInput?searchInput.value:"",dateRange:t})}),searchInput){let t;searchInput.oninput=()=>{clearTimeout(t),t=setTimeout(()=>{const t=dateFilterSelect?dateFilterSelect.value:"all";startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput.value,dateRange:t})},350)}}window.addEventListener("niapay:openJob",t=>{const{id:e}=t.detail||{};e&&(async()=>{try{const t=query(collection(db,"jobs"),where("__name__","==",e)),a=await getDocs(t);if(a.docs.length){const t=a.docs[0].data(),s={id:e,...t};window.dispatchEvent(new CustomEvent("niapay:jobLoaded",{detail:s}))}else console.warn("Job not found",e)}catch(t){console.error(t)}})()})}function startManagerApp(){wireUI(),onAuthStateChanged(auth,t=>{t?(startOverviewListener("all"),startJobsListener({status:"all",search:"",dateRange:"all"}),startStaffListener("all"),startActivityListener("all"),generateCashReport("all")):console.log("Manager not signed in — redirect to sign page or show login")})}export{startManagerApp,startOverviewListener,startJobsListener,startStaffListener,startActivityListener,generateCashReport,assignJobTo,deleteJobById};