import{auth,db,onAuthStateChanged,collection,collectionGroup,addDoc,setDoc,serverTimestamp,onSnapshot,query,where,orderBy,doc,updateDoc,getDocs,getDoc,deleteDoc,Timestamp}from"./firebase-config.js";const loader=document.getElementById("loader"),toastEl=document.getElementById("toast"),pendingCountEl=document.getElementById("pendingCount"),inProgressCountEl=document.getElementById("inProgressCount"),completedCountEl=document.getElementById("completedCount"),revenueSumEl=document.getElementById("revenueSum"),activeStaffEl=document.getElementById("activeStaff"),quickJobsListEl=document.getElementById("quickJobsList"),jobsTableBody=document.querySelector("#jobsTable tbody"),filterStatusSelect=document.getElementById("filterStatus"),searchInput=document.getElementById("searchInput"),refreshJobsBtn=document.getElementById("refreshJobs"),staffGridEl=document.getElementById("staffGrid"),reportsListEl=document.getElementById("reportsList"),cashReportListEl=document.getElementById("cashReportList"),usersListEl=document.getElementById("usersList"),activityLogEl=document.getElementById("activityLog");let unsubOverview=null,unsubJobs=null,unsubStaff=null,unsubActivity=null,globalStartTs=null,globalEndTs=null;function setGlobalDateRange(t,e){console.log("[GLOBAL] Setting global date range:",{startTs:t,endTs:e}),globalStartTs=t,globalEndTs=e}function getGlobalDateRange(){return console.log("[GLOBAL] Getting global date range:",{start:globalStartTs,end:globalEndTs}),{start:globalStartTs,end:globalEndTs}}function showLoader(){loader&&(loader.style.display="flex")}function hideLoader(){loader&&(loader.style.display="none")}function toast(t,e=3e3){toastEl?(toastEl.textContent=t,toastEl.classList.add("visible"),setTimeout(()=>toastEl.classList.remove("visible"),e)):console.log("TOAST:",t)}function formatCurrency(t){try{return`Ksh ${Number(t).toLocaleString()}`}catch(e){return`Ksh ${t}`}}function formatDate(t){if(!t)return"—";return(t.toDate?t.toDate():new Date(t)).toLocaleString()}const startDateInput=document.getElementById("startDate"),endDateInput=document.getElementById("endDate"),applyDateRangeBtn=document.getElementById("applyDateRangeBtn");async function loadJobsByDateRange(t,e){console.log("[JOBS] loadJobsByDateRange STARTED",{startTs:t,endTs:e});try{showLoader();let o=collectionGroup(db,"jobs"),a=null;if(t&&e)console.log("[JOBS] Query: BETWEEN start & end"),a=query(o,where("createdAt",">=",t),where("createdAt","<=",e));else if(t&&!e)console.log("[JOBS] Query: FROM start → infinity"),a=query(o,where("createdAt",">=",t));else{if(t||!e)return void console.log("[JOBS] No date filter applied! Returning...");console.log("[JOBS] Query: FROM -infinity → end"),a=query(o,where("createdAt","<=",e))}console.log("[JOBS] Executing Firestore query:",a);const s=await getDocs(a);console.log("[JOBS] Firestore returned docs:",s.docs.length);const n=s.docs.map(t=>{const e=t.data();return console.log("[JOBS] Job:",{id:t.id,...e}),{id:t.id,...e}});console.log("[JOBS] Final jobs array:",n),renderJobsTable(n),toast(`Loaded ${n.length} job(s) for selected date range.`)}catch(t){console.error("[JOBS] Error loading date range:",t),toast("Failed to load data.")}finally{hideLoader()}}function startOfRange(t){const e=new Date;if("today"===t){const t=new Date(e.getFullYear(),e.getMonth(),e.getDate());return Timestamp.fromDate(t)}if("week"===t){const t=new Date(e);return t.setDate(e.getDate()-7),Timestamp.fromDate(t)}if("month"===t){const t=new Date(e);return t.setMonth(e.getMonth()-1),Timestamp.fromDate(t)}if("3months"===t){const t=new Date(e);return t.setMonth(e.getMonth()-3),Timestamp.fromDate(t)}if("year"===t){const t=new Date(e);return t.setFullYear(e.getFullYear()-1),Timestamp.fromDate(t)}return null}async function startOverviewListener(t="all",e=null){console.log("Starting overview listener with:",{dateRangeOrStart:t,endTs:e}),unsubOverview&&(console.log("Unsubscribing previous overview listener"),unsubOverview()),showLoader();let o=null;"string"==typeof t?o=startOfRange(t):t&&t.toDate&&(o=t),console.log("Computed rangeStart:",o,"endTs:",e);try{const t=collectionGroup(db,"jobs"),a=[];o&&a.push(where("createdAt",">=",o)),e&&a.push(where("createdAt","<=",e));const s=a.length?query(t,...a,orderBy("createdAt","desc")):query(t,orderBy("createdAt","desc")),n=await getDocs(s);console.log("Total jobs found (collection group):",n.size);let r=0,i=0,l=0,c=0;const d=[];if(n.forEach(t=>{const e=t.data(),o=t.ref.path.split("/"),a="corporates"===o[0]?o[1]:null,s=e.status;"pending"===s?r++:"in_progress"===s?i++:"completed"===s&&(l++,c+=Number(e.total||0)),d.push({id:t.id,plate:e.plate||"—",status:s||"pending",total:e.total||0,createdAt:e.createdAt||null,assignedTo:e.assignedTo||null,company:a})}),pendingCountEl&&(pendingCountEl.textContent=r),inProgressCountEl&&(inProgressCountEl.textContent=i),completedCountEl&&(completedCountEl.textContent=l),revenueSumEl&&(revenueSumEl.textContent=formatCurrency(c)),activeStaffEl){const t=new Set(d.filter(t=>t.assignedTo).map(t=>t.assignedTo));activeStaffEl.textContent=t.size||"0"}quickJobsListEl&&(quickJobsListEl.innerHTML=d.sort((t,e)=>e.createdAt?.toMillis()-t.createdAt?.toMillis()).slice(0,8).map(t=>`\n          <div class="quick-card">\n            <div class="quick-header">\n              <span class="quick-plate">${t.plate||"—"}</span>\n              <span class="quick-status ${t.status}">${(t.status||"—").replace("_"," ")}</span>\n            </div>\n            <div class="quick-body">\n              <div class="quick-total">${formatCurrency(t.total)}</div>\n              <div class="quick-time">${t.createdAt?formatDate(t.createdAt):""}</div>\n              <div class="quick-company">${t.company||"Main"}</div>\n            </div>\n          </div>\n        `).join(""))}catch(t){console.error("Overview listener error:",t),toast("Failed to load overview (permissions?)")}finally{hideLoader(),console.log("Overview listener update complete.")}}async function startJobsListener({status:t="all",search:e="",dateRange:o="all"}={}){unsubJobs&&unsubJobs(),showLoader();const a=startOfRange(o);try{const o=collectionGroup(db,"jobs"),s=[];t&&"all"!==t&&s.push(where("status","==",t)),a&&s.push(where("createdAt",">=",a));const n=s.length?query(o,...s,orderBy("createdAt","desc")):query(o,orderBy("createdAt","desc")),r=await getDocs(n);console.log("Jobs found (collection group):",r.size);const i=r.docs.map(t=>{const e=t.ref.path.split("/"),o="corporates"===e[0]?e[1]:null;return{id:t.id,company:o,...t.data()}});renderJobsTable(i.filter(t=>{if(!e)return!0;const o=e.toLowerCase();return t.plate&&t.plate.toLowerCase().includes(o)||t.id&&t.id.toLowerCase().includes(o)||t.company&&t.company.toLowerCase().includes(o)}))}catch(t){console.error("Jobs listener error:",t),toast("Failed to load jobs (permissions?)")}finally{hideLoader()}}function renderJobsTable(t=[]){if(!jobsTableBody)return;if(!t.length)return void(jobsTableBody.innerHTML='<tr><td colspan="8" class="muted">No jobs found</td></tr>');jobsTableBody.innerHTML=t.map(t=>{const e=t.assignedTo||"—",o=t.status?t.status.replace("_"," "):"—",a=formatCurrency(t.total||0),s=(t.createdAt&&formatDate(t.createdAt),t.company||null);return`\n      <tr data-id="${t.id}" data-company="${s||""}">\n        <td>${t.id}</td>\n        <td>${t.plate||"—"}</td>\n        <td>${t.model||"—"}</td>\n        <td>${e}</td>\n        <td>${o}</td>\n        <td>${a}</td>\n        <td>${s||"Main"}</td>\n        <td>\n          ${"pending"===t.status?`<button class="btn small start-btn" data-id="${t.id}" data-company="${s||""}">Start</button>`:""}\n          ${"in_progress"===t.status?`<button class="btn small complete-btn" data-id="${t.id}" data-company="${s||""}">Complete</button>`:""}\n          <button class="btn small details-btn" data-id="${t.id}" data-company="${s||""}">Details</button>\n          <button class="btn small danger delete-btn" data-id="${t.id}" data-company="${s||""}">Delete</button>\n        </td>\n      </tr>\n    `}).join("");const e=(t,e)=>e?doc(db,"corporates",e,"jobs",t):doc(db,"jobs",t);jobsTableBody.querySelectorAll(".start-btn").forEach(t=>t.onclick=async t=>{const o=t.target.dataset.id,a=t.target.dataset.company||null;try{await updateDoc(e(o,a),{status:"in_progress",startedAt:serverTimestamp()}),toast("Job started")}catch(t){console.error(t),toast("Failed to start job")}}),jobsTableBody.querySelectorAll(".complete-btn").forEach(t=>t.onclick=async t=>{const o=t.target.dataset.id,a=t.target.dataset.company||null;try{await updateDoc(e(o,a),{status:"completed",completedAt:serverTimestamp()}),toast("Job marked completed")}catch(t){console.error(t),toast("Failed to complete job")}}),jobsTableBody.querySelectorAll(".delete-btn").forEach(t=>t.onclick=async t=>{const o=t.target.dataset.id,a=t.target.dataset.company||null;if(confirm("Delete this job? This cannot be undone."))try{await deleteDoc(e(o,a)),toast("Job deleted")}catch(t){console.error(t),toast("Failed to delete job")}}),jobsTableBody.querySelectorAll(".details-btn").forEach(t=>t.onclick=t=>{openJobModal(t.target.dataset.id,t.target.dataset.company||null)})}async function openJobModal(t){const e=document.getElementById("jobModal"),o=document.getElementById("modalBody");e.classList.remove("hidden"),o.innerHTML="Loading...";try{const e=await getDoc(doc(db,"jobs",t));if(!e.exists())return void(o.innerHTML="Job not found.");const a=e.data();o.innerHTML=`\n      <div class="modal-row"><strong>Plate:</strong> ${a.plate}</div>\n      <div class="modal-row"><strong>Model:</strong> ${a.model}</div>\n      <div class="modal-row"><strong>Status:</strong> ${a.status.replace("_"," ")}</div>\n      <div class="modal-row"><strong>Total:</strong> ${formatCurrency(a.total)}</div>\n      <div class="modal-row"><strong>Assigned To:</strong> ${a.assignedTo||"—"}</div>\n      <div class="modal-row"><strong>Created:</strong> ${a.createdAt?formatDate(a.createdAt):"—"}</div>\n    `}catch(t){o.innerHTML="Error loading job details.",console.error(t)}}async function getCommissionRate(){try{const t=await getDoc(doc(db,"commissions","settings"));if(t.exists())return Number(t.data().rate)/100}catch(t){console.error("Failed to load commission:",t)}return.1}async function startStaffListener(t="month"){"function"==typeof unsubStaff&&unsubStaff(),console.log("Starting staff listener for range:",t);const e=startOfRange(t);console.log("Range start timestamp:",e?.toDate());try{const t=await getDoc(doc(db,"commissions","settings"));let o=[];t.exists()?(o=t.data().tiers||[],console.log("Loaded commission tiers:",o)):console.warn("No commission tiers found. Defaulting to 0%");const a=collectionGroup(db,"jobs"),s=[where("status","==","completed")];e&&s.push(where("createdAt",">=",e));const n=query(a,...s,orderBy("createdAt"),orderBy("assignedTo")),r=await getDocs(n);if(console.log("Completed jobs snapshot received:",r.size,"docs"),!r.size)return console.warn("No completed jobs found."),void(staffGridEl.innerHTML='<div class="muted">No staff jobs found</div>');const i={};r.forEach(t=>{const e=t.data(),o=e.assignedTo||"Unassigned";i[o]||(i[o]={totalRevenue:0,totalCars:0}),i[o].totalRevenue+=Number(e.total||0),i[o].totalCars+=1});const l=t=>{if(!o.length)return 0;const e=o.find(e=>t>=e.min&&t<=e.max);return e?e.rate:0},c=Object.keys(i).map(t=>{const e=i[t].totalRevenue,o=i[t].totalCars,a=l(e),s=e*a;return console.log(`Staff: ${t}, Revenue: ${e}, Rate: ${a}, Commission: ${s}`),{displayName:t,totalRevenue:e,totalCars:o,commission:s}});console.log("Staff metrics with tiered commission:",c),renderStaffGrid(c)}catch(t){console.error("Staff listener error:",t),toast("Failed to load staff")}}function renderStaffGrid(t=[]){if(!staffGridEl)return;if(!t.length)return void(staffGridEl.innerHTML='<div class="muted">No staff found</div>');console.log("Rendering staff grid with",t.length,"staff members");const e=t.map(t=>`\n    <div class="staff-row">\n      <div class="col name">${t.displayName}</div>\n      <div class="col jobs">${t.totalCars}</div>\n      <div class="col revenue">${formatCurrency(t.totalRevenue)}</div>\n      <div class="col commission">${formatCurrency(t.commission)}</div>\n    </div>\n  `).join("");staffGridEl.innerHTML='\n    <div class="staff-row staff-header">\n      <div class="col name">Name</div>\n      <div class="col jobs">Jobs Done</div>\n      <div class="col revenue">Revenue</div>\n      <div class="col commission">Commission</div>\n    </div>\n  '+e}function startActivityListener(t="all"){unsubActivity&&unsubActivity();const e=collection(db,"activity"),o=startOfRange(t),a=o?query(e,where("createdAt",">=",o),orderBy("createdAt","desc")):query(e,orderBy("createdAt","desc"));unsubActivity=onSnapshot(a,t=>{activityLogEl&&(t.size?activityLogEl.innerHTML=t.docs.map(t=>{const e=t.data();return`<div class="activity-item">\n        <div class="act-time">${formatDate(e.createdAt)}</div>\n        <div class="act-text">${e.text||e.action||JSON.stringify(e)}</div>\n      </div>`}).join(""):activityLogEl.innerHTML='<div class="muted">No activity</div>')},t=>{console.error("Activity listener err",t),toast("Failed to load activity")})}async function generateCashReport(t="all"){showLoader();try{const e=startOfRange(t),o=collectionGroup(db,"jobs"),a=[where("status","==","completed")];e&&a.push(where("createdAt",">=",e));const s=query(o,...a,orderBy("createdAt","desc")),n=await getDocs(s),r=[];let i=0;return n.forEach(t=>{const e=t.data(),o=t.ref.path.split("/"),a=o[1]&&"corporates"===o[0]?o[1]:null;r.push({id:t.id,plate:e.plate,total:e.total||0,date:e.createdAt||null,assignedTo:e.assignedTo||null,company:a}),i+=Number(e.total||0)}),cashReportListEl&&(cashReportListEl.innerHTML=`\n        <div class="report-summary">\n          <div>Total completed jobs: ${r.length}</div>\n          <div>Total revenue: ${formatCurrency(i)}</div>\n        </div>\n        <div class="report-items">\n          ${r.map(t=>`\n            <div class="report-row">\n              ${formatDate(t.date)} • ${t.plate||"—"} • ${formatCurrency(t.total)} • ${t.assignedTo||"—"} ${t.company?`• ${t.company}`:""}\n            </div>`).join("")}\n        </div>\n      `),hideLoader(),{items:r,total:i}}catch(t){return console.error(t),hideLoader(),toast("Failed to generate cash report"),{items:[],total:0}}}applyDateRangeBtn.addEventListener("click",()=>{console.log("[DATE-FILTER] APPLY CLICKED");const t=startDateInput.value?new Date(startDateInput.value):null,e=endDateInput.value?new Date(endDateInput.value):null;if(!t||!e)return void toast("Select both start and end dates");e.setHours(23,59,59);const o=Timestamp.fromDate(t),a=Timestamp.fromDate(e);setGlobalDateRange(o,a),console.log("[DATE-FILTER] Converted to Firestore Timestamp:",{startTs:o,endTs:a}),loadJobsByDateRange(o,a),startOverviewListener(o,a),toast("Date filter applied")}),document.getElementById("closeJobModal").onclick=()=>document.getElementById("jobModal").classList.add("hidden"),window.onclick=function(t){const e=document.getElementById("jobModal");t.target===e&&e.classList.add("hidden")},startStaffListener();const staffRef=collection(db,"staff"),servicesRef=collection(db,"services"),companiesRef=collection(db,"companies"),staffListEl=document.getElementById("staffList");document.getElementById("addStaffBtn").onclick=async()=>{const t=document.getElementById("staffFirstName").value.trim(),e=document.getElementById("staffLastName").value.trim();if(!t||!e)return toast("Enter first and last name");try{await addDoc(staffRef,{firstName:t,lastName:e,createdAt:serverTimestamp()}),document.getElementById("staffFirstName").value="",document.getElementById("staffLastName").value="",toast("Staff added")}catch(t){console.error(t),toast("Failed to add staff")}};const servicesListEl=document.getElementById("servicesList");document.getElementById("addServiceBtn").onclick=async()=>{const t=document.getElementById("serviceName").value.trim(),e=parseFloat(document.getElementById("servicePrice").value);if(!t||isNaN(e))return toast("Enter valid service name and price");try{await addDoc(servicesRef,{name:t,price:e,createdAt:serverTimestamp()}),document.getElementById("serviceName").value="",document.getElementById("servicePrice").value="",toast("Service added")}catch(t){console.error(t),toast("Failed to add service")}};const companiesListEl=document.getElementById("companiesList");document.getElementById("addCompanyBtn").onclick=async()=>{const t=document.getElementById("companyName").value.trim();if(!t)return toast("Enter company name");try{await addDoc(companiesRef,{name:t,createdAt:serverTimestamp()}),document.getElementById("companyName").value="",toast("Company added")}catch(t){console.error(t),toast("Failed to add company")}};const commissionDocRef=doc(db,"commissions","settings"),commissionStatusEl=document.getElementById("commissionStatus"),saveCommissionBtn=document.getElementById("saveCommissionBtn");function displayTiers(t,e="Commission Tiers"){if(console.log("displayTiers called with tiers:",t,"title:",e),!t||!t.length)return console.log("No tiers provided or tiers empty"),void(commissionStatusEl.textContent="No commission tiers set yet.");const o=t.map(t=>t.max===Number.MAX_SAFE_INTEGER?`${t.min.toLocaleString()}+ → ${100*t.rate}%`:`${t.min.toLocaleString()}–${t.max.toLocaleString()} → ${100*t.rate}%`).join("<br>");commissionStatusEl.innerHTML=`<strong>${e}:</strong><br>`+o,console.log("Updated commissionStatusEl with formatted tiers")}async function loadCommission(){console.log("Loading commission from Firestore...");try{const t=await getDoc(commissionDocRef);if(console.log("Firestore snapshot received:",t),t.exists()){const e=t.data();console.log("Commission document exists. Data:",e),displayTiers(e.tiers,"Commission Tiers Loaded")}else console.warn("Commission document does not exist"),displayTiers(null)}catch(t){console.error("Failed to load commission:",t),toast("Failed to load commission")}}function renderAdminList(t,e,o){t.size?(e.innerHTML=t.docs.map(t=>{const e=t.data(),a="staff"===o?`${e.firstName} ${e.lastName}`:"services"===o?`${e.name} - Ksh ${e.price}`:e.name;return`\n      <li data-id="${t.id}">\n        <span>${a}</span>\n        <button class="edit-btn">Edit</button>\n        <button class="delete-btn">Delete</button>\n      </li>\n    `}).join(""),e.querySelectorAll(".edit-btn").forEach(e=>{e.onclick=async e=>{const a=e.target.parentElement.dataset.id,s=doc(db,"staff"===o?"staff":"services"===o?"services":"companies",a),n=t.docs.find(t=>t.id===a).data();if("staff"===o){const t=prompt("First Name:",n.firstName),e=prompt("Last Name:",n.lastName);if(!t||!e)return;await updateDoc(s,{firstName:t,lastName:e})}else if("services"===o){const t=prompt("Service Name:",n.name),e=parseFloat(prompt("Price (Ksh):",n.price));if(!t||isNaN(e))return;await updateDoc(s,{name:t,price:e})}else{const t=prompt("Company Name:",n.name);if(!t)return;await updateDoc(s,{name:t})}toast(`${o.charAt(0).toUpperCase()+o.slice(1)} updated`)}}),e.querySelectorAll(".delete-btn").forEach(t=>{t.onclick=async t=>{if(!confirm("Are you sure?"))return;const e=t.target.parentElement.dataset.id,a=doc(db,"staff"===o?"staff":"services"===o?"services":"companies",e);await deleteDoc(a),toast(`${o.charAt(0).toUpperCase()+o.slice(1)} deleted`)}})):e.innerHTML=`<li class="muted">No ${o} found</li>`}async function assignJobTo(t,e){try{await updateDoc(doc(db,"jobs",t),{assignedTo:e,updatedAt:serverTimestamp()}),toast("Assigned")}catch(t){console.error(t),toast("Assign failed")}}async function deleteJobById(t){try{await deleteDoc(doc(db,"jobs",t)),toast("Job deleted")}catch(t){console.error(t),toast("Delete failed")}}function wireUI(){if(filterStatusSelect&&(filterStatusSelect.onchange=()=>{console.log("[FILTER] Status changed:",filterStatusSelect.value),console.log("[FILTER] Using global range:",{globalStartTs:globalStartTs,globalEndTs:globalEndTs}),startJobsListener({status:filterStatusSelect.value,search:searchInput?searchInput.value:"",start:globalStartTs,end:globalEndTs})}),searchInput){let t;searchInput.oninput=()=>{clearTimeout(t),t=setTimeout(()=>{console.log("[FILTER] Search:",searchInput.value),console.log("[FILTER] Using global range:",{globalStartTs:globalStartTs,globalEndTs:globalEndTs}),startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput.value,start:globalStartTs,end:globalEndTs})},350)}}refreshJobsBtn&&(refreshJobsBtn.onclick=()=>{console.log("[FILTER] Refresh clicked"),console.log("[FILTER] Using global range:",{globalStartTs:globalStartTs,globalEndTs:globalEndTs}),startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput?searchInput.value:"",start:globalStartTs,end:globalEndTs}),toast("Jobs refreshed")}),window.addEventListener("niapay:openJob",t=>{const{id:e}=t.detail||{};e&&(async()=>{try{const t=query(collection(db,"jobs"),where("__name__","==",e)),o=await getDocs(t);if(o.docs.length){const t=o.docs[0].data(),a={id:e,...t};window.dispatchEvent(new CustomEvent("niapay:jobLoaded",{detail:a}))}else console.warn("Job not found",e)}catch(t){console.error(t)}})()})}function startManagerApp(){wireUI(),onAuthStateChanged(auth,t=>{t?(startOverviewListener("all"),startJobsListener({status:"all",search:"",dateRange:"all"}),startStaffListener("all"),startActivityListener("all"),generateCashReport("all")):console.log("Manager not signed in — redirect to sign page or show login")})}loadCommission(),saveCommissionBtn.onclick=async()=>{console.log("Save commission button clicked");try{const t=[{min:0,max:24999,rate:.2},{min:25e3,max:29999,rate:.25},{min:3e4,max:Number.MAX_SAFE_INTEGER,rate:.3}];console.log("Saving tiers to Firestore:",t),await setDoc(commissionDocRef,{tiers:t,updatedAt:serverTimestamp()}),console.log("Tiers saved successfully to Firestore"),displayTiers(t,"Commission Tiers Saved"),toast("Commission tiers saved successfully")}catch(t){console.error("Failed to save commission:",t),toast("Failed to save commission")}},onSnapshot(staffRef,t=>renderAdminList(t,staffListEl,"staff")),onSnapshot(servicesRef,t=>renderAdminList(t,servicesListEl,"services")),onSnapshot(companiesRef,t=>renderAdminList(t,companiesListEl,"companies"));export{startManagerApp,startOverviewListener,startJobsListener,startStaffListener,startActivityListener,generateCashReport,assignJobTo,deleteJobById};