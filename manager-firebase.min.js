import{auth,db,onAuthStateChanged,collection,collectionGroup,addDoc,setDoc,serverTimestamp,onSnapshot,query,where,orderBy,doc,updateDoc,getDocs,getDoc,deleteDoc,Timestamp}from"./firebase-config.js";const loader=document.getElementById("loader"),toastEl=document.getElementById("toast"),pendingCountEl=document.getElementById("pendingCount"),inProgressCountEl=document.getElementById("inProgressCount"),completedCountEl=document.getElementById("completedCount"),revenueSumEl=document.getElementById("revenueSum"),activeStaffEl=document.getElementById("activeStaff"),quickJobsListEl=document.getElementById("quickJobsList"),jobsTableBody=document.querySelector("#jobsTable tbody"),filterStatusSelect=document.getElementById("filterStatus"),searchInput=document.getElementById("searchInput"),refreshJobsBtn=document.getElementById("refreshJobs"),staffGridEl=document.getElementById("staffGrid"),reportsListEl=document.getElementById("reportsList"),cashReportListEl=document.getElementById("cashReportList"),usersListEl=document.getElementById("usersList"),activityLogEl=document.getElementById("activityLog"),dateFilterSelect=document.getElementById("dateFilter"),applyFilterBtn=document.getElementById("applyFilterBtn");let unsubOverview=null,unsubJobs=null,unsubStaff=null,unsubActivity=null;function showLoader(){loader&&(loader.style.display="flex")}function hideLoader(){loader&&(loader.style.display="none")}function toast(t,e=3e3){toastEl?(toastEl.textContent=t,toastEl.classList.add("visible"),setTimeout(()=>toastEl.classList.remove("visible"),e)):console.log("TOAST:",t)}function formatCurrency(t){try{return`Ksh ${Number(t).toLocaleString()}`}catch(e){return`Ksh ${t}`}}function formatDate(t){if(!t)return"—";return(t.toDate?t.toDate():new Date(t)).toLocaleString()}function startOfRange(t){const e=new Date;if("today"===t){const t=new Date(e.getFullYear(),e.getMonth(),e.getDate());return Timestamp.fromDate(t)}if("week"===t){const t=new Date(e);return t.setDate(e.getDate()-7),Timestamp.fromDate(t)}if("month"===t){const t=new Date(e);return t.setMonth(e.getMonth()-1),Timestamp.fromDate(t)}if("3months"===t){const t=new Date(e);return t.setMonth(e.getMonth()-3),Timestamp.fromDate(t)}if("year"===t){const t=new Date(e);return t.setFullYear(e.getFullYear()-1),Timestamp.fromDate(t)}return null}async function startOverviewListener(t="all"){console.log("Starting overview listener for range:",t),unsubOverview&&(console.log("Unsubscribing previous overview listener"),unsubOverview()),showLoader();const e=startOfRange(t);console.log("Range start:",e);try{const t=collectionGroup(db,"jobs"),a=[];e&&a.push(where("createdAt",">=",e));const o=a.length?query(t,...a,orderBy("createdAt","desc")):query(t,orderBy("createdAt","desc")),s=await getDocs(o);console.log("Total jobs found (collection group):",s.size);let n=0,r=0,i=0,l=0;const c=[];if(s.forEach(t=>{const e=t.data(),a=t.ref.path.split("/"),o="corporates"===a[0]?a[1]:null,s=e.status;"pending"===s?n++:"in_progress"===s?r++:"completed"===s&&(i++,l+=Number(e.total||0)),c.push({id:t.id,plate:e.plate||"—",status:s||"pending",total:e.total||0,createdAt:e.createdAt||null,assignedTo:e.assignedTo||null,company:o})}),pendingCountEl&&(pendingCountEl.textContent=n),inProgressCountEl&&(inProgressCountEl.textContent=r),completedCountEl&&(completedCountEl.textContent=i),revenueSumEl&&(revenueSumEl.textContent=formatCurrency(l)),activeStaffEl){const t=new Set(c.filter(t=>t.assignedTo).map(t=>t.assignedTo));activeStaffEl.textContent=t.size||"0"}quickJobsListEl&&(quickJobsListEl.innerHTML=c.sort((t,e)=>e.createdAt?.toMillis()-t.createdAt?.toMillis()).slice(0,8).map(t=>`\n          <div class="quick-card">\n            <div class="quick-header">\n              <span class="quick-plate">${t.plate||"—"}</span>\n              <span class="quick-status ${t.status}">${(t.status||"—").replace("_"," ")}</span>\n            </div>\n            <div class="quick-body">\n              <div class="quick-total">${formatCurrency(t.total)}</div>\n              <div class="quick-time">${t.createdAt?formatDate(t.createdAt):""}</div>\n              <div class="quick-company">${t.company||"Main"}</div>\n            </div>\n          </div>\n        `).join(""))}catch(t){console.error("Overview listener error:",t),toast("Failed to load overview (permissions?)")}finally{hideLoader(),console.log("Overview listener update complete.")}}async function startJobsListener({status:t="all",search:e="",dateRange:a="all"}={}){unsubJobs&&unsubJobs(),showLoader();const o=startOfRange(a);try{const a=collectionGroup(db,"jobs"),s=[];t&&"all"!==t&&s.push(where("status","==",t)),o&&s.push(where("createdAt",">=",o));const n=s.length?query(a,...s,orderBy("createdAt","desc")):query(a,orderBy("createdAt","desc")),r=await getDocs(n);console.log("Jobs found (collection group):",r.size);const i=r.docs.map(t=>{const e=t.ref.path.split("/"),a="corporates"===e[0]?e[1]:null;return{id:t.id,company:a,...t.data()}});renderJobsTable(i.filter(t=>{if(!e)return!0;const a=e.toLowerCase();return t.plate&&t.plate.toLowerCase().includes(a)||t.id&&t.id.toLowerCase().includes(a)||t.company&&t.company.toLowerCase().includes(a)}))}catch(t){console.error("Jobs listener error:",t),toast("Failed to load jobs (permissions?)")}finally{hideLoader()}}function renderJobsTable(t=[]){if(!jobsTableBody)return;if(!t.length)return void(jobsTableBody.innerHTML='<tr><td colspan="8" class="muted">No jobs found</td></tr>');jobsTableBody.innerHTML=t.map(t=>{const e=t.assignedTo||"—",a=t.status?t.status.replace("_"," "):"—",o=formatCurrency(t.total||0),s=(t.createdAt&&formatDate(t.createdAt),t.company||null);return`\n      <tr data-id="${t.id}" data-company="${s||""}">\n        <td>${t.id}</td>\n        <td>${t.plate||"—"}</td>\n        <td>${t.model||"—"}</td>\n        <td>${e}</td>\n        <td>${a}</td>\n        <td>${o}</td>\n        <td>${s||"Main"}</td>\n        <td>\n          ${"pending"===t.status?`<button class="btn small start-btn" data-id="${t.id}" data-company="${s||""}">Start</button>`:""}\n          ${"in_progress"===t.status?`<button class="btn small complete-btn" data-id="${t.id}" data-company="${s||""}">Complete</button>`:""}\n          <button class="btn small details-btn" data-id="${t.id}" data-company="${s||""}">Details</button>\n          <button class="btn small danger delete-btn" data-id="${t.id}" data-company="${s||""}">Delete</button>\n        </td>\n      </tr>\n    `}).join("");const e=(t,e)=>e?doc(db,"corporates",e,"jobs",t):doc(db,"jobs",t);jobsTableBody.querySelectorAll(".start-btn").forEach(t=>t.onclick=async t=>{const a=t.target.dataset.id,o=t.target.dataset.company||null;try{await updateDoc(e(a,o),{status:"in_progress",startedAt:serverTimestamp()}),toast("Job started")}catch(t){console.error(t),toast("Failed to start job")}}),jobsTableBody.querySelectorAll(".complete-btn").forEach(t=>t.onclick=async t=>{const a=t.target.dataset.id,o=t.target.dataset.company||null;try{await updateDoc(e(a,o),{status:"completed",completedAt:serverTimestamp()}),toast("Job marked completed")}catch(t){console.error(t),toast("Failed to complete job")}}),jobsTableBody.querySelectorAll(".delete-btn").forEach(t=>t.onclick=async t=>{const a=t.target.dataset.id,o=t.target.dataset.company||null;if(confirm("Delete this job? This cannot be undone."))try{await deleteDoc(e(a,o)),toast("Job deleted")}catch(t){console.error(t),toast("Failed to delete job")}}),jobsTableBody.querySelectorAll(".details-btn").forEach(t=>t.onclick=t=>{openJobModal(t.target.dataset.id,t.target.dataset.company||null)})}async function openJobModal(t){const e=document.getElementById("jobModal"),a=document.getElementById("modalBody");e.classList.remove("hidden"),a.innerHTML="Loading...";try{const e=await getDoc(doc(db,"jobs",t));if(!e.exists())return void(a.innerHTML="Job not found.");const o=e.data();a.innerHTML=`\n      <div class="modal-row"><strong>Plate:</strong> ${o.plate}</div>\n      <div class="modal-row"><strong>Model:</strong> ${o.model}</div>\n      <div class="modal-row"><strong>Status:</strong> ${o.status.replace("_"," ")}</div>\n      <div class="modal-row"><strong>Total:</strong> ${formatCurrency(o.total)}</div>\n      <div class="modal-row"><strong>Assigned To:</strong> ${o.assignedTo||"—"}</div>\n      <div class="modal-row"><strong>Created:</strong> ${o.createdAt?formatDate(o.createdAt):"—"}</div>\n    `}catch(t){a.innerHTML="Error loading job details.",console.error(t)}}async function startStaffListener(t="month"){"function"==typeof unsubStaff&&unsubStaff(),console.log("Starting staff listener for range:",t);const e=startOfRange(t);console.log("Range start timestamp:",e?.toDate());try{const t=collectionGroup(db,"jobs"),a=[where("status","==","completed")];e&&a.push(where("createdAt",">=",e));const o=query(t,...a,orderBy("createdAt"),orderBy("assignedTo")),s=await getDocs(o);if(console.log("Completed jobs snapshot received:",s.size,"docs"),!s.size)return console.warn("No completed jobs found."),void(staffGridEl.innerHTML='<div class="muted">No staff jobs found</div>');const n={};s.forEach(t=>{const e=t.data(),a=e.assignedTo||"Unassigned";n[a]||(n[a]={totalRevenue:0,totalCars:0}),n[a].totalRevenue+=Number(e.total||0),n[a].totalCars+=1});const r=Object.keys(n).map(t=>{const e=n[t].totalRevenue;return{displayName:t,totalRevenue:e,totalCars:n[t].totalCars,commission:.1*e}});console.log("Staff metrics:",r),renderStaffGrid(r)}catch(t){console.error("Staff listener error:",t),toast("Failed to load staff")}}function renderStaffGrid(t=[]){if(staffGridEl){if(!t.length)return console.warn("renderStaffGrid: No staff to render"),void(staffGridEl.innerHTML='<div class="muted">No staff found</div>');console.log("Rendering staff grid with",t.length,"staff members"),staffGridEl.innerHTML=t.map(t=>`\n    <div class="staff-card">\n      <div class="top">\n        <div class="avatar">${t.displayName?t.displayName[0].toUpperCase():"S"}</div>\n        <div class="info">\n          <div class="name">${t.displayName}</div>\n          <div class="meta">\n            Jobs this month: ${t.totalCars} • \n            Revenue: ${formatCurrency(t.totalRevenue)} • \n            Commission: ${formatCurrency(t.commission)}\n          </div>\n        </div>\n      </div>\n    </div>\n  `).join("")}}function startActivityListener(t="all"){unsubActivity&&unsubActivity();const e=collection(db,"activity"),a=startOfRange(t),o=a?query(e,where("createdAt",">=",a),orderBy("createdAt","desc")):query(e,orderBy("createdAt","desc"));unsubActivity=onSnapshot(o,t=>{activityLogEl&&(t.size?activityLogEl.innerHTML=t.docs.map(t=>{const e=t.data();return`<div class="activity-item">\n        <div class="act-time">${formatDate(e.createdAt)}</div>\n        <div class="act-text">${e.text||e.action||JSON.stringify(e)}</div>\n      </div>`}).join(""):activityLogEl.innerHTML='<div class="muted">No activity</div>')},t=>{console.error("Activity listener err",t),toast("Failed to load activity")})}async function generateCashReport(t="all"){showLoader();try{const e=startOfRange(t),a=collectionGroup(db,"jobs"),o=[where("status","==","completed")];e&&o.push(where("createdAt",">=",e));const s=query(a,...o,orderBy("createdAt","desc")),n=await getDocs(s),r=[];let i=0;return n.forEach(t=>{const e=t.data(),a=t.ref.path.split("/"),o=a[1]&&"corporates"===a[0]?a[1]:null;r.push({id:t.id,plate:e.plate,total:e.total||0,date:e.createdAt||null,assignedTo:e.assignedTo||null,company:o}),i+=Number(e.total||0)}),cashReportListEl&&(cashReportListEl.innerHTML=`\n        <div class="report-summary">\n          <div>Total completed jobs: ${r.length}</div>\n          <div>Total revenue: ${formatCurrency(i)}</div>\n        </div>\n        <div class="report-items">\n          ${r.map(t=>`\n            <div class="report-row">\n              ${formatDate(t.date)} • ${t.plate||"—"} • ${formatCurrency(t.total)} • ${t.assignedTo||"—"} ${t.company?`• ${t.company}`:""}\n            </div>`).join("")}\n        </div>\n      `),hideLoader(),{items:r,total:i}}catch(t){return console.error(t),hideLoader(),toast("Failed to generate cash report"),{items:[],total:0}}}document.getElementById("closeJobModal").onclick=()=>document.getElementById("jobModal").classList.add("hidden"),window.onclick=function(t){const e=document.getElementById("jobModal");t.target===e&&e.classList.add("hidden")},startStaffListener();const staffRef=collection(db,"staff"),servicesRef=collection(db,"services"),companiesRef=collection(db,"companies"),staffListEl=document.getElementById("staffList");document.getElementById("addStaffBtn").onclick=async()=>{const t=document.getElementById("staffFirstName").value.trim(),e=document.getElementById("staffLastName").value.trim();if(!t||!e)return toast("Enter first and last name");try{await addDoc(staffRef,{firstName:t,lastName:e,createdAt:serverTimestamp()}),document.getElementById("staffFirstName").value="",document.getElementById("staffLastName").value="",toast("Staff added")}catch(t){console.error(t),toast("Failed to add staff")}};const servicesListEl=document.getElementById("servicesList");document.getElementById("addServiceBtn").onclick=async()=>{const t=document.getElementById("serviceName").value.trim(),e=parseFloat(document.getElementById("servicePrice").value);if(!t||isNaN(e))return toast("Enter valid service name and price");try{await addDoc(servicesRef,{name:t,price:e,createdAt:serverTimestamp()}),document.getElementById("serviceName").value="",document.getElementById("servicePrice").value="",toast("Service added")}catch(t){console.error(t),toast("Failed to add service")}};const companiesListEl=document.getElementById("companiesList");function renderAdminList(t,e,a){t.size?(e.innerHTML=t.docs.map(t=>{const e=t.data(),o="staff"===a?`${e.firstName} ${e.lastName}`:"services"===a?`${e.name} - Ksh ${e.price}`:e.name;return`\n      <li data-id="${t.id}">\n        <span>${o}</span>\n        <button class="edit-btn">Edit</button>\n        <button class="delete-btn">Delete</button>\n      </li>\n    `}).join(""),e.querySelectorAll(".edit-btn").forEach(e=>{e.onclick=async e=>{const o=e.target.parentElement.dataset.id,s=doc(db,"staff"===a?"staff":"services"===a?"services":"companies",o),n=t.docs.find(t=>t.id===o).data();if("staff"===a){const t=prompt("First Name:",n.firstName),e=prompt("Last Name:",n.lastName);if(!t||!e)return;await updateDoc(s,{firstName:t,lastName:e})}else if("services"===a){const t=prompt("Service Name:",n.name),e=parseFloat(prompt("Price (Ksh):",n.price));if(!t||isNaN(e))return;await updateDoc(s,{name:t,price:e})}else{const t=prompt("Company Name:",n.name);if(!t)return;await updateDoc(s,{name:t})}toast(`${a.charAt(0).toUpperCase()+a.slice(1)} updated`)}}),e.querySelectorAll(".delete-btn").forEach(t=>{t.onclick=async t=>{if(!confirm("Are you sure?"))return;const e=t.target.parentElement.dataset.id,o=doc(db,"staff"===a?"staff":"services"===a?"services":"companies",e);await deleteDoc(o),toast(`${a.charAt(0).toUpperCase()+a.slice(1)} deleted`)}})):e.innerHTML=`<li class="muted">No ${a} found</li>`}async function assignJobTo(t,e){try{await updateDoc(doc(db,"jobs",t),{assignedTo:e,updatedAt:serverTimestamp()}),toast("Assigned")}catch(t){console.error(t),toast("Assign failed")}}async function deleteJobById(t){try{await deleteDoc(doc(db,"jobs",t)),toast("Job deleted")}catch(t){console.error(t),toast("Delete failed")}}function wireUI(){if(applyFilterBtn&&dateFilterSelect&&(applyFilterBtn.onclick=()=>{const t=dateFilterSelect.value||"all";startOverviewListener(t),startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput?searchInput.value:"",dateRange:t}),startStaffListener(t),startActivityListener(t),generateCashReport(t),toast(`Applied filter: ${t}`)}),refreshJobsBtn&&(refreshJobsBtn.onclick=()=>{const t=dateFilterSelect?dateFilterSelect.value:"all";startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput?searchInput.value:"",dateRange:t}),toast("Jobs refreshed")}),filterStatusSelect&&(filterStatusSelect.onchange=()=>{const t=dateFilterSelect?dateFilterSelect.value:"all";startJobsListener({status:filterStatusSelect.value,search:searchInput?searchInput.value:"",dateRange:t})}),searchInput){let t;searchInput.oninput=()=>{clearTimeout(t),t=setTimeout(()=>{const t=dateFilterSelect?dateFilterSelect.value:"all";startJobsListener({status:filterStatusSelect?filterStatusSelect.value:"all",search:searchInput.value,dateRange:t})},350)}}window.addEventListener("niapay:openJob",t=>{const{id:e}=t.detail||{};e&&(async()=>{try{const t=query(collection(db,"jobs"),where("__name__","==",e)),a=await getDocs(t);if(a.docs.length){const t=a.docs[0].data(),o={id:e,...t};window.dispatchEvent(new CustomEvent("niapay:jobLoaded",{detail:o}))}else console.warn("Job not found",e)}catch(t){console.error(t)}})()})}function startManagerApp(){wireUI(),onAuthStateChanged(auth,t=>{t?(startOverviewListener("all"),startJobsListener({status:"all",search:"",dateRange:"all"}),startStaffListener("all"),startActivityListener("all"),generateCashReport("all")):console.log("Manager not signed in — redirect to sign page or show login")})}document.getElementById("addCompanyBtn").onclick=async()=>{const t=document.getElementById("companyName").value.trim();if(!t)return toast("Enter company name");try{await addDoc(companiesRef,{name:t,createdAt:serverTimestamp()}),document.getElementById("companyName").value="",toast("Company added")}catch(t){console.error(t),toast("Failed to add company")}},onSnapshot(staffRef,t=>renderAdminList(t,staffListEl,"staff")),onSnapshot(servicesRef,t=>renderAdminList(t,servicesListEl,"services")),onSnapshot(companiesRef,t=>renderAdminList(t,companiesListEl,"companies"));export{startManagerApp,startOverviewListener,startJobsListener,startStaffListener,startActivityListener,generateCashReport,assignJobTo,deleteJobById};