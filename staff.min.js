import{initializeApp}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";import{getAuth,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";import{getFirestore,doc,getDoc,where,collection,getDocs,query,orderBy,updateDoc}from"https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";const firebaseConfig={apiKey:"AIzaSyCT1Zb6b9qBDxa2nrqNu_6cSJ6jCKfq4yY",authDomain:"niapay-carwash.firebaseapp.com",projectId:"niapay-carwash",storageBucket:"niapay-carwash.appspot.com",messagingSenderId:"994223696529",appId:"1:994223696529:web:97e8e7807cc7338878ed30",measurementId:"G-NKDCNQZND5"},app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),staffNameEl=document.getElementById("staffName"),jobsContainer=document.getElementById("jobsContainer"),loader=document.getElementById("loader");let currentStaffName="";async function loadJobs(){loader.classList.remove("hidden");try{const e=query(collection(db,"customer"),orderBy("createdAt","desc")),t=await getDocs(e),o=[];t.forEach(e=>{const t=e.data();"Pending"!==t.status&&"In Progress"!==t.status||o.push({id:e.id,...t})}),renderJobs(o)}catch(e){console.error("Error loading jobs:",e)}finally{loader.classList.add("hidden")}}function renderJobs(e){jobsContainer.innerHTML="",0!==e.length?e.forEach(e=>{if(e.assignedTo&&e.assignedTo.trim().toLowerCase()!==currentStaffName.trim().toLowerCase())return;const t=e.services.map(e=>`<div class="service-item"><span>${e.name}</span><span>Ksh ${e.price}</span></div>`).join(""),o=document.createElement("div");o.classList.add("job-card"),o.innerHTML=`\n      <div class="job-header">\n        <div>\n          <span class="job-plate"><strong>Plate:</strong> ${e.plate}</span><br>\n          <span class="job-uuid"><strong>Job UUID:</strong> ${e.jobUUID}</span>\n        </div>\n        <span class="job-status ${e.status.replace(" ","-")}">${e.status}</span>\n      </div>\n\n      <div class="job-details">\n        <p><strong>Model:</strong> ${e.model}</p>\n        <p><strong>Color:</strong> ${e.color}</p>\n        <p><strong>Phone:</strong> ${e.phone}</p>\n        <p><strong>Payment:</strong> ${e.payment}</p>\n\n        <div class="services">\n          <strong>Services:</strong>\n          ${t}\n        </div>\n\n        <p style="margin-top:0.5rem;"><strong>Total:</strong> Ksh ${e.total}</p>\n        ${e.assignedTo?`<p><strong>Assigned To:</strong> ${e.assignedTo}</p>`:""}\n      </div>\n\n      <button class="take-btn" data-uuid="${e.jobUUID}">\n        ${"Pending"===e.status?"Take Job":"Finish"}\n      </button>\n    `;const s=o.querySelector(".take-btn");s.addEventListener("click",async()=>{const t=s.dataset.uuid;"Pending"===e.status?await takeJob(t,o):"In Progress"===e.status&&await finishJob(t,o)}),jobsContainer.appendChild(o)}):jobsContainer.innerHTML='<p style="text-align:center; color:#777;">No active jobs at the moment.</p>'}async function takeJob(e,t){try{const o=collection(db,"customer"),s=query(o,where("jobUUID","==",e)),n=await getDocs(s);if(n.empty)return void console.error("❌ Job not found:",e);const a=n.docs[0],r=doc(db,"customer",a.id);await updateDoc(r,{status:"In Progress",assignedTo:currentStaffName,startedAt:(new Date).toISOString()});const i=t.querySelector(".job-status");i.textContent="In Progress",i.className="job-status In-Progress";const c=document.createElement("p");c.innerHTML=`<strong>Assigned To:</strong> ${currentStaffName}`,t.querySelector(".job-details").appendChild(c);const d=t.querySelector(".take-btn");d.textContent="Finish",d.onclick=()=>finishJob(e,t),console.log(`✅ Job ${e} assigned to ${currentStaffName}`)}catch(e){console.error("❌ Error taking job:",e)}}async function finishJob(e,t){try{const o=collection(db,"customer"),s=query(o,where("jobUUID","==",e)),n=await getDocs(s);if(n.empty)return void console.error("❌ Job not found:",e);const a=n.docs[0],r=doc(db,"customer",a.id);await updateDoc(r,{status:"Completed",completedAt:(new Date).toISOString()});const i=t.querySelector(".job-status");i.textContent="Completed",i.className="job-status Completed";const c=t.querySelector(".take-btn");c.disabled=!0,c.textContent="Completed ✅",c.style.backgroundColor="#b89360",c.style.cursor="not-allowed",console.log(`✅ Job ${e} marked as Completed`)}catch(e){console.error("❌ Error finishing job:",e)}}onAuthStateChanged(auth,async e=>{if(e){const t=await getDoc(doc(db,"users",e.uid));if(t.exists()){const e=t.data();currentStaffName=e.name,staffNameEl.textContent=`Welcome, ${e.name}`,loadJobs()}else staffNameEl.textContent="Staff Member"}else window.location.href="login.html"});