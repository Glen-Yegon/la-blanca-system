import{auth,db,signInWithEmailAndPassword,signOut,onAuthStateChanged,addDoc,setDoc,collection,getDocs,serverTimestamp,onSnapshot,query,where,orderBy,doc,collectionGroup,updateDoc,deleteDoc}from"./firebase-config.js";const addBtn=document.getElementById("addBtn"),addForm=document.getElementById("addForm"),customerForm=document.getElementById("customerForm"),cancelBtn=document.getElementById("cancelBtn"),services=document.querySelectorAll(".service"),totalEl=document.getElementById("total"),cardsContainer=document.getElementById("cardsContainer"),loader=document.getElementById("loader"),receiptModal=document.getElementById("receiptModal"),closeReceipt=document.getElementById("closeReceipt"),closeReceiptBtn=document.getElementById("closeReceiptBtn"),r_jobid=document.getElementById("r_jobid"),r_plate=document.getElementById("r_plate"),r_model=document.getElementById("r_model"),r_color=document.getElementById("r_color"),r_phone=document.getElementById("r_phone"),r_services=document.getElementById("r_services"),r_assigned=document.getElementById("r_assigned"),r_total=document.getElementById("r_total"),takeJobBtn=document.getElementById("takeJobBtn"),confirmAssignBtn=document.getElementById("confirmAssignBtn"),takeStaffSelect=document.getElementById("takeStaffSelect"),signinModal=document.getElementById("signinModal"),signinForm=document.getElementById("signinForm"),signInEmail=document.getElementById("signInEmail"),signInPassword=document.getElementById("signInPassword"),managerEmail=document.getElementById("managerEmail"),signOutBtn=document.getElementById("signOutBtn"),companyInput=document.getElementById("company");let selectedServices=new Set,currentJobId=null;function updateTotal(){let e=0;selectedServices.forEach(t=>{e+=t.price}),totalEl.textContent=`Kshs ${e}`}async function renderServices(){const e=document.getElementById("servicesGrid");if(e)try{const t=collection(db,"services"),n=await getDocs(t);if(n.empty)return void(e.innerHTML='<div class="muted">No services available</div>');e.innerHTML=n.docs.map(e=>{const t=e.data(),n=t.name||"Unnamed Service",o=t.price||0;return`\n        <button type="button" class="service" data-price="${o}" aria-pressed="false">\n          <div class="service-name">${n}</div>\n          <div class="service-price">Kshs ${o}</div>\n        </button>\n      `}).join("");e.querySelectorAll(".service").forEach(e=>{const t=Number(e.dataset.price),n=e.querySelector(".service-name").textContent.trim();e.addEventListener("click",()=>{const o="true"===e.getAttribute("aria-pressed");e.setAttribute("aria-pressed",!o),o?selectedServices.forEach(e=>{e.name===n&&selectedServices.delete(e)}):selectedServices.add({name:n,price:t}),updateTotal()})});const o=document.createElement("button");o.type="button",o.className="service other-service",o.setAttribute("aria-pressed","false"),o.innerHTML='\n      <div class="service-name">Other Service</div>\n      <div class="service-price">Kshs 0</div>\n    ',e.appendChild(o),o.addEventListener("click",()=>{const e=prompt("Enter the service name:");if(!e)return;const t=prompt("Enter the service price (Kshs):"),n=Number(t);if(isNaN(n)||n<0)return alert("Invalid price");selectedServices.add({name:e,price:n}),o.querySelector(".service-name").textContent=e,o.querySelector(".service-price").textContent=`Kshs ${n}`,o.setAttribute("aria-pressed","true"),updateTotal(),setTimeout(()=>{o.querySelector(".service-name").textContent="Other Service",o.querySelector(".service-price").textContent="Kshs 0",o.setAttribute("aria-pressed","false")},5e3)})}catch(t){console.error("Failed to load services:",t),e.innerHTML='<div class="muted">Failed to load services</div>'}}addBtn.addEventListener("click",()=>{const e="true"===addBtn.getAttribute("aria-expanded");addBtn.setAttribute("aria-expanded",!e),addForm.setAttribute("aria-hidden",e)}),cancelBtn.addEventListener("click",()=>{selectedServices.clear(),customerForm.reset(),services.forEach(e=>e.setAttribute("aria-pressed","false")),updateTotal(),addBtn.setAttribute("aria-expanded",!1),addForm.setAttribute("aria-hidden",!0)}),renderServices();const plateInput=document.getElementById("plate"),modelInput=document.getElementById("model"),descriptionInput=document.getElementById("description");function startJobsListener(){loader.style.display="flex";const e=query(collectionGroup(db,"jobs"),where("company","!=",""),where("status","in",["pending","in_progress"]),orderBy("company"),orderBy("createdAt","desc"));return onSnapshot(e,e=>{const t=document.getElementById("cardsContainer"),n=document.getElementById("inProgressContainer");t.innerHTML="",n.innerHTML="",e.forEach(e=>{const o=e.data(),a=renderJobCard(e.id,o,e.ref);"pending"===o.status?t.appendChild(a):"in_progress"===o.status&&n.appendChild(a)}),loader.style.display="none"})}function renderJobCard(e,t,n){const o=document.createElement("div");o.className="card",o.innerHTML=`\n    <div class="left">\n      <div class="plate">${t.plate}</div>\n      <div class="company-tag">${t.company||"—"}</div>\n    </div>\n    <div class="right">\n      <div class="actions-column">\n        <button class="small-btn primary">\n          ${"pending"===t.status?"Start":"in_progress"===t.status?"Complete":"Completed"}\n        </button>\n        <button class="small-btn ghost">Details</button>\n      </div>\n    </div>\n  `;const a=o.querySelector(".primary");return o.querySelector(".ghost").onclick=()=>openJobModal(e,t,n),a.onclick=async()=>{"pending"===t.status?await updateDoc(n,{status:"in_progress"}):"in_progress"===t.status&&openCustomerFinalizeModal(e,t,n)},o}customerForm.addEventListener("submit",async e=>{e.preventDefault();const t=plateInput.value.trim(),n=modelInput.value.trim(),o=descriptionInput.value.trim(),a=[...selectedServices],r=a.reduce((e,t)=>e+t.price,0),s=companyInput.value;await addDoc(collection(db,"corporates",s,"jobs"),{company:s,plate:t,model:n,description:o,phone:"",services:a,total:r,assignedTo:"",status:"pending",createdAt:serverTimestamp()}),cancelBtn.click()});let currentJobRef=null;function openJobModal(e,t,n){currentJobId=e,currentJobRef=n,r_jobid.textContent=e,r_plate.textContent=t.plate,r_company.textContent=t.company||"—",r_model.textContent=t.model,r_description.textContent=t.description||"—",r_services.innerHTML=t.services.map(e=>`<li>${e.name} — Kshs ${e.price}</li>`).join(""),takeStaffSelect.value=t.assignedTo||"",r_assigned.textContent=t.assignedTo||"—",r_total.textContent=`Kshs ${t.total}`,takeStaffSelect.style.display="block",confirmAssignBtn.style.display="block",takeJobBtn.style.display="pending"===t.status?"block":"none",modalDeleteBtn.style.display="block",modalDeleteBtn.onclick=async()=>{if(confirm("Remove this job permanently?"))try{await deleteDoc(doc(db,"jobs",e)),closeModal()}catch(e){console.error("Failed to delete job:",e),alert("Error deleting job. Please try again.")}},receiptModal.setAttribute("aria-hidden","false")}function closeModal(){currentJobId=null,receiptModal.setAttribute("aria-hidden","true")}function openCustomerFinalizeModal(e,t,n){currentJobId=e,currentJobRef=n,openJobModal(e,t,n);const o=document.getElementById("finishForm");o&&o.remove();r_services.insertAdjacentHTML("afterend",'\n    <form id="finishForm" style="margin-top: 18px; display: flex; flex-direction: column; gap: 12px;">\n      <input id="cust_name" type="text" placeholder="Customer name" required\n        style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px;">\n      <input id="cust_phone" type="tel" placeholder="+2547XXXXXXXX" required\n        style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px;">\n      <button class="btn primary" type="submit" style="padding: 10px; border-radius: 8px; font-weight: 600;">\n        Save & Send Receipt\n      </button>\n    </form>\n  '),document.getElementById("finishForm").onsubmit=async n=>{n.preventDefault();const o=cust_name.value.trim();let a=cust_phone.value.replace(/\s+/g,"");await setDoc(doc(db,"customers",e),{jobId:e,customerName:o,phone:a,carPlate:t.plate,services:t.services,total:t.total,createdAt:serverTimestamp()}),await updateDoc(currentJobRef,{status:"completed"});const r=`https://wa.me/${a.replace("+","")}?text=${encodeURIComponent(`NIAPAY RECEIPT\nPlate: ${t.plate}\nServices:\n${t.services.map(e=>e.name+" - "+e.price).join("\n")}\nTotal: Kshs ${t.total}\n\nThank you for choosing NIAPAY Car Wash.`)}`;window.open(r,"_blank"),closeModal()}}async function populateStaffDropdown(){const e=document.getElementById("takeStaffSelect");if(e)try{const t=collection(db,"staff"),n=await getDocs(t);e.innerHTML='<option value="">-- Choose staff --</option>',n.forEach(t=>{const n=t.data(),o=`${n.firstName||""} ${n.lastName||""}`.trim();if(o){const t=document.createElement("option");t.value=o,t.textContent=o,e.appendChild(t)}})}catch(t){console.error("Failed to load staff:",t),e.innerHTML='<option value="">Failed to load staff</option>'}}async function populateCompaniesDropdown(){const e=document.getElementById("company");if(e)try{const t=collection(db,"companies"),n=await getDocs(t);e.innerHTML='<option value="" disabled selected>Select company</option>',n.forEach(t=>{const n=t.data(),o=n.name||n.fullName||t.id;if(o){const t=document.createElement("option");t.value=o,t.textContent=o,e.appendChild(t)}})}catch(t){console.error("Failed to load companies:",t),e.innerHTML='<option value="">Failed to load companies</option>'}}closeReceipt.onclick=closeModal,closeReceiptBtn.onclick=closeModal,takeJobBtn.onclick=async()=>takeStaffSelect.value?currentJobRef?(await updateDoc(currentJobRef,{assignedTo:takeStaffSelect.value,status:"in_progress"}),void closeModal()):alert("Error: job reference missing"):alert("Select staff before taking job"),confirmAssignBtn.onclick=async()=>takeStaffSelect.value?currentJobRef?(await updateDoc(currentJobRef,{assignedTo:takeStaffSelect.value}),r_assigned.textContent=takeStaffSelect.value,void alert("Assigned person updated")):alert("Error: job reference missing"):alert("Select staff"),populateStaffDropdown(),populateCompaniesDropdown(),signinForm.onsubmit=async e=>{e.preventDefault(),await signInWithEmailAndPassword(auth,signInEmail.value,signInPassword.value),signinModal.setAttribute("aria-hidden","true")},signOutBtn.onclick=()=>signOut(auth),onAuthStateChanged(auth,e=>{e?(managerEmail.textContent=e.email,window.unsub||(window.unsub=startJobsListener())):(window.unsub&&window.unsub(),window.location="sign.html")});