/*!
 * finalhandler
 * Copyright(c) 2014-2022 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var debug=require("debug")("finalhandler"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),onFinished=require("on-finished"),parseUrl=require("parseurl"),statuses=require("statuses"),isFinished=onFinished.isFinished;function createHtmlDocument(e){return'<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="utf-8">\n<title>Error</title>\n</head>\n<body>\n<pre>'+escapeHtml(e).replaceAll("\n","<br>").replaceAll("  "," &nbsp;")+"</pre>\n</body>\n</html>\n"}function finalhandler(e,t,r){var n=r||{},s=n.env||process.env.NODE_ENV||"development",o=n.onerror;return function(r){var n,a,u;if(r||!t.headersSent){if(r?(void 0===(u=getErrorStatusCode(r))?u=getResponseStatusCode(t):n=getErrorHeaders(r),a=getErrorMessage(r,u,s)):(u=404,a="Cannot "+e.method+" "+encodeUrl(getResourceName(e))),debug("default %s",u),r&&o&&setImmediate(o,r,e,t),t.headersSent)return debug("cannot %d after headers sent",u),void(e.socket&&e.socket.destroy());send(e,t,u,n,a)}else debug("cannot 404 after headers sent")}}function getErrorHeaders(e){if(e.headers&&"object"==typeof e.headers)return{...e.headers}}function getErrorMessage(e,t,r){var n;return"production"!==r&&((n=e.stack)||"function"!=typeof e.toString||(n=e.toString())),n||statuses.message[t]}function getErrorStatusCode(e){return"number"==typeof e.status&&e.status>=400&&e.status<600?e.status:"number"==typeof e.statusCode&&e.statusCode>=400&&e.statusCode<600?e.statusCode:void 0}function getResourceName(e){try{return parseUrl.original(e).pathname}catch(e){return"resource"}}function getResponseStatusCode(e){var t=e.statusCode;return("number"!=typeof t||t<400||t>599)&&(t=500),t}function send(e,t,r,n,s){function o(){var o=createHtmlDocument(s);t.statusCode=r,e.httpVersionMajor<2&&(t.statusMessage=statuses.message[r]),t.removeHeader("Content-Encoding"),t.removeHeader("Content-Language"),t.removeHeader("Content-Range");for(const[e,r]of Object.entries(n??{}))t.setHeader(e,r);t.setHeader("Content-Security-Policy","default-src 'none'"),t.setHeader("X-Content-Type-Options","nosniff"),t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Content-Length",Buffer.byteLength(o,"utf8")),"HEAD"!==e.method?t.end(o,"utf8"):t.end()}isFinished(e)?o():(e.unpipe(),onFinished(e,o),e.resume())}module.exports=finalhandler;