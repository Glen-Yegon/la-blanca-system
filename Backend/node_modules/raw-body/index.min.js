/*!
 * raw-body
 * Copyright(c) 2013-2014 Jonathan Ong
 * Copyright(c) 2014-2022 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var asyncHooks=tryRequireAsyncHooks(),bytes=require("bytes"),createError=require("http-errors"),iconv=require("iconv-lite"),unpipe=require("unpipe");module.exports=getRawBody;var ICONV_ENCODING_MESSAGE_REGEXP=/^Encoding not recognized: /;function getDecoder(e){if(!e)return null;try{return iconv.getDecoder(e)}catch(r){if(!ICONV_ENCODING_MESSAGE_REGEXP.test(r.message))throw r;throw createError(415,"specified encoding unsupported",{encoding:e,type:"encoding.unsupported"})}}function getRawBody(e,r,t){var n=t,o=r||{};if(void 0===e)throw new TypeError("argument stream is required");if("object"!=typeof e||null===e||"function"!=typeof e.on)throw new TypeError("argument stream must be a stream");if(!0!==r&&"string"!=typeof r||(o={encoding:r}),"function"==typeof r&&(n=r,o={}),void 0!==n&&"function"!=typeof n)throw new TypeError("argument callback must be a function");if(!n&&!global.Promise)throw new TypeError("argument callback is required");var i=!0!==o.encoding?o.encoding:"utf-8",a=bytes.parse(o.limit),c=null==o.length||isNaN(o.length)?null:parseInt(o.length,10);return n?readStream(e,i,c,a,wrap(n)):new Promise(function(r,t){readStream(e,i,c,a,function(e,n){if(e)return t(e);r(n)})})}function halt(e){unpipe(e),"function"==typeof e.pause&&e.pause()}function readStream(e,r,t,n,o){var i=!1,a=!0;if(null!==n&&null!==t&&t>n)return d(createError(413,"request entity too large",{expected:t,length:t,limit:n,type:"entity.too.large"}));var c=e._readableState;if(e._decoder||c&&(c.encoding||c.decoder))return d(createError(500,"stream encoding should not be set",{type:"stream.encoding.set"}));if(void 0!==e.readable&&!e.readable)return d(createError(500,"stream is not readable",{type:"stream.not.readable"}));var u,s=0;try{u=getDecoder(r)}catch(e){return d(e)}var l=u?"":[];function d(){for(var r=new Array(arguments.length),t=0;t<r.length;t++)r[t]=arguments[t];function n(){g(),r[0]&&halt(e),o.apply(null,r)}i=!0,a?process.nextTick(n):n()}function p(){i||d(createError(400,"request aborted",{code:"ECONNABORTED",expected:t,length:t,received:s,type:"request.aborted"}))}function f(e){i||(s+=e.length,null!==n&&s>n?d(createError(413,"request entity too large",{limit:n,received:s,type:"entity.too.large"})):u?l+=u.write(e):l.push(e))}function y(e){if(!i){if(e)return d(e);if(null!==t&&s!==t)d(createError(400,"request size did not match content length",{expected:t,length:t,received:s,type:"request.size.invalid"}));else d(null,u?l+(u.end()||""):Buffer.concat(l))}}function g(){l=null,e.removeListener("aborted",p),e.removeListener("data",f),e.removeListener("end",y),e.removeListener("error",y),e.removeListener("close",g)}e.on("aborted",p),e.on("close",g),e.on("data",f),e.on("end",y),e.on("error",y),a=!1}function tryRequireAsyncHooks(){try{return require("async_hooks")}catch(e){return{}}}function wrap(e){var r;return asyncHooks.AsyncResource&&(r=new asyncHooks.AsyncResource(e.name||"bound-anonymous-fn")),r&&r.runInAsyncScope?r.runInAsyncScope.bind(r,e,null):e}