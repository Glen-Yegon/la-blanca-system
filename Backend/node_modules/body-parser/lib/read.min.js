/*!
 * body-parser
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var createError=require("http-errors"),getBody=require("raw-body"),iconv=require("iconv-lite"),onFinished=require("on-finished"),zlib=require("node:zlib"),hasBody=require("type-is").hasBody,{getCharset:getCharset}=require("./utils");function read(e,r,t,n,o,i){if(onFinished.isFinished(e))return o("body already parsed"),void t();if("body"in e||(e.body=void 0),!hasBody(e))return o("skip empty body"),void t();if(o("content-type %j",e.headers["content-type"]),!i.shouldParse(e))return o("skip parsing"),void t();var d,s=null;if(!0!==i?.skipCharset&&(s=getCharset(e)||i.defaultCharset,i?.isValidCharset&&!i.isValidCharset(s)))return o("invalid charset"),void t(createError(415,'unsupported charset "'+s.toUpperCase()+'"',{charset:s,type:"charset.unsupported"}));var a,c=i,u=c.verify;try{d=(a=contentstream(e,o,c.inflate)).length,a.length=void 0}catch(e){return t(e)}if(c.length=d,c.encoding=u?null:s,null===c.encoding&&null!==s&&!iconv.encodingExists(s))return t(createError(415,'unsupported charset "'+s.toUpperCase()+'"',{charset:s.toLowerCase(),type:"charset.unsupported"}));o("read body"),getBody(a,c,function(i,d){var c;if(i)return c="encoding.unsupported"===i.type?createError(415,'unsupported charset "'+s.toUpperCase()+'"',{charset:s.toLowerCase(),type:"charset.unsupported"}):createError(400,i),a!==e&&(e.unpipe(),a.destroy()),void dump(e,function(){t(createError(400,c))});if(u)try{o("verify body"),u(e,r,d,s)}catch(e){return void t(createError(403,e,{body:d,type:e.type||"entity.verify.failed"}))}var p=d;try{o("parse body"),p="string"!=typeof d&&null!==s?iconv.decode(d,s):d,e.body=n(p,s)}catch(e){return void t(createError(400,e,{body:p,type:e.type||"entity.parse.failed"}))}t()})}function contentstream(e,r,t){var n=(e.headers["content-encoding"]||"identity").toLowerCase(),o=e.headers["content-length"];if(r('content-encoding "%s"',n),!1===t&&"identity"!==n)throw createError(415,"content encoding unsupported",{encoding:n,type:"encoding.unsupported"});if("identity"===n)return e.length=o,e;var i=createDecompressionStream(n,r);return e.pipe(i),i}function createDecompressionStream(e,r){switch(e){case"deflate":return r("inflate body"),zlib.createInflate();case"gzip":return r("gunzip body"),zlib.createGunzip();case"br":return r("brotli decompress body"),zlib.createBrotliDecompress();default:throw createError(415,'unsupported content encoding "'+e+'"',{encoding:e,type:"encoding.unsupported"})}}function dump(e,r){onFinished.isFinished(e)?r(null):(onFinished(e,r),e.resume())}module.exports=read;