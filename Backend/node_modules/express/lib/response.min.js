/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var contentDisposition=require("content-disposition"),createError=require("http-errors"),deprecate=require("depd")("express"),encodeUrl=require("encodeurl"),escapeHtml=require("escape-html"),http=require("node:http"),onFinished=require("on-finished"),mime=require("mime-types"),path=require("node:path"),pathIsAbsolute=require("node:path").isAbsolute,statuses=require("statuses"),sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,setCharset=require("./utils").setCharset,cookie=require("cookie"),send=require("send"),extname=path.extname,resolve=path.resolve,vary=require("vary");const{Buffer:Buffer}=require("node:buffer");var res=Object.create(http.ServerResponse.prototype);function sendfile(e,t,r,n){var s,i=!1;function o(){if(!i){i=!0;var e=new Error("Request aborted");e.code="ECONNABORTED",n(e)}}function a(e){i||(i=!0,n(e))}t.on("directory",function(){if(!i){i=!0;var e=new Error("EISDIR, read");e.code="EISDIR",n(e)}}),t.on("end",function(){i||(i=!0,n())}),t.on("error",a),t.on("file",function(){s=!1}),t.on("stream",function(){s=!0}),onFinished(e,function(e){return e&&"ECONNRESET"===e.code?o():e?a(e):void(i||setImmediate(function(){!1===s||i?i||(i=!0,n()):o()}))}),r.headers&&t.on("headers",function(e){for(var t=r.headers,n=Object.keys(t),s=0;s<n.length;s++){var i=n[s];e.setHeader(i,t[i])}}),t.pipe(e)}function stringify(e,t,r,n){var s=t||r?JSON.stringify(e,t,r):JSON.stringify(e);return n&&"string"==typeof s&&(s=s.replace(/[<>&]/g,function(e){switch(e.charCodeAt(0)){case 60:return"\\u003c";case 62:return"\\u003e";case 38:return"\\u0026";default:return e}})),s}module.exports=res,res.status=function(e){if(!Number.isInteger(e))throw new TypeError(`Invalid status code: ${JSON.stringify(e)}. Status code must be an integer.`);if(e<100||e>999)throw new RangeError(`Invalid status code: ${JSON.stringify(e)}. Status code must be greater than 99 and less than 1000.`);return this.statusCode=e,this},res.links=function(e){var t=this.get("Link")||"";return t&&(t+=", "),this.set("Link",t+Object.keys(e).map(function(t){return Array.isArray(e[t])?e[t].map(function(e){return`<${e}>; rel="${t}"`}).join(", "):`<${e[t]}>; rel="${t}"`}).join(", "))},res.send=function(e){var t,r,n=e,s=this.req,i=this.app;switch(typeof n){case"string":this.get("Content-Type")||this.type("html");break;case"boolean":case"number":case"object":if(null===n)n="";else{if(!ArrayBuffer.isView(n))return this.json(n);this.get("Content-Type")||this.type("bin")}}"string"==typeof n&&(t="utf8","string"==typeof(r=this.get("Content-Type"))&&this.set("Content-Type",setCharset(r,"utf-8")));var o,a,u=i.get("etag fn"),c=!this.get("ETag")&&"function"==typeof u;return void 0!==n&&(Buffer.isBuffer(n)?o=n.length:!c&&n.length<1e3?o=Buffer.byteLength(n,t):(n=Buffer.from(n,t),t=void 0,o=n.length),this.set("Content-Length",o)),c&&void 0!==o&&(a=u(n,t))&&this.set("ETag",a),s.fresh&&this.status(304),204!==this.statusCode&&304!==this.statusCode||(this.removeHeader("Content-Type"),this.removeHeader("Content-Length"),this.removeHeader("Transfer-Encoding"),n=""),205===this.statusCode&&(this.set("Content-Length","0"),this.removeHeader("Transfer-Encoding"),n=""),"HEAD"===s.method?this.end():this.end(n,t),this},res.json=function(e){var t=this.app,r=t.get("json escape"),n=stringify(e,t.get("json replacer"),t.get("json spaces"),r);return this.get("Content-Type")||this.set("Content-Type","application/json"),this.send(n)},res.jsonp=function(e){var t=this.app,r=t.get("json escape"),n=stringify(e,t.get("json replacer"),t.get("json spaces"),r),s=this.req.query[t.get("jsonp callback name")];return this.get("Content-Type")||(this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","application/json")),Array.isArray(s)&&(s=s[0]),"string"==typeof s&&0!==s.length&&(this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","text/javascript"),s=s.replace(/[^\[\]\w$.]/g,""),void 0===n?n="":"string"==typeof n&&(n=n.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")),n="/**/ typeof "+s+" === 'function' && "+s+"("+n+");"),this.send(n)},res.sendStatus=function(e){var t=statuses.message[e]||String(e);return this.status(e),this.type("txt"),this.send(t)},res.sendFile=function(e,t,r){var n=r,s=this.req,i=s.next,o=t||{};if(!e)throw new TypeError("path argument is required to res.sendFile");if("string"!=typeof e)throw new TypeError("path must be a string to res.sendFile");if("function"==typeof t&&(n=t,o={}),!o.root&&!pathIsAbsolute(e))throw new TypeError("path must be absolute or specify root to res.sendFile");var a=encodeURI(e);o.etag=this.app.enabled("etag"),sendfile(this,send(s,a,o),o,function(e){return n?n(e):e&&"EISDIR"===e.code?i():void(e&&"ECONNABORTED"!==e.code&&"write"!==e.syscall&&i(e))})},res.download=function(e,t,r,n){var s=n,i=t,o=r||null;"function"==typeof t?(s=t,i=null,o=null):"function"==typeof r&&(s=r,o=null),"object"!=typeof t||"function"!=typeof r&&void 0!==r||(i=null,o=t);var a={"Content-Disposition":contentDisposition(i||e)};if(o&&o.headers)for(var u=Object.keys(o.headers),c=0;c<u.length;c++){var h=u[c];"content-disposition"!==h.toLowerCase()&&(a[h]=o.headers[h])}(o=Object.create(o)).headers=a;var p=o.root?e:resolve(e);return this.sendFile(p,o,s)},res.contentType=res.type=function(e){var t=-1===e.indexOf("/")?mime.contentType(e)||"application/octet-stream":e;return this.set("Content-Type",t)},res.format=function(e){var t=this.req,r=t.next,n=Object.keys(e).filter(function(e){return"default"!==e}),s=n.length>0&&t.accepts(n);return this.vary("Accept"),s?(this.set("Content-Type",normalizeType(s).value),e[s](t,this,r)):e.default?e.default(t,this,r):r(createError(406,{types:normalizeTypes(n).map(function(e){return e.value})})),this},res.attachment=function(e){return e&&this.type(extname(e)),this.set("Content-Disposition",contentDisposition(e)),this},res.append=function(e,t){var r=this.get(e),n=t;return r&&(n=Array.isArray(r)?r.concat(t):Array.isArray(t)?[r].concat(t):[r,t]),this.set(e,n)},res.set=res.header=function(e,t){if(2===arguments.length){var r=Array.isArray(t)?t.map(String):String(t);if("content-type"===e.toLowerCase()){if(Array.isArray(r))throw new TypeError("Content-Type cannot be set to an Array");r=mime.contentType(r)}this.setHeader(e,r)}else for(var n in e)this.set(n,e[n]);return this},res.get=function(e){return this.getHeader(e)},res.clearCookie=function(e,t){const r={path:"/",...t,expires:new Date(1)};return delete r.maxAge,this.cookie(e,"",r)},res.cookie=function(e,t,r){var n={...r},s=this.req.secret,i=n.signed;if(i&&!s)throw new Error('cookieParser("secret") required for signed cookies');var o="object"==typeof t?"j:"+JSON.stringify(t):String(t);if(i&&(o="s:"+sign(o,s)),null!=n.maxAge){var a=n.maxAge-0;isNaN(a)||(n.expires=new Date(Date.now()+a),n.maxAge=Math.floor(a/1e3))}return null==n.path&&(n.path="/"),this.append("Set-Cookie",cookie.serialize(e,String(o),n)),this},res.location=function(e){return this.set("Location",encodeUrl(e))},res.redirect=function(e){var t,r=e,n=302;2===arguments.length&&(n=arguments[0],r=arguments[1]),r||deprecate("Provide a url argument"),"string"!=typeof r&&deprecate("Url must be a string"),"number"!=typeof n&&deprecate("Status must be a number"),r=this.location(r).get("Location"),this.format({text:function(){t=statuses.message[n]+". Redirecting to "+r},html:function(){var e=escapeHtml(r);t="<p>"+statuses.message[n]+". Redirecting to "+e+"</p>"},default:function(){t=""}}),this.status(n),this.set("Content-Length",Buffer.byteLength(t)),"HEAD"===this.req.method?this.end():this.end(t)},res.vary=function(e){return vary(this,e),this},res.render=function(e,t,r){var n=this.req.app,s=r,i=t||{},o=this.req,a=this;"function"==typeof t&&(s=t,i={}),i._locals=a.locals,s=s||function(e,t){if(e)return o.next(e);a.send(t)},n.render(e,i,s)};