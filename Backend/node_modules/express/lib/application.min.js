/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var finalhandler=require("finalhandler"),debug=require("debug")("express:application"),View=require("./view"),http=require("node:http"),methods=require("./utils").methods,compileETag=require("./utils").compileETag,compileQueryParser=require("./utils").compileQueryParser,compileTrust=require("./utils").compileTrust,resolve=require("node:path").resolve,once=require("once"),Router=require("router"),slice=Array.prototype.slice,flatten=Array.prototype.flat,app=exports=module.exports={},trustProxyDefaultSymbol="@@symbol:trust_proxy_default";function logerror(e){"test"!==this.get("env")&&console.error(e.stack||e.toString())}function tryRender(e,t,r){try{e.render(t,r)}catch(e){r(e)}}app.init=function(){var e=null;this.cache=Object.create(null),this.engines=Object.create(null),this.settings=Object.create(null),this.defaultConfiguration(),Object.defineProperty(this,"router",{configurable:!0,enumerable:!0,get:function(){return null===e&&(e=new Router({caseSensitive:this.enabled("case sensitive routing"),strict:this.enabled("strict routing")})),e}})},app.defaultConfiguration=function(){var e=process.env.NODE_ENV||"development";this.enable("x-powered-by"),this.set("etag","weak"),this.set("env",e),this.set("query parser","simple"),this.set("subdomain offset",2),this.set("trust proxy",!1),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!0}),debug("booting in %s mode",e),this.on("mount",function(e){!0===this.settings[trustProxyDefaultSymbol]&&"function"==typeof e.settings["trust proxy fn"]&&(delete this.settings["trust proxy"],delete this.settings["trust proxy fn"]),Object.setPrototypeOf(this.request,e.request),Object.setPrototypeOf(this.response,e.response),Object.setPrototypeOf(this.engines,e.engines),Object.setPrototypeOf(this.settings,e.settings)}),this.locals=Object.create(null),this.mountpath="/",this.locals.settings=this.settings,this.set("view",View),this.set("views",resolve("views")),this.set("jsonp callback name","callback"),"production"===e&&this.enable("view cache")},app.handle=function(e,t,r){var s=r||finalhandler(e,t,{env:this.get("env"),onerror:logerror.bind(this)});this.enabled("x-powered-by")&&t.setHeader("X-Powered-By","Express"),e.res=t,t.req=e,Object.setPrototypeOf(e,this.request),Object.setPrototypeOf(t,this.response),t.locals||(t.locals=Object.create(null)),this.router.handle(e,t,s)},app.use=function(e){var t=0,r="/";if("function"!=typeof e){for(var s=e;Array.isArray(s)&&0!==s.length;)s=s[0];"function"!=typeof s&&(t=1,r=e)}var i=flatten.call(slice.call(arguments,t),1/0);if(0===i.length)throw new TypeError("app.use() requires a middleware function");var n=this.router;return i.forEach(function(e){if(!e||!e.handle||!e.set)return n.use(r,e);debug(".use app under %s",r),e.mountpath=r,e.parent=this,n.use(r,function(t,r,s){var i=t.app;e.handle(t,r,function(e){Object.setPrototypeOf(t,i.request),Object.setPrototypeOf(r,i.response),s(e)})}),e.emit("mount",this)},this),this},app.route=function(e){return this.router.route(e)},app.engine=function(e,t){if("function"!=typeof t)throw new Error("callback function required");var r="."!==e[0]?"."+e:e;return this.engines[r]=t,this},app.param=function(e,t){if(Array.isArray(e)){for(var r=0;r<e.length;r++)this.param(e[r],t);return this}return this.router.param(e,t),this},app.set=function(e,t){if(1===arguments.length)return this.settings[e];switch(debug('set "%s" to %o',e,t),this.settings[e]=t,e){case"etag":this.set("etag fn",compileETag(t));break;case"query parser":this.set("query parser fn",compileQueryParser(t));break;case"trust proxy":this.set("trust proxy fn",compileTrust(t)),Object.defineProperty(this.settings,trustProxyDefaultSymbol,{configurable:!0,value:!1})}return this},app.path=function(){return this.parent?this.parent.path()+this.mountpath:""},app.enabled=function(e){return Boolean(this.set(e))},app.disabled=function(e){return!this.set(e)},app.enable=function(e){return this.set(e,!0)},app.disable=function(e){return this.set(e,!1)},methods.forEach(function(e){app[e]=function(t){if("get"===e&&1===arguments.length)return this.set(t);var r=this.route(t);return r[e].apply(r,slice.call(arguments,1)),this}}),app.all=function(e){for(var t=this.route(e),r=slice.call(arguments,1),s=0;s<methods.length;s++)t[methods[s]].apply(t,r);return this},app.render=function(e,t,r){var s,i=this.cache,n=r,o=this.engines,a=t;"function"==typeof t&&(n=t,a={});var u={...this.locals,...a._locals,...a};if(null==u.cache&&(u.cache=this.enabled("view cache")),u.cache&&(s=i[e]),!s){if(!(s=new(this.get("view"))(e,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:o})).path){var l=Array.isArray(s.root)&&s.root.length>1?'directories "'+s.root.slice(0,-1).join('", "')+'" or "'+s.root[s.root.length-1]+'"':'directory "'+s.root+'"',c=new Error('Failed to lookup view "'+e+'" in views '+l);return c.view=s,n(c)}u.cache&&(i[e]=s)}tryRender(s,u,n)},app.listen=function(){var e=http.createServer(this),t=slice.call(arguments);if("function"==typeof t[t.length-1]){var r=t[t.length-1]=once(t[t.length-1]);e.once("error",r)}return e.listen.apply(e,t)};