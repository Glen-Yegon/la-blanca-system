/*!
 * on-finished
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=onFinished,module.exports.isFinished=isFinished;var asyncHooks=tryRequireAsyncHooks(),first=require("ee-first"),defer="function"==typeof setImmediate?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};function onFinished(e,n){return!1!==isFinished(e)?(defer(n,null,e),e):(attachListener(e,wrap(n)),e)}function isFinished(e){var n=e.socket;return"boolean"==typeof e.finished?Boolean(e.finished||n&&!n.writable):"boolean"==typeof e.complete?Boolean(e.upgrade||!n||!n.readable||e.complete&&!e.readable):void 0}function attachFinishedListener(e,n){var i,o,t=!1;function s(e){i.cancel(),o.cancel(),t=!0,n(e)}function r(n){e.removeListener("socket",r),t||i===o&&(o=first([[n,"error","close"]],s))}i=o=first([[e,"end","finish"]],s),e.socket?r(e.socket):(e.on("socket",r),void 0===e.socket&&patchAssignSocket(e,r))}function attachListener(e,n){var i=e.__onFinished;i&&i.queue||(i=e.__onFinished=createListener(e),attachFinishedListener(e,i)),i.queue.push(n)}function createListener(e){function n(i){if(e.__onFinished===n&&(e.__onFinished=null),n.queue){var o=n.queue;n.queue=null;for(var t=0;t<o.length;t++)o[t](i,e)}}return n.queue=[],n}function patchAssignSocket(e,n){var i=e.assignSocket;"function"==typeof i&&(e.assignSocket=function(e){i.call(this,e),n(e)})}function tryRequireAsyncHooks(){try{return require("async_hooks")}catch(e){return{}}}function wrap(e){var n;return asyncHooks.AsyncResource&&(n=new asyncHooks.AsyncResource(e.name||"bound-anonymous-fn")),n&&n.runInAsyncScope?n.runInAsyncScope.bind(n,e,null):e}