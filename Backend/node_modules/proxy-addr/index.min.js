/*!
 * proxy-addr
 * Copyright(c) 2014-2016 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=proxyaddr,module.exports.all=alladdrs,module.exports.compile=compile;var forwarded=require("forwarded"),ipaddr=require("ipaddr.js"),DIGIT_REGEXP=/^[0-9]+$/,isip=ipaddr.isValid,parseip=ipaddr.parse,IP_RANGES={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};function alladdrs(r,e){var t=forwarded(r);if(!e)return t;"function"!=typeof e&&(e=compile(e));for(var i=0;i<t.length-1;i++)e(t[i],i)||(t.length=i+1);return t}function compile(r){if(!r)throw new TypeError("argument is required");var e;if("string"==typeof r)e=[r];else{if(!Array.isArray(r))throw new TypeError("unsupported trust argument");e=r.slice()}for(var t=0;t<e.length;t++)r=e[t],Object.prototype.hasOwnProperty.call(IP_RANGES,r)&&(r=IP_RANGES[r],e.splice.apply(e,[t,1].concat(r)),t+=r.length-1);return compileTrust(compileRangeSubnets(e))}function compileRangeSubnets(r){for(var e=new Array(r.length),t=0;t<r.length;t++)e[t]=parseipNotation(r[t]);return e}function compileTrust(r){var e=r.length;return 0===e?trustNone:1===e?trustSingle(r[0]):trustMulti(r)}function parseipNotation(r){var e=r.lastIndexOf("/"),t=-1!==e?r.substring(0,e):r;if(!isip(t))throw new TypeError("invalid IP address: "+t);var i=parseip(t);-1===e&&"ipv6"===i.kind()&&i.isIPv4MappedAddress()&&(i=i.toIPv4Address());var n="ipv6"===i.kind()?128:32,s=-1!==e?r.substring(e+1,r.length):null;if((s=null===s?n:DIGIT_REGEXP.test(s)?parseInt(s,10):"ipv4"===i.kind()&&isip(s)?parseNetmask(s):null)<=0||s>n)throw new TypeError("invalid range on address: "+r);return[i,s]}function parseNetmask(r){var e=parseip(r);return"ipv4"===e.kind()?e.prefixLengthFromSubnetMask():null}function proxyaddr(r,e){if(!r)throw new TypeError("req argument is required");if(!e)throw new TypeError("trust argument is required");var t=alladdrs(r,e);return t[t.length-1]}function trustNone(){return!1}function trustMulti(r){return function(e){if(!isip(e))return!1;for(var t,i=parseip(e),n=i.kind(),s=0;s<r.length;s++){var a=r[s],p=a[0],o=p.kind(),u=a[1],d=i;if(n!==o){if("ipv4"===o&&!i.isIPv4MappedAddress())continue;t||(t="ipv4"===o?i.toIPv4Address():i.toIPv4MappedAddress()),d=t}if(d.match(p,u))return!0}return!1}}function trustSingle(r){var e=r[0],t=e.kind(),i="ipv4"===t,n=r[1];return function(r){if(!isip(r))return!1;var s=parseip(r);if(s.kind()!==t){if(i&&!s.isIPv4MappedAddress())return!1;s=i?s.toIPv4Address():s.toIPv4MappedAddress()}return s.match(e,n)}}