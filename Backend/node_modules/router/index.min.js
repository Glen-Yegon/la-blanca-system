/*!
 * router
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2022 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";const isPromise=require("is-promise"),Layer=require("./lib/layer"),{METHODS:METHODS}=require("node:http"),parseUrl=require("parseurl"),Route=require("./lib/route"),debug=require("debug")("router"),deprecate=require("depd")("router"),slice=Array.prototype.slice,flatten=Array.prototype.flat,methods=METHODS.map(e=>e.toLowerCase());function Router(e){if(!(this instanceof Router))return new Router(e);const t=e||{};function r(e,t,n){r.handle(e,t,n)}return Object.setPrototypeOf(r,this),r.caseSensitive=t.caseSensitive,r.mergeParams=t.mergeParams,r.params={},r.strict=t.strict,r.stack=[],r}function generateOptionsResponder(e,t){return function(r,n){if(n||0===t.length)return r(n);trySendOptionsResponse(e,t,r)}}function getPathname(e){try{return parseUrl(e).pathname}catch(e){return}}function getProtohost(e){if("string"!=typeof e||0===e.length||"/"===e[0])return;const t=e.indexOf("?"),r=-1!==t?t:e.length,n=e.substring(0,r).indexOf("://");return-1!==n?e.substring(0,e.indexOf("/",3+n)):void 0}function matchLayer(e,t){try{return e.match(t)}catch(e){return e}}function mergeParams(e,t){if("object"!=typeof t||!t)return e;const r=Object.assign({},t);if(!(0 in e)||!(0 in t))return Object.assign(r,e);let n=0,o=0;for(;n in e;)n++;for(;o in t;)o++;for(n--;n>=0;n--)e[n+o]=e[n],n<o&&delete e[n];return Object.assign(r,e)}function processParams(e,t,r,n,o,s){const i=t.keys;if(!i||0===i.length)return s();let u,a,l,c,f=0,p=0;function h(t){return t?s(t):f>=i.length?s():(p=0,u=i[f++],a=n.params[u],l=e[u],c=r[u],void 0!==a&&l?c&&(c.match===a||c.error&&"route"!==c.error)?(n.params[u]=c.value,h(c.error)):(r[u]=c={error:null,match:a,value:a},void m()):h())}function m(e){const t=l[p++];if(c.value=n.params[u],e)return c.error=e,void h(e);if(!t)return h();try{const e=t(n,o,m,a,u);isPromise(e)&&(e instanceof Promise||deprecate("parameters that are Promise-like are deprecated, use a native Promise instead"),e.then(null,function(e){m(e||new Error("Rejected promise"))}))}catch(e){m(e)}}h()}function restore(e,t){const r=new Array(arguments.length-2),n=new Array(arguments.length-2);for(let e=0;e<r.length;e++)r[e]=arguments[e+2],n[e]=t[r[e]];return function(){for(let e=0;e<r.length;e++)t[r[e]]=n[e];return e.apply(this,arguments)}}function sendOptionsResponse(e,t){const r=Object.create(null);for(let e=0;e<t.length;e++)r[t[e]]=!0;const n=Object.keys(r).sort().join(", ");e.setHeader("Allow",n),e.setHeader("Content-Length",Buffer.byteLength(n)),e.setHeader("Content-Type","text/plain"),e.setHeader("X-Content-Type-Options","nosniff"),e.end(n)}function trySendOptionsResponse(e,t,r){try{sendOptionsResponse(e,t)}catch(e){r(e)}}function wrap(e,t){return function(){const r=new Array(arguments.length+1);r[0]=e;for(let e=0,t=arguments.length;e<t;e++)r[e+1]=arguments[e];t.apply(this,r)}}module.exports=Router,module.exports.Route=Route,Router.prototype=function(){},Router.prototype.param=function(e,t){if(!e)throw new TypeError("argument name is required");if("string"!=typeof e)throw new TypeError("argument name must be a string");if(!t)throw new TypeError("argument fn is required");if("function"!=typeof t)throw new TypeError("argument fn must be a function");let r=this.params[e];return r||(r=this.params[e]=[]),r.push(t),this},Router.prototype.handle=function(e,t,r){if(!r)throw new TypeError("argument callback is required");debug("dispatching %s %s",e.method,e.url);let n,o=0;const s=getProtohost(e.url)||"";let i="";const u=this;let a=!1,l=0;const c={},f=this.stack,p=e.params,h=e.baseUrl||"";let m=restore(r,e,"baseUrl","next","params");function d(r){let g="route"===r?null:r;if(a&&(e.url=e.url.slice(1),a=!1),0!==i.length&&(e.baseUrl=h,e.url=s+i+e.url.slice(s.length),i=""),"router"===g)return void setImmediate(m,null);if(o>=f.length)return void setImmediate(m,g);if(++l>100)return setImmediate(d,r);const y=getPathname(e);if(null==y)return m(g);let b,w,O;for(;!0!==w&&o<f.length;){if(b=f[o++],w=matchLayer(b,y),O=b.route,"boolean"!=typeof w&&(g=g||w),!0!==w)continue;if(!O)continue;if(g){w=!1;continue}const t=e.method,r=O._handlesMethod(t);!r&&"OPTIONS"===t&&n&&n.push.apply(n,O._methods()),r||"HEAD"===t||(w=!1)}if(!0!==w)return m(g);O&&(e.route=O),e.params=u.mergeParams?mergeParams(b.params,p):b.params;const R=b.path;processParams(u.params,b,c,e,t,function(r){r?d(g||r):O?b.handleRequest(e,t,d):function(r,n,o,u){if(0!==o.length){if(o!==u.substring(0,o.length))return void d(n);const t=u[o.length];if(t&&"/"!==t)return void d(n);debug("trim prefix (%s) from url %s",o,e.url),i=o,e.url=s+e.url.slice(s.length+i.length),s||"/"===e.url[0]||(e.url="/"+e.url,a=!0),e.baseUrl=h+("/"===i[i.length-1]?i.substring(0,i.length-1):i)}debug("%s %s : %s",r.name,o,e.originalUrl),n?r.handleError(n,e,t,d):r.handleRequest(e,t,d)}(b,g,R,y),l=0})}e.next=d,"OPTIONS"===e.method&&(n=[],m=wrap(m,generateOptionsResponder(t,n))),e.baseUrl=h,e.originalUrl=e.originalUrl||e.url,d()},Router.prototype.use=function(e){let t=0,r="/";if("function"!=typeof e){let n=e;for(;Array.isArray(n)&&0!==n.length;)n=n[0];"function"!=typeof n&&(t=1,r=e)}const n=flatten.call(slice.call(arguments,t),1/0);if(0===n.length)throw new TypeError("argument handler is required");for(let e=0;e<n.length;e++){const t=n[e];if("function"!=typeof t)throw new TypeError("argument handler must be a function");debug("use %o %s",r,t.name||"<anonymous>");const o=new Layer(r,{sensitive:this.caseSensitive,strict:!1,end:!1},t);o.route=void 0,this.stack.push(o)}return this},Router.prototype.route=function(e){const t=new Route(e),r=new Layer(e,{sensitive:this.caseSensitive,strict:this.strict,end:!0},function(e,r,n){t.dispatch(e,r,n)});return r.route=t,this.stack.push(r),t},methods.concat("all").forEach(function(e){Router.prototype[e]=function(t){const r=this.route(t);return r[e].apply(r,slice.call(arguments,1)),this}});