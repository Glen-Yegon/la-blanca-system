/*!
 * router
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2022 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";const isPromise=require("is-promise"),pathRegexp=require("path-to-regexp"),debug=require("debug")("router:layer"),deprecate=require("depd")("router"),TRAILING_SLASH_REGEXP=/\/+$/,MATCHING_GROUP_REGEXP=/\((?:\?<(.*?)>)?(?!\?)/g;function Layer(e,t,r){if(!(this instanceof Layer))return new Layer(e,t,r);debug("new %o",e);const n=t||{};function s(e){if(e instanceof RegExp){const t=[];let r,n=0;for(;r=MATCHING_GROUP_REGEXP.exec(e.source);)t.push({name:r[1]||n++,offset:r.index});return function(r){const n=e.exec(r);if(!n)return!1;const s={};for(let e=1;e<n.length;e++){const r=t[e-1].name,a=decodeParam(n[e]);void 0!==a&&(s[r]=a)}return{params:s,path:n[0]}}}return pathRegexp.match(n.strict?e:loosen(e),{sensitive:n.sensitive,end:n.end,trailing:!n.strict,decode:decodeParam})}this.handle=r,this.keys=[],this.name=r.name||"<anonymous>",this.params=void 0,this.path=void 0,this.slash="/"===e&&!1===n.end,this.matchers=Array.isArray(e)?e.map(s):[s(e)]}function decodeParam(e){if("string"!=typeof e||0===e.length)return e;try{return decodeURIComponent(e)}catch(t){throw t instanceof URIError&&(t.message="Failed to decode param '"+e+"'",t.status=400),t}}function loosen(e){return e instanceof RegExp||"/"===e?e:Array.isArray(e)?e.map(function(e){return loosen(e)}):String(e).replace(TRAILING_SLASH_REGEXP,"")}module.exports=Layer,Layer.prototype.handleError=function(e,t,r,n){const s=this.handle;if(4!==s.length)return n(e);try{const a=s(e,t,r,n);isPromise(a)&&(a instanceof Promise||deprecate("handlers that are Promise-like are deprecated, use a native Promise instead"),a.then(null,function(e){n(e||new Error("Rejected promise"))}))}catch(e){n(e)}},Layer.prototype.handleRequest=function(e,t,r){const n=this.handle;if(n.length>3)return r();try{const s=n(e,t,r);isPromise(s)&&(s instanceof Promise||deprecate("handlers that are Promise-like are deprecated, use a native Promise instead"),s.then(null,function(e){r(e||new Error("Rejected promise"))}))}catch(e){r(e)}},Layer.prototype.match=function(e){let t;if(null!=e){if(this.slash)return this.params={},this.path="",!0;let r=0;for(;!t&&r<this.matchers.length;)t=this.matchers[r](e),r++}return t?(this.params=t.params,this.path=t.path,this.keys=Object.keys(t.params),!0):(this.params=void 0,this.path=void 0,!1)};