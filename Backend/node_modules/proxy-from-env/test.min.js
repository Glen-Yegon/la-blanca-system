"use strict";var assert=require("assert"),parseUrl=require("url").parse,getProxyForUrl=require("./").getProxyForUrl;function runWithEnv(t,r){var p=process.env;process.env=t;try{r()}finally{process.env=p}}function testProxyUrl(t,r,p){assert("object"==typeof t&&null!==t),t=JSON.parse(JSON.stringify(t));var e="getProxyForUrl("+JSON.stringify(p)+") === "+JSON.stringify(r),o={};Error.captureStackTrace(o,testProxyUrl),o=o.stack.split("\n",2)[1],it(e,function(){var e;if(runWithEnv(t,function(){e=getProxyForUrl(p)}),r!==e)try{throw assert.strictEqual(r,e),new Error("assert.strictEqual passed. This is impossible!")}catch(t){throw t.stack=t.message+o,t}})}describe("getProxyForUrl",function(){describe("No proxy variables",function(){var t={};testProxyUrl(t,"","http://example.com"),testProxyUrl(t,"","https://example.com"),testProxyUrl(t,"","ftp://example.com")}),describe("Invalid URLs",function(){var t={ALL_PROXY:"http://unexpected.proxy"};testProxyUrl(t,"","bogus"),testProxyUrl(t,"","//example.com"),testProxyUrl(t,"","://example.com"),testProxyUrl(t,"","://"),testProxyUrl(t,"","/path"),testProxyUrl(t,"",""),testProxyUrl(t,"","http:"),testProxyUrl(t,"","http:/"),testProxyUrl(t,"","http://"),testProxyUrl(t,"","prototype://"),testProxyUrl(t,"","hasOwnProperty://"),testProxyUrl(t,"","__proto__://"),testProxyUrl(t,"",void 0),testProxyUrl(t,"",null),testProxyUrl(t,"",{}),testProxyUrl(t,"",{host:"x",protocol:1}),testProxyUrl(t,"",{host:1,protocol:"x"})}),describe("http_proxy and HTTP_PROXY",function(){var t={HTTP_PROXY:"http://http-proxy"};testProxyUrl(t,"","https://example"),testProxyUrl(t,"http://http-proxy","http://example"),testProxyUrl(t,"http://http-proxy",parseUrl("http://example")),t.http_proxy="http://priority",testProxyUrl(t,"http://priority","http://example")}),describe("http_proxy with non-sensical value",function(){var t={HTTP_PROXY:"Crazy \n!() { ::// }"};testProxyUrl(t,"Crazy \n!() { ::// }","http://wow"),t.HTTP_PROXY="crazy without colon slash slash",testProxyUrl(t,"http://crazy without colon slash slash","http://wow")}),describe("https_proxy and HTTPS_PROXY",function(){var t={HTTP_PROXY:"http://unexpected.proxy"};testProxyUrl(t,"","https://example"),t.HTTPS_PROXY="http://https-proxy",testProxyUrl(t,"http://https-proxy","https://example"),t.https_proxy="http://priority",testProxyUrl(t,"http://priority","https://example")}),describe("ftp_proxy",function(){var t={FTP_PROXY:"http://ftp-proxy"};testProxyUrl(t,"http://ftp-proxy","ftp://example"),testProxyUrl(t,"","ftps://example")}),describe("all_proxy",function(){var t={ALL_PROXY:"http://catch-all"};testProxyUrl(t,"http://catch-all","https://example"),t.all_proxy="http://priority",testProxyUrl(t,"http://priority","https://example")}),describe("all_proxy without scheme",function(){var t={ALL_PROXY:"noscheme"};testProxyUrl(t,"http://noscheme","http://example"),testProxyUrl(t,"https://noscheme","https://example"),testProxyUrl(t,"bogus-scheme://noscheme","bogus-scheme://example"),testProxyUrl(t,"","bogus")}),describe("no_proxy empty",function(){var t={HTTPS_PROXY:"http://proxy",NO_PROXY:""};testProxyUrl(t,"http://proxy","https://example"),t.NO_PROXY=",",testProxyUrl(t,"http://proxy","https://example"),t.NO_PROXY=" ",testProxyUrl(t,"http://proxy","https://example"),t.NO_PROXY=",\t,,,\n,  ,\r",testProxyUrl(t,"http://proxy","https://example")}),describe("no_proxy=example (single host)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"example"};testProxyUrl(t,"","http://example"),testProxyUrl(t,"","http://example:80"),testProxyUrl(t,"","http://example:0"),testProxyUrl(t,"","http://example:1337"),testProxyUrl(t,"http://proxy","http://sub.example"),testProxyUrl(t,"http://proxy","http://prefexample"),testProxyUrl(t,"http://proxy","http://example.no"),testProxyUrl(t,"http://proxy","http://a.b.example"),testProxyUrl(t,"http://proxy","http://host/example")}),describe("no_proxy=sub.example (subdomain)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"sub.example"};testProxyUrl(t,"http://proxy","http://example"),testProxyUrl(t,"http://proxy","http://example:80"),testProxyUrl(t,"http://proxy","http://example:0"),testProxyUrl(t,"http://proxy","http://example:1337"),testProxyUrl(t,"","http://sub.example"),testProxyUrl(t,"http://proxy","http://no.sub.example"),testProxyUrl(t,"http://proxy","http://sub-example"),testProxyUrl(t,"http://proxy","http://example.sub")}),describe("no_proxy=example:80 (host + port)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"example:80"};testProxyUrl(t,"","http://example"),testProxyUrl(t,"","http://example:80"),testProxyUrl(t,"","http://example:0"),testProxyUrl(t,"http://proxy","http://example:1337"),testProxyUrl(t,"http://proxy","http://sub.example"),testProxyUrl(t,"http://proxy","http://prefexample"),testProxyUrl(t,"http://proxy","http://example.no"),testProxyUrl(t,"http://proxy","http://a.b.example")}),describe("no_proxy=.example (host suffix)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:".example"};testProxyUrl(t,"http://proxy","http://example"),testProxyUrl(t,"http://proxy","http://example:80"),testProxyUrl(t,"http://proxy","http://example:1337"),testProxyUrl(t,"","http://sub.example"),testProxyUrl(t,"","http://sub.example:80"),testProxyUrl(t,"","http://sub.example:1337"),testProxyUrl(t,"http://proxy","http://prefexample"),testProxyUrl(t,"http://proxy","http://example.no"),testProxyUrl(t,"","http://a.b.example")}),describe("no_proxy=*",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"*"};testProxyUrl(t,"","http://example.com")}),describe("no_proxy=*.example (host suffix with *.)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"*.example"};testProxyUrl(t,"http://proxy","http://example"),testProxyUrl(t,"http://proxy","http://example:80"),testProxyUrl(t,"http://proxy","http://example:1337"),testProxyUrl(t,"","http://sub.example"),testProxyUrl(t,"","http://sub.example:80"),testProxyUrl(t,"","http://sub.example:1337"),testProxyUrl(t,"http://proxy","http://prefexample"),testProxyUrl(t,"http://proxy","http://example.no"),testProxyUrl(t,"","http://a.b.example")}),describe("no_proxy=*example (substring suffix)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"*example"};testProxyUrl(t,"","http://example"),testProxyUrl(t,"","http://example:80"),testProxyUrl(t,"","http://example:1337"),testProxyUrl(t,"","http://sub.example"),testProxyUrl(t,"","http://sub.example:80"),testProxyUrl(t,"","http://sub.example:1337"),testProxyUrl(t,"","http://prefexample"),testProxyUrl(t,"","http://a.b.example"),testProxyUrl(t,"http://proxy","http://example.no"),testProxyUrl(t,"http://proxy","http://host/example")}),describe("no_proxy=.*example (arbitrary wildcards are NOT supported)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:".*example"};testProxyUrl(t,"http://proxy","http://example"),testProxyUrl(t,"http://proxy","http://sub.example"),testProxyUrl(t,"http://proxy","http://sub.example"),testProxyUrl(t,"http://proxy","http://prefexample"),testProxyUrl(t,"http://proxy","http://x.prefexample"),testProxyUrl(t,"http://proxy","http://a.b.example")}),describe("no_proxy=[::1],[::2]:80,10.0.0.1,10.0.0.2:80 (IP addresses)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"[::1],[::2]:80,10.0.0.1,10.0.0.2:80"};testProxyUrl(t,"","http://[::1]/"),testProxyUrl(t,"","http://[::1]:80/"),testProxyUrl(t,"","http://[::1]:1337/"),testProxyUrl(t,"","http://[::2]/"),testProxyUrl(t,"","http://[::2]:80/"),testProxyUrl(t,"http://proxy","http://[::2]:1337/"),testProxyUrl(t,"","http://10.0.0.1/"),testProxyUrl(t,"","http://10.0.0.1:80/"),testProxyUrl(t,"","http://10.0.0.1:1337/"),testProxyUrl(t,"","http://10.0.0.2/"),testProxyUrl(t,"","http://10.0.0.2:80/"),testProxyUrl(t,"http://proxy","http://10.0.0.2:1337/")}),describe("no_proxy=127.0.0.1/32 (CIDR is NOT supported)",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"127.0.0.1/32"};testProxyUrl(t,"http://proxy","http://127.0.0.1"),testProxyUrl(t,"http://proxy","http://127.0.0.1/32")}),describe("no_proxy=127.0.0.1 does NOT match localhost",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"127.0.0.1"};testProxyUrl(t,"","http://127.0.0.1"),testProxyUrl(t,"http://proxy","http://localhost")}),describe("no_proxy with protocols that have a default port",function(){var t={WS_PROXY:"http://ws",WSS_PROXY:"http://wss",HTTP_PROXY:"http://http",HTTPS_PROXY:"http://https",GOPHER_PROXY:"http://gopher",FTP_PROXY:"http://ftp",ALL_PROXY:"http://all",NO_PROXY:"xxx:21,xxx:70,xxx:80,xxx:443"};testProxyUrl(t,"","http://xxx"),testProxyUrl(t,"","http://xxx:80"),testProxyUrl(t,"http://http","http://xxx:1337"),testProxyUrl(t,"","ws://xxx"),testProxyUrl(t,"","ws://xxx:80"),testProxyUrl(t,"http://ws","ws://xxx:1337"),testProxyUrl(t,"","https://xxx"),testProxyUrl(t,"","https://xxx:443"),testProxyUrl(t,"http://https","https://xxx:1337"),testProxyUrl(t,"","wss://xxx"),testProxyUrl(t,"","wss://xxx:443"),testProxyUrl(t,"http://wss","wss://xxx:1337"),testProxyUrl(t,"","gopher://xxx"),testProxyUrl(t,"","gopher://xxx:70"),testProxyUrl(t,"http://gopher","gopher://xxx:1337"),testProxyUrl(t,"","ftp://xxx"),testProxyUrl(t,"","ftp://xxx:21"),testProxyUrl(t,"http://ftp","ftp://xxx:1337")}),describe("no_proxy should not be case-sensitive",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"XXX,YYY,ZzZ"};testProxyUrl(t,"","http://xxx"),testProxyUrl(t,"","http://XXX"),testProxyUrl(t,"","http://yyy"),testProxyUrl(t,"","http://YYY"),testProxyUrl(t,"","http://ZzZ"),testProxyUrl(t,"","http://zZz")}),describe("NPM proxy configuration",function(){describe("npm_config_http_proxy should work",function(){var t={npm_config_http_proxy:"http://http-proxy"};testProxyUrl(t,"","https://example"),testProxyUrl(t,"http://http-proxy","http://example"),t.npm_config_http_proxy="http://priority",testProxyUrl(t,"http://priority","http://example")}),describe("npm_config_http_proxy should take precedence over HTTP_PROXY and npm_config_proxy",function(){var t={npm_config_http_proxy:"http://http-proxy",npm_config_proxy:"http://unexpected-proxy",HTTP_PROXY:"http://unexpected-proxy"};testProxyUrl(t,"http://http-proxy","http://example")}),describe("npm_config_https_proxy should work",function(){var t={npm_config_http_proxy:"http://unexpected.proxy"};testProxyUrl(t,"","https://example"),t.npm_config_https_proxy="http://https-proxy",testProxyUrl(t,"http://https-proxy","https://example"),t.npm_config_https_proxy="http://priority",testProxyUrl(t,"http://priority","https://example")}),describe("npm_config_https_proxy should take precedence over HTTPS_PROXY and npm_config_proxy",function(){var t={npm_config_https_proxy:"http://https-proxy",npm_config_proxy:"http://unexpected-proxy",HTTPS_PROXY:"http://unexpected-proxy"};testProxyUrl(t,"http://https-proxy","https://example")}),describe("npm_config_proxy should work",function(){var t={npm_config_proxy:"http://http-proxy"};testProxyUrl(t,"http://http-proxy","http://example"),testProxyUrl(t,"http://http-proxy","https://example"),t.npm_config_proxy="http://priority",testProxyUrl(t,"http://priority","http://example"),testProxyUrl(t,"http://priority","https://example")}),describe("HTTP_PROXY and HTTPS_PROXY should take precedence over npm_config_proxy",function(){var t={HTTP_PROXY:"http://http-proxy",HTTPS_PROXY:"http://https-proxy",npm_config_proxy:"http://unexpected-proxy"};testProxyUrl(t,"http://http-proxy","http://example"),testProxyUrl(t,"http://https-proxy","https://example")}),describe("npm_config_no_proxy should work",function(){var t={HTTP_PROXY:"http://proxy",npm_config_no_proxy:"example"};testProxyUrl(t,"","http://example"),testProxyUrl(t,"http://proxy","http://otherwebsite")}),describe("npm_config_no_proxy should take precedence over NO_PROXY",function(){var t={HTTP_PROXY:"http://proxy",NO_PROXY:"otherwebsite",npm_config_no_proxy:"example"};testProxyUrl(t,"","http://example"),testProxyUrl(t,"http://proxy","http://otherwebsite")})})});