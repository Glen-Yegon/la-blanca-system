/*!
 * content-disposition
 * Copyright(c) 2014-2017 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";module.exports=contentDisposition,module.exports.parse=parse;var basename=require("path").basename,ENCODE_URL_ATTR_CHAR_REGEXP=/[\x00-\x20"'()*,/:;<=>?@[\\\]{}\x7f]/g,HEX_ESCAPE_REGEXP=/%[0-9A-Fa-f]{2}/,HEX_ESCAPE_REPLACE_REGEXP=/%([0-9A-Fa-f]{2})/g,NON_LATIN1_REGEXP=/[^\x20-\x7e\xa0-\xff]/g,QESC_REGEXP=/\\([\u0000-\u007f])/g,QUOTE_REGEXP=/([\\"])/g,PARAM_REGEXP=/;[\x09\x20]*([!#$%&'*+.0-9A-Z^_`a-z|~-]+)[\x09\x20]*=[\x09\x20]*("(?:[\x20!\x23-\x5b\x5d-\x7e\x80-\xff]|\\[\x20-\x7e])*"|[!#$%&'*+.0-9A-Z^_`a-z|~-]+)[\x09\x20]*/g,TEXT_REGEXP=/^[\x20-\x7e\x80-\xff]+$/,TOKEN_REGEXP=/^[!#$%&'*+.0-9A-Z^_`a-z|~-]+$/,EXT_VALUE_REGEXP=/^([A-Za-z0-9!#$%&+\-^_`{}~]+)'(?:[A-Za-z]{2,3}(?:-[A-Za-z]{3}){0,3}|[A-Za-z]{4,8}|)'((?:%[0-9A-Fa-f]{2}|[A-Za-z0-9!#$&+.^_`|~-])+)$/,DISPOSITION_TYPE_REGEXP=/^([!#$%&'*+.0-9A-Z^_`a-z|~-]+)[\x09\x20]*(?:$|;)/;function contentDisposition(e,r){var t=r||{};return format(new ContentDisposition(t.type||"attachment",createparams(e,t.fallback)))}function createparams(e,r){if(void 0!==e){var t={};if("string"!=typeof e)throw new TypeError("filename must be a string");if(void 0===r&&(r=!0),"string"!=typeof r&&"boolean"!=typeof r)throw new TypeError("fallback must be a string or boolean");if("string"==typeof r&&NON_LATIN1_REGEXP.test(r))throw new TypeError("fallback must be ISO-8859-1 string");var n=basename(e),a=TEXT_REGEXP.test(n),i="string"!=typeof r?r&&getlatin1(n):basename(r),o="string"==typeof i&&i!==n;return(o||!a||HEX_ESCAPE_REGEXP.test(n))&&(t["filename*"]=n),(a||o)&&(t.filename=o?i:n),t}}function format(e){var r=e.parameters,t=e.type;if(!t||"string"!=typeof t||!TOKEN_REGEXP.test(t))throw new TypeError("invalid type");var n=String(t).toLowerCase();if(r&&"object"==typeof r)for(var a,i=Object.keys(r).sort(),o=0;o<i.length;o++){var E="*"===(a=i[o]).slice(-1)?ustring(r[a]):qstring(r[a]);n+="; "+a+"="+E}return n}function decodefield(e){var r=EXT_VALUE_REGEXP.exec(e);if(!r)throw new TypeError("invalid extended field value");var t,n=r[1].toLowerCase(),a=r[2].replace(HEX_ESCAPE_REPLACE_REGEXP,pdecode);switch(n){case"iso-8859-1":t=getlatin1(a);break;case"utf-8":case"utf8":t=Buffer.from(a,"binary").toString("utf8");break;default:throw new TypeError("unsupported charset in extended field")}return t}function getlatin1(e){return String(e).replace(NON_LATIN1_REGEXP,"?")}function parse(e){if(!e||"string"!=typeof e)throw new TypeError("argument string is required");var r=DISPOSITION_TYPE_REGEXP.exec(e);if(!r)throw new TypeError("invalid type format");var t,n,a=r[0].length,i=r[1].toLowerCase(),o=[],E={};for(a=PARAM_REGEXP.lastIndex=";"===r[0].slice(-1)?a-1:a;r=PARAM_REGEXP.exec(e);){if(r.index!==a)throw new TypeError("invalid parameter format");if(a+=r[0].length,t=r[1].toLowerCase(),n=r[2],-1!==o.indexOf(t))throw new TypeError("invalid duplicate parameter");o.push(t),t.indexOf("*")+1!==t.length?"string"!=typeof E[t]&&('"'===n[0]&&(n=n.slice(1,-1).replace(QESC_REGEXP,"$1")),E[t]=n):(t=t.slice(0,-1),n=decodefield(n),E[t]=n)}if(-1!==a&&a!==e.length)throw new TypeError("invalid parameter format");return new ContentDisposition(i,E)}function pdecode(e,r){return String.fromCharCode(parseInt(r,16))}function pencode(e){return"%"+String(e).charCodeAt(0).toString(16).toUpperCase()}function qstring(e){return'"'+String(e).replace(QUOTE_REGEXP,"\\$1")+'"'}function ustring(e){var r=String(e);return"UTF-8''"+encodeURIComponent(r).replace(ENCODE_URL_ATTR_CHAR_REGEXP,pencode)}function ContentDisposition(e,r){this.type=e,this.parameters=r}