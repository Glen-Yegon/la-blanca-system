"use strict";module.exports=preferredMediaTypes,module.exports.preferredMediaTypes=preferredMediaTypes;var simpleMediaTypeRegExp=/^\s*([^\s\/;]+)\/([^;\s]+)\s*(?:;(.*))?$/;function parseAccept(e){for(var r=splitMediaTypes(e),t=0,i=0;t<r.length;t++){var a=parseMediaType(r[t].trim(),t);a&&(r[i++]=a)}return r.length=i,r}function parseMediaType(e,r){var t=simpleMediaTypeRegExp.exec(e);if(!t)return null;var i=Object.create(null),a=1,n=t[2],s=t[1];if(t[3])for(var p=splitParameters(t[3]).map(splitKeyValuePair),u=0;u<p.length;u++){var o=p[u],l=o[0].toLowerCase(),f=o[1],y=f&&'"'===f[0]&&'"'===f[f.length-1]?f.slice(1,-1):f;if("q"===l){a=parseFloat(y);break}i[l]=y}return{type:s,subtype:n,params:i,q:a,i:r}}function getMediaTypePriority(e,r,t){for(var i={o:-1,q:0,s:0},a=0;a<r.length;a++){var n=specify(e,r[a],t);n&&(i.s-n.s||i.q-n.q||i.o-n.o)<0&&(i=n)}return i}function specify(e,r,t){var i=parseMediaType(e),a=0;if(!i)return null;if(r.type.toLowerCase()==i.type.toLowerCase())a|=4;else if("*"!=r.type)return null;if(r.subtype.toLowerCase()==i.subtype.toLowerCase())a|=2;else if("*"!=r.subtype)return null;var n=Object.keys(r.params);if(n.length>0){if(!n.every(function(e){return"*"==r.params[e]||(r.params[e]||"").toLowerCase()==(i.params[e]||"").toLowerCase()}))return null;a|=1}return{i:t,o:r.i,q:r.q,s:a}}function preferredMediaTypes(e,r){var t=parseAccept(void 0===e?"*/*":e||"");if(!r)return t.filter(isQuality).sort(compareSpecs).map(getFullType);var i=r.map(function(e,r){return getMediaTypePriority(e,t,r)});return i.filter(isQuality).sort(compareSpecs).map(function(e){return r[i.indexOf(e)]})}function compareSpecs(e,r){return r.q-e.q||r.s-e.s||e.o-r.o||e.i-r.i||0}function getFullType(e){return e.type+"/"+e.subtype}function isQuality(e){return e.q>0}function quoteCount(e){for(var r=0,t=0;-1!==(t=e.indexOf('"',t));)r++,t++;return r}function splitKeyValuePair(e){var r,t,i=e.indexOf("=");return-1===i?r=e:(r=e.slice(0,i),t=e.slice(i+1)),[r,t]}function splitMediaTypes(e){for(var r=e.split(","),t=1,i=0;t<r.length;t++)quoteCount(r[i])%2==0?r[++i]=r[t]:r[i]+=","+r[t];return r.length=i+1,r}function splitParameters(e){for(var r=e.split(";"),t=1,i=0;t<r.length;t++)quoteCount(r[i])%2==0?r[++i]=r[t]:r[i]+=";"+r[t];r.length=i+1;for(t=0;t<r.length;t++)r[t]=r[t].trim();return r}