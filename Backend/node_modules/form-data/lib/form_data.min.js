"use strict";var CombinedStream=require("combined-stream"),util=require("util"),path=require("path"),http=require("http"),https=require("https"),parseUrl=require("url").parse,fs=require("fs"),Stream=require("stream").Stream,crypto=require("crypto"),mime=require("mime-types"),asynckit=require("asynckit"),setToStringTag=require("es-set-tostringtag"),hasOwn=require("hasown"),populate=require("./populate.js");function FormData(t){if(!(this instanceof FormData))return new FormData(t);for(var e in this._overheadLength=0,this._valueLength=0,this._valuesToMeasure=[],CombinedStream.call(this),t=t||{})this[e]=t[e]}util.inherits(FormData,CombinedStream),FormData.LINE_BREAK="\r\n",FormData.DEFAULT_CONTENT_TYPE="application/octet-stream",FormData.prototype.append=function(t,e,r){"string"==typeof(r=r||{})&&(r={filename:r});var a=CombinedStream.prototype.append.bind(this);if("number"!=typeof e&&null!=e||(e=String(e)),Array.isArray(e))this._error(new Error("Arrays are not supported."));else{var n=this._multiPartHeader(t,e,r),o=this._multiPartFooter();a(n),a(e),a(o),this._trackLength(n,e,r)}},FormData.prototype._trackLength=function(t,e,r){var a=0;null!=r.knownLength?a+=Number(r.knownLength):Buffer.isBuffer(e)?a=e.length:"string"==typeof e&&(a=Buffer.byteLength(e)),this._valueLength+=a,this._overheadLength+=Buffer.byteLength(t)+FormData.LINE_BREAK.length,e&&(e.path||e.readable&&hasOwn(e,"httpVersion")||e instanceof Stream)&&(r.knownLength||this._valuesToMeasure.push(e))},FormData.prototype._lengthRetriever=function(t,e){hasOwn(t,"fd")?null!=t.end&&t.end!=1/0&&null!=t.start?e(null,t.end+1-(t.start?t.start:0)):fs.stat(t.path,function(r,a){if(r)e(r);else{var n=a.size-(t.start?t.start:0);e(null,n)}}):hasOwn(t,"httpVersion")?e(null,Number(t.headers["content-length"])):hasOwn(t,"httpModule")?(t.on("response",function(r){t.pause(),e(null,Number(r.headers["content-length"]))}),t.resume()):e("Unknown stream")},FormData.prototype._multiPartHeader=function(t,e,r){if("string"==typeof r.header)return r.header;var a,n=this._getContentDisposition(e,r),o=this._getContentType(e,r),s="",i={"Content-Disposition":["form-data",'name="'+t+'"'].concat(n||[]),"Content-Type":[].concat(o||[])};for(var h in"object"==typeof r.header&&populate(i,r.header),i)if(hasOwn(i,h)){if(null==(a=i[h]))continue;Array.isArray(a)||(a=[a]),a.length&&(s+=h+": "+a.join("; ")+FormData.LINE_BREAK)}return"--"+this.getBoundary()+FormData.LINE_BREAK+s+FormData.LINE_BREAK},FormData.prototype._getContentDisposition=function(t,e){var r;if("string"==typeof e.filepath?r=path.normalize(e.filepath).replace(/\\/g,"/"):e.filename||t&&(t.name||t.path)?r=path.basename(e.filename||t&&(t.name||t.path)):t&&t.readable&&hasOwn(t,"httpVersion")&&(r=path.basename(t.client._httpMessage.path||"")),r)return'filename="'+r+'"'},FormData.prototype._getContentType=function(t,e){var r=e.contentType;return!r&&t&&t.name&&(r=mime.lookup(t.name)),!r&&t&&t.path&&(r=mime.lookup(t.path)),!r&&t&&t.readable&&hasOwn(t,"httpVersion")&&(r=t.headers["content-type"]),r||!e.filepath&&!e.filename||(r=mime.lookup(e.filepath||e.filename)),!r&&t&&"object"==typeof t&&(r=FormData.DEFAULT_CONTENT_TYPE),r},FormData.prototype._multiPartFooter=function(){return function(t){var e=FormData.LINE_BREAK;0===this._streams.length&&(e+=this._lastBoundary()),t(e)}.bind(this)},FormData.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"+FormData.LINE_BREAK},FormData.prototype.getHeaders=function(t){var e,r={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(e in t)hasOwn(t,e)&&(r[e.toLowerCase()]=t[e]);return r},FormData.prototype.setBoundary=function(t){if("string"!=typeof t)throw new TypeError("FormData boundary must be a string");this._boundary=t},FormData.prototype.getBoundary=function(){return this._boundary||this._generateBoundary(),this._boundary},FormData.prototype.getBuffer=function(){for(var t=new Buffer.alloc(0),e=this.getBoundary(),r=0,a=this._streams.length;r<a;r++)"function"!=typeof this._streams[r]&&(t=Buffer.isBuffer(this._streams[r])?Buffer.concat([t,this._streams[r]]):Buffer.concat([t,Buffer.from(this._streams[r])]),"string"==typeof this._streams[r]&&this._streams[r].substring(2,e.length+2)===e||(t=Buffer.concat([t,Buffer.from(FormData.LINE_BREAK)])));return Buffer.concat([t,Buffer.from(this._lastBoundary())])},FormData.prototype._generateBoundary=function(){this._boundary="--------------------------"+crypto.randomBytes(12).toString("hex")},FormData.prototype.getLengthSync=function(){var t=this._overheadLength+this._valueLength;return this._streams.length&&(t+=this._lastBoundary().length),this.hasKnownLength()||this._error(new Error("Cannot calculate proper length in synchronous way.")),t},FormData.prototype.hasKnownLength=function(){var t=!0;return this._valuesToMeasure.length&&(t=!1),t},FormData.prototype.getLength=function(t){var e=this._overheadLength+this._valueLength;this._streams.length&&(e+=this._lastBoundary().length),this._valuesToMeasure.length?asynckit.parallel(this._valuesToMeasure,this._lengthRetriever,function(r,a){r?t(r):(a.forEach(function(t){e+=t}),t(null,e))}):process.nextTick(t.bind(this,null,e))},FormData.prototype.submit=function(t,e){var r,a,n={method:"post"};return"string"==typeof t?(t=parseUrl(t),a=populate({port:t.port,path:t.pathname,host:t.hostname,protocol:t.protocol},n)):(a=populate(t,n)).port||(a.port="https:"===a.protocol?443:80),a.headers=this.getHeaders(t.headers),r="https:"===a.protocol?https.request(a):http.request(a),this.getLength(function(t,a){if(t&&"Unknown stream"!==t)this._error(t);else if(a&&r.setHeader("Content-Length",a),this.pipe(r),e){var n,o=function(t,a){return r.removeListener("error",o),r.removeListener("response",n),e.call(this,t,a)};n=o.bind(this,null),r.on("error",o),r.on("response",n)}}.bind(this)),r},FormData.prototype._error=function(t){this.error||(this.error=t,this.pause(),this.emit("error",t))},FormData.prototype.toString=function(){return"[object FormData]"},setToStringTag(FormData.prototype,"FormData"),module.exports=FormData;