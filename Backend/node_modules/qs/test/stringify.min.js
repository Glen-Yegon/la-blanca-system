"use strict";var test=require("tape"),qs=require("../"),utils=require("../lib/utils"),iconv=require("iconv-lite"),SaferBuffer=require("safer-buffer").Buffer,hasSymbols=require("has-symbols"),mockProperty=require("mock-property"),emptyTestCases=require("./empty-keys-cases").emptyTestCases,hasProto=require("has-proto")(),hasBigInt=require("has-bigints")();test("stringify()",function(a){a.test("stringifies a querystring object",function(a){a.equal(qs.stringify({a:"b"}),"a=b"),a.equal(qs.stringify({a:1}),"a=1"),a.equal(qs.stringify({a:1,b:2}),"a=1&b=2"),a.equal(qs.stringify({a:"A_Z"}),"a=A_Z"),a.equal(qs.stringify({a:"â‚¬"}),"a=%E2%82%AC"),a.equal(qs.stringify({a:"î€€"}),"a=%EE%80%80"),a.equal(qs.stringify({a:"×"}),"a=%D7%90"),a.equal(qs.stringify({a:"ð·"}),"a=%F0%90%90%B7"),a.end()}),a.test("stringifies falsy values",function(a){a.equal(qs.stringify(void 0),""),a.equal(qs.stringify(null),""),a.equal(qs.stringify(null,{strictNullHandling:!0}),""),a.equal(qs.stringify(!1),""),a.equal(qs.stringify(0),""),a.end()}),a.test("stringifies symbols",{skip:!hasSymbols()},function(a){a.equal(qs.stringify(Symbol.iterator),""),a.equal(qs.stringify([Symbol.iterator]),"0=Symbol%28Symbol.iterator%29"),a.equal(qs.stringify({a:Symbol.iterator}),"a=Symbol%28Symbol.iterator%29"),a.equal(qs.stringify({a:[Symbol.iterator]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[]=Symbol%28Symbol.iterator%29"),a.end()}),a.test("stringifies bigints",{skip:!hasBigInt},function(a){var e=BigInt(3),t=function(a,e,t){var n=e(a,e,t);return"bigint"==typeof a?n+"n":n};a.equal(qs.stringify(e),""),a.equal(qs.stringify([e]),"0=3"),a.equal(qs.stringify([e],{encoder:t}),"0=3n"),a.equal(qs.stringify({a:e}),"a=3"),a.equal(qs.stringify({a:e},{encoder:t}),"a=3n"),a.equal(qs.stringify({a:[e]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[]=3"),a.equal(qs.stringify({a:[e]},{encodeValuesOnly:!0,encoder:t,arrayFormat:"brackets"}),"a[]=3n"),a.end()}),a.test("encodes dot in key of object when encodeDotInKeys and allowDots is provided",function(a){a.equal(qs.stringify({"name.obj":{first:"John",last:"Doe"}},{allowDots:!1,encodeDotInKeys:!1}),"name.obj%5Bfirst%5D=John&name.obj%5Blast%5D=Doe","with allowDots false and encodeDotInKeys false"),a.equal(qs.stringify({"name.obj":{first:"John",last:"Doe"}},{allowDots:!0,encodeDotInKeys:!1}),"name.obj.first=John&name.obj.last=Doe","with allowDots true and encodeDotInKeys false"),a.equal(qs.stringify({"name.obj":{first:"John",last:"Doe"}},{allowDots:!1,encodeDotInKeys:!0}),"name%252Eobj%5Bfirst%5D=John&name%252Eobj%5Blast%5D=Doe","with allowDots false and encodeDotInKeys true"),a.equal(qs.stringify({"name.obj":{first:"John",last:"Doe"}},{allowDots:!0,encodeDotInKeys:!0}),"name%252Eobj.first=John&name%252Eobj.last=Doe","with allowDots true and encodeDotInKeys true"),a.equal(qs.stringify({"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},{allowDots:!1,encodeDotInKeys:!1}),"name.obj.subobject%5Bfirst.godly.name%5D=John&name.obj.subobject%5Blast%5D=Doe","with allowDots false and encodeDotInKeys false"),a.equal(qs.stringify({"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},{allowDots:!0,encodeDotInKeys:!1}),"name.obj.subobject.first.godly.name=John&name.obj.subobject.last=Doe","with allowDots false and encodeDotInKeys false"),a.equal(qs.stringify({"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},{allowDots:!1,encodeDotInKeys:!0}),"name%252Eobj%252Esubobject%5Bfirst.godly.name%5D=John&name%252Eobj%252Esubobject%5Blast%5D=Doe","with allowDots false and encodeDotInKeys true"),a.equal(qs.stringify({"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},{allowDots:!0,encodeDotInKeys:!0}),"name%252Eobj%252Esubobject.first%252Egodly%252Ename=John&name%252Eobj%252Esubobject.last=Doe","with allowDots true and encodeDotInKeys true"),a.end()}),a.test("should encode dot in key of object, and automatically set allowDots to `true` when encodeDotInKeys is true and allowDots in undefined",function(a){a.equal(qs.stringify({"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},{encodeDotInKeys:!0}),"name%252Eobj%252Esubobject.first%252Egodly%252Ename=John&name%252Eobj%252Esubobject.last=Doe","with allowDots undefined and encodeDotInKeys true"),a.end()}),a.test("should encode dot in key of object when encodeDotInKeys and allowDots is provided, and nothing else when encodeValuesOnly is provided",function(a){a.equal(qs.stringify({"name.obj":{first:"John",last:"Doe"}},{encodeDotInKeys:!0,allowDots:!0,encodeValuesOnly:!0}),"name%2Eobj.first=John&name%2Eobj.last=Doe"),a.equal(qs.stringify({"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},{allowDots:!0,encodeDotInKeys:!0,encodeValuesOnly:!0}),"name%2Eobj%2Esubobject.first%2Egodly%2Ename=John&name%2Eobj%2Esubobject.last=Doe"),a.end()}),a.test("throws when `commaRoundTrip` is not a boolean",function(a){a.throws(function(){qs.stringify({},{commaRoundTrip:"not a boolean"})},TypeError,"throws when `commaRoundTrip` is not a boolean"),a.end()}),a.test("throws when `encodeDotInKeys` is not a boolean",function(a){a.throws(function(){qs.stringify({a:[],b:"zz"},{encodeDotInKeys:"foobar"})},TypeError),a.throws(function(){qs.stringify({a:[],b:"zz"},{encodeDotInKeys:0})},TypeError),a.throws(function(){qs.stringify({a:[],b:"zz"},{encodeDotInKeys:NaN})},TypeError),a.throws(function(){qs.stringify({a:[],b:"zz"},{encodeDotInKeys:null})},TypeError),a.end()}),a.test("adds query prefix",function(a){a.equal(qs.stringify({a:"b"},{addQueryPrefix:!0}),"?a=b"),a.end()}),a.test("with query prefix, outputs blank string given an empty object",function(a){a.equal(qs.stringify({},{addQueryPrefix:!0}),""),a.end()}),a.test("stringifies nested falsy values",function(a){a.equal(qs.stringify({a:{b:{c:null}}}),"a%5Bb%5D%5Bc%5D="),a.equal(qs.stringify({a:{b:{c:null}}},{strictNullHandling:!0}),"a%5Bb%5D%5Bc%5D"),a.equal(qs.stringify({a:{b:{c:!1}}}),"a%5Bb%5D%5Bc%5D=false"),a.end()}),a.test("stringifies a nested object",function(a){a.equal(qs.stringify({a:{b:"c"}}),"a%5Bb%5D=c"),a.equal(qs.stringify({a:{b:{c:{d:"e"}}}}),"a%5Bb%5D%5Bc%5D%5Bd%5D=e"),a.end()}),a.test("`allowDots` option: stringifies a nested object with dots notation",function(a){a.equal(qs.stringify({a:{b:"c"}},{allowDots:!0}),"a.b=c"),a.equal(qs.stringify({a:{b:{c:{d:"e"}}}},{allowDots:!0}),"a.b.c.d=e"),a.end()}),a.test("stringifies an array value",function(a){a.equal(qs.stringify({a:["b","c","d"]},{arrayFormat:"indices"}),"a%5B0%5D=b&a%5B1%5D=c&a%5B2%5D=d","indices => indices"),a.equal(qs.stringify({a:["b","c","d"]},{arrayFormat:"brackets"}),"a%5B%5D=b&a%5B%5D=c&a%5B%5D=d","brackets => brackets"),a.equal(qs.stringify({a:["b","c","d"]},{arrayFormat:"comma"}),"a=b%2Cc%2Cd","comma => comma"),a.equal(qs.stringify({a:["b","c","d"]},{arrayFormat:"comma",commaRoundTrip:!0}),"a=b%2Cc%2Cd","comma round trip => comma"),a.equal(qs.stringify({a:["b","c","d"]}),"a%5B0%5D=b&a%5B1%5D=c&a%5B2%5D=d","default => indices"),a.end()}),a.test("`skipNulls` option",function(a){a.equal(qs.stringify({a:"b",c:null},{skipNulls:!0}),"a=b","omits nulls when asked"),a.equal(qs.stringify({a:{b:"c",d:null}},{skipNulls:!0}),"a%5Bb%5D=c","omits nested nulls when asked"),a.end()}),a.test("omits array indices when asked",function(a){a.equal(qs.stringify({a:["b","c","d"]},{indices:!1}),"a=b&a=c&a=d"),a.end()}),a.test("omits object key/value pair when value is empty array",function(a){a.equal(qs.stringify({a:[],b:"zz"}),"b=zz"),a.end()}),a.test("should not omit object key/value pair when value is empty array and when asked",function(a){a.equal(qs.stringify({a:[],b:"zz"}),"b=zz"),a.equal(qs.stringify({a:[],b:"zz"},{allowEmptyArrays:!1}),"b=zz"),a.equal(qs.stringify({a:[],b:"zz"},{allowEmptyArrays:!0}),"a[]&b=zz"),a.end()}),a.test("should throw when allowEmptyArrays is not of type boolean",function(a){a.throws(function(){qs.stringify({a:[],b:"zz"},{allowEmptyArrays:"foobar"})},TypeError),a.throws(function(){qs.stringify({a:[],b:"zz"},{allowEmptyArrays:0})},TypeError),a.throws(function(){qs.stringify({a:[],b:"zz"},{allowEmptyArrays:NaN})},TypeError),a.throws(function(){qs.stringify({a:[],b:"zz"},{allowEmptyArrays:null})},TypeError),a.end()}),a.test("allowEmptyArrays + strictNullHandling",function(a){a.equal(qs.stringify({testEmptyArray:[]},{strictNullHandling:!0,allowEmptyArrays:!0}),"testEmptyArray[]"),a.end()}),a.test("stringifies an array value with one item vs multiple items",function(a){a.test("non-array item",function(a){a.equal(qs.stringify({a:"c"},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a=c"),a.equal(qs.stringify({a:"c"},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a=c"),a.equal(qs.stringify({a:"c"},{encodeValuesOnly:!0,arrayFormat:"comma"}),"a=c"),a.equal(qs.stringify({a:"c"},{encodeValuesOnly:!0}),"a=c"),a.end()}),a.test("array with a single item",function(a){a.equal(qs.stringify({a:["c"]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[0]=c"),a.equal(qs.stringify({a:["c"]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[]=c"),a.equal(qs.stringify({a:["c"]},{encodeValuesOnly:!0,arrayFormat:"comma"}),"a=c"),a.equal(qs.stringify({a:["c"]},{encodeValuesOnly:!0,arrayFormat:"comma",commaRoundTrip:!0}),"a[]=c"),a.equal(qs.stringify({a:["c"]},{encodeValuesOnly:!0}),"a[0]=c"),a.end()}),a.test("array with multiple items",function(a){a.equal(qs.stringify({a:["c","d"]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[0]=c&a[1]=d"),a.equal(qs.stringify({a:["c","d"]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[]=c&a[]=d"),a.equal(qs.stringify({a:["c","d"]},{encodeValuesOnly:!0,arrayFormat:"comma"}),"a=c,d"),a.equal(qs.stringify({a:["c","d"]},{encodeValuesOnly:!0,arrayFormat:"comma",commaRoundTrip:!0}),"a=c,d"),a.equal(qs.stringify({a:["c","d"]},{encodeValuesOnly:!0}),"a[0]=c&a[1]=d"),a.end()}),a.test("array with multiple items with a comma inside",function(a){a.equal(qs.stringify({a:["c,d","e"]},{encodeValuesOnly:!0,arrayFormat:"comma"}),"a=c%2Cd,e"),a.equal(qs.stringify({a:["c,d","e"]},{arrayFormat:"comma"}),"a=c%2Cd%2Ce"),a.equal(qs.stringify({a:["c,d","e"]},{encodeValuesOnly:!0,arrayFormat:"comma",commaRoundTrip:!0}),"a=c%2Cd,e"),a.equal(qs.stringify({a:["c,d","e"]},{arrayFormat:"comma",commaRoundTrip:!0}),"a=c%2Cd%2Ce"),a.end()}),a.end()}),a.test("stringifies a nested array value",function(a){a.equal(qs.stringify({a:{b:["c","d"]}},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[b][0]=c&a[b][1]=d"),a.equal(qs.stringify({a:{b:["c","d"]}},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[b][]=c&a[b][]=d"),a.equal(qs.stringify({a:{b:["c","d"]}},{encodeValuesOnly:!0,arrayFormat:"comma"}),"a[b]=c,d"),a.equal(qs.stringify({a:{b:["c","d"]}},{encodeValuesOnly:!0}),"a[b][0]=c&a[b][1]=d"),a.end()}),a.test("stringifies comma and empty array values",function(a){a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!1,arrayFormat:"indices"}),"a[0]=,&a[1]=&a[2]=c,d%"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!1,arrayFormat:"brackets"}),"a[]=,&a[]=&a[]=c,d%"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!1,arrayFormat:"comma"}),"a=,,,c,d%"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!1,arrayFormat:"repeat"}),"a=,&a=&a=c,d%"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!0,arrayFormat:"indices"}),"a[0]=%2C&a[1]=&a[2]=c%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[]=%2C&a[]=&a[]=c%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!0,arrayFormat:"comma"}),"a=%2C,,c%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!0,arrayFormat:"repeat"}),"a=%2C&a=&a=c%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!1,arrayFormat:"indices"}),"a%5B0%5D=%2C&a%5B1%5D=&a%5B2%5D=c%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!1,arrayFormat:"brackets"}),"a%5B%5D=%2C&a%5B%5D=&a%5B%5D=c%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!1,arrayFormat:"comma"}),"a=%2C%2C%2Cc%2Cd%25"),a.equal(qs.stringify({a:[",","","c,d%"]},{encode:!0,encodeValuesOnly:!1,arrayFormat:"repeat"}),"a=%2C&a=&a=c%2Cd%25"),a.end()}),a.test("stringifies comma and empty non-array values",function(a){a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!1,arrayFormat:"indices"}),"a=,&b=&c=c,d%"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!1,arrayFormat:"brackets"}),"a=,&b=&c=c,d%"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!1,arrayFormat:"comma"}),"a=,&b=&c=c,d%"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!1,arrayFormat:"repeat"}),"a=,&b=&c=c,d%"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!0,arrayFormat:"indices"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!0,arrayFormat:"brackets"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!0,arrayFormat:"comma"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!0,arrayFormat:"repeat"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!1,arrayFormat:"indices"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!1,arrayFormat:"brackets"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!1,arrayFormat:"comma"}),"a=%2C&b=&c=c%2Cd%25"),a.equal(qs.stringify({a:",",b:"",c:"c,d%"},{encode:!0,encodeValuesOnly:!1,arrayFormat:"repeat"}),"a=%2C&b=&c=c%2Cd%25"),a.end()}),a.test("stringifies a nested array value with dots notation",function(a){a.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:!0,encodeValuesOnly:!0,arrayFormat:"indices"}),"a.b[0]=c&a.b[1]=d","indices: stringifies with dots + indices"),a.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:!0,encodeValuesOnly:!0,arrayFormat:"brackets"}),"a.b[]=c&a.b[]=d","brackets: stringifies with dots + brackets"),a.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:!0,encodeValuesOnly:!0,arrayFormat:"comma"}),"a.b=c,d","comma: stringifies with dots + comma"),a.equal(qs.stringify({a:{b:["c","d"]}},{allowDots:!0,encodeValuesOnly:!0}),"a.b[0]=c&a.b[1]=d","default: stringifies with dots + indices"),a.end()}),a.test("stringifies an object inside an array",function(a){a.equal(qs.stringify({a:[{b:"c"}]},{arrayFormat:"indices",encodeValuesOnly:!0}),"a[0][b]=c","indices => indices"),a.equal(qs.stringify({a:[{b:"c"}]},{arrayFormat:"repeat",encodeValuesOnly:!0}),"a[b]=c","repeat => repeat"),a.equal(qs.stringify({a:[{b:"c"}]},{arrayFormat:"brackets",encodeValuesOnly:!0}),"a[][b]=c","brackets => brackets"),a.equal(qs.stringify({a:[{b:"c"}]},{encodeValuesOnly:!0}),"a[0][b]=c","default => indices"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{arrayFormat:"indices",encodeValuesOnly:!0}),"a[0][b][c][0]=1","indices => indices"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{arrayFormat:"repeat",encodeValuesOnly:!0}),"a[b][c]=1","repeat => repeat"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{arrayFormat:"brackets",encodeValuesOnly:!0}),"a[][b][c][]=1","brackets => brackets"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{encodeValuesOnly:!0}),"a[0][b][c][0]=1","default => indices"),a.end()}),a.test("stringifies an array with mixed objects and primitives",function(a){a.equal(qs.stringify({a:[{b:1},2,3]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[0][b]=1&a[1]=2&a[2]=3","indices => indices"),a.equal(qs.stringify({a:[{b:1},2,3]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[][b]=1&a[]=2&a[]=3","brackets => brackets"),a.equal(qs.stringify({a:[{b:1},2,3]},{encodeValuesOnly:!0,arrayFormat:"comma"}),"???","brackets => brackets",{skip:"TODO: figure out what this should do"}),a.equal(qs.stringify({a:[{b:1},2,3]},{encodeValuesOnly:!0}),"a[0][b]=1&a[1]=2&a[2]=3","default => indices"),a.end()}),a.test("stringifies an object inside an array with dots notation",function(a){a.equal(qs.stringify({a:[{b:"c"}]},{allowDots:!0,encode:!1,arrayFormat:"indices"}),"a[0].b=c","indices => indices"),a.equal(qs.stringify({a:[{b:"c"}]},{allowDots:!0,encode:!1,arrayFormat:"brackets"}),"a[].b=c","brackets => brackets"),a.equal(qs.stringify({a:[{b:"c"}]},{allowDots:!0,encode:!1}),"a[0].b=c","default => indices"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{allowDots:!0,encode:!1,arrayFormat:"indices"}),"a[0].b.c[0]=1","indices => indices"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{allowDots:!0,encode:!1,arrayFormat:"brackets"}),"a[].b.c[]=1","brackets => brackets"),a.equal(qs.stringify({a:[{b:{c:[1]}}]},{allowDots:!0,encode:!1}),"a[0].b.c[0]=1","default => indices"),a.end()}),a.test("does not omit object keys when indices = false",function(a){a.equal(qs.stringify({a:[{b:"c"}]},{indices:!1}),"a%5Bb%5D=c"),a.end()}),a.test("uses indices notation for arrays when indices=true",function(a){a.equal(qs.stringify({a:["b","c"]},{indices:!0}),"a%5B0%5D=b&a%5B1%5D=c"),a.end()}),a.test("uses indices notation for arrays when no arrayFormat is specified",function(a){a.equal(qs.stringify({a:["b","c"]}),"a%5B0%5D=b&a%5B1%5D=c"),a.end()}),a.test("uses indices notation for arrays when arrayFormat=indices",function(a){a.equal(qs.stringify({a:["b","c"]},{arrayFormat:"indices"}),"a%5B0%5D=b&a%5B1%5D=c"),a.end()}),a.test("uses repeat notation for arrays when arrayFormat=repeat",function(a){a.equal(qs.stringify({a:["b","c"]},{arrayFormat:"repeat"}),"a=b&a=c"),a.end()}),a.test("uses brackets notation for arrays when arrayFormat=brackets",function(a){a.equal(qs.stringify({a:["b","c"]},{arrayFormat:"brackets"}),"a%5B%5D=b&a%5B%5D=c"),a.end()}),a.test("stringifies a complicated object",function(a){a.equal(qs.stringify({a:{b:"c",d:"e"}}),"a%5Bb%5D=c&a%5Bd%5D=e"),a.end()}),a.test("stringifies an empty value",function(a){a.equal(qs.stringify({a:""}),"a="),a.equal(qs.stringify({a:null},{strictNullHandling:!0}),"a"),a.equal(qs.stringify({a:"",b:""}),"a=&b="),a.equal(qs.stringify({a:null,b:""},{strictNullHandling:!0}),"a&b="),a.equal(qs.stringify({a:{b:""}}),"a%5Bb%5D="),a.equal(qs.stringify({a:{b:null}},{strictNullHandling:!0}),"a%5Bb%5D"),a.equal(qs.stringify({a:{b:null}},{strictNullHandling:!1}),"a%5Bb%5D="),a.end()}),a.test("stringifies an empty array in different arrayFormat",function(a){a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1}),"b[0]=&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"indices"}),"b[0]=&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"brackets"}),"b[]=&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"repeat"}),"b=&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"comma"}),"b=&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"comma",commaRoundTrip:!0}),"b[]=&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"indices",strictNullHandling:!0}),"b[0]&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"brackets",strictNullHandling:!0}),"b[]&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"repeat",strictNullHandling:!0}),"b&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"comma",strictNullHandling:!0}),"b&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"comma",strictNullHandling:!0,commaRoundTrip:!0}),"b[]&c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"indices",skipNulls:!0}),"c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"brackets",skipNulls:!0}),"c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"repeat",skipNulls:!0}),"c=c"),a.equal(qs.stringify({a:[],b:[null],c:"c"},{encode:!1,arrayFormat:"comma",skipNulls:!0}),"c=c"),a.end()}),a.test("stringifies a null object",{skip:!hasProto},function(a){a.equal(qs.stringify({__proto__:null,a:"b"}),"a=b"),a.end()}),a.test("returns an empty string for invalid input",function(a){a.equal(qs.stringify(void 0),""),a.equal(qs.stringify(!1),""),a.equal(qs.stringify(null),""),a.equal(qs.stringify(""),""),a.end()}),a.test("stringifies an object with a null object as a child",{skip:!hasProto},function(a){a.equal(qs.stringify({a:{__proto__:null,b:"c"}}),"a%5Bb%5D=c"),a.end()}),a.test("drops keys with a value of undefined",function(a){a.equal(qs.stringify({a:void 0}),""),a.equal(qs.stringify({a:{b:void 0,c:null}},{strictNullHandling:!0}),"a%5Bc%5D"),a.equal(qs.stringify({a:{b:void 0,c:null}},{strictNullHandling:!1}),"a%5Bc%5D="),a.equal(qs.stringify({a:{b:void 0,c:""}}),"a%5Bc%5D="),a.end()}),a.test("url encodes values",function(a){a.equal(qs.stringify({a:"b c"}),"a=b%20c"),a.end()}),a.test("stringifies a date",function(a){var e=new Date,t="a="+encodeURIComponent(e.toISOString());a.equal(qs.stringify({a:e}),t),a.end()}),a.test("stringifies the weird object from qs",function(a){a.equal(qs.stringify({"my weird field":"~q1!2\"'w$5&7/z8)?"}),"my%20weird%20field=~q1%212%22%27w%245%267%2Fz8%29%3F"),a.end()}),a.test("skips properties that are part of the object prototype",function(a){a.intercept(Object.prototype,"crash",{value:"test"}),a.equal(qs.stringify({a:"b"}),"a=b"),a.equal(qs.stringify({a:{b:"c"}}),"a%5Bb%5D=c"),a.end()}),a.test("stringifies boolean values",function(a){a.equal(qs.stringify({a:!0}),"a=true"),a.equal(qs.stringify({a:{b:!0}}),"a%5Bb%5D=true"),a.equal(qs.stringify({b:!1}),"b=false"),a.equal(qs.stringify({b:{c:!1}}),"b%5Bc%5D=false"),a.end()}),a.test("stringifies buffer values",function(a){a.equal(qs.stringify({a:SaferBuffer.from("test")}),"a=test"),a.equal(qs.stringify({a:{b:SaferBuffer.from("test")}}),"a%5Bb%5D=test"),a.end()}),a.test("stringifies an object using an alternative delimiter",function(a){a.equal(qs.stringify({a:"b",c:"d"},{delimiter:";"}),"a=b;c=d"),a.end()}),a.test("does not blow up when Buffer global is missing",function(a){var e=mockProperty(global,"Buffer",{delete:!0}),t=qs.stringify({a:"b",c:"d"});e(),a.equal(t,"a=b&c=d"),a.end()}),a.test("does not crash when parsing circular references",function(a){var e={};e.b=e,a.throws(function(){qs.stringify({"foo[bar]":"baz","foo[baz]":e})},/RangeError: Cyclic object value/,"cyclic values throw");var t={a:"value"};t.a=t,a.throws(function(){qs.stringify(t)},/RangeError: Cyclic object value/,"cyclic values throw");var n=["a"];a.doesNotThrow(function(){qs.stringify({x:n,y:n})},"non-cyclic values do not throw"),a.end()}),a.test("non-circular duplicated references can still work",function(a){var e={function:"hour_of_day"},t={function:"gte",arguments:[e,0]},n={function:"lte",arguments:[e,23]};a.equal(qs.stringify({filters:{$and:[t,n]}},{encodeValuesOnly:!0,arrayFormat:"indices"}),"filters[$and][0][function]=gte&filters[$and][0][arguments][0][function]=hour_of_day&filters[$and][0][arguments][1]=0&filters[$and][1][function]=lte&filters[$and][1][arguments][0][function]=hour_of_day&filters[$and][1][arguments][1]=23"),a.equal(qs.stringify({filters:{$and:[t,n]}},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"filters[$and][][function]=gte&filters[$and][][arguments][][function]=hour_of_day&filters[$and][][arguments][]=0&filters[$and][][function]=lte&filters[$and][][arguments][][function]=hour_of_day&filters[$and][][arguments][]=23"),a.equal(qs.stringify({filters:{$and:[t,n]}},{encodeValuesOnly:!0,arrayFormat:"repeat"}),"filters[$and][function]=gte&filters[$and][arguments][function]=hour_of_day&filters[$and][arguments]=0&filters[$and][function]=lte&filters[$and][arguments][function]=hour_of_day&filters[$and][arguments]=23"),a.end()}),a.test("selects properties when filter=array",function(a){a.equal(qs.stringify({a:"b"},{filter:["a"]}),"a=b"),a.equal(qs.stringify({a:1},{filter:[]}),""),a.equal(qs.stringify({a:{b:[1,2,3,4],c:"d"},c:"f"},{filter:["a","b",0,2],arrayFormat:"indices"}),"a%5Bb%5D%5B0%5D=1&a%5Bb%5D%5B2%5D=3","indices => indices"),a.equal(qs.stringify({a:{b:[1,2,3,4],c:"d"},c:"f"},{filter:["a","b",0,2],arrayFormat:"brackets"}),"a%5Bb%5D%5B%5D=1&a%5Bb%5D%5B%5D=3","brackets => brackets"),a.equal(qs.stringify({a:{b:[1,2,3,4],c:"d"},c:"f"},{filter:["a","b",0,2]}),"a%5Bb%5D%5B0%5D=1&a%5Bb%5D%5B2%5D=3","default => indices"),a.end()}),a.test("supports custom representations when filter=function",function(a){var e=0,t={a:"b",c:"d",e:{f:new Date(1257894e6)}};a.equal(qs.stringify(t,{filter:function(n,s){if(1===(e+=1))a.equal(n,"","prefix is empty"),a.equal(s,t);else{if("c"===n)return;if(s instanceof Date)return a.equal(n,"e[f]"),s.getTime()}return s}}),"a=b&e%5Bf%5D=1257894000000"),a.equal(e,5),a.end()}),a.test("can disable uri encoding",function(a){a.equal(qs.stringify({a:"b"},{encode:!1}),"a=b"),a.equal(qs.stringify({a:{b:"c"}},{encode:!1}),"a[b]=c"),a.equal(qs.stringify({a:"b",c:null},{strictNullHandling:!0,encode:!1}),"a=b&c"),a.end()}),a.test("can sort the keys",function(a){var e=function(a,e){return a.localeCompare(e)};a.equal(qs.stringify({a:"c",z:"y",b:"f"},{sort:e}),"a=c&b=f&z=y"),a.equal(qs.stringify({a:"c",z:{j:"a",i:"b"},b:"f"},{sort:e}),"a=c&b=f&z%5Bi%5D=b&z%5Bj%5D=a"),a.end()}),a.test("can sort the keys at depth 3 or more too",function(a){a.equal(qs.stringify({a:"a",z:{zj:{zjb:"zjb",zja:"zja"},zi:{zib:"zib",zia:"zia"}},b:"b"},{sort:function(a,e){return a.localeCompare(e)},encode:!1}),"a=a&b=b&z[zi][zia]=zia&z[zi][zib]=zib&z[zj][zja]=zja&z[zj][zjb]=zjb"),a.equal(qs.stringify({a:"a",z:{zj:{zjb:"zjb",zja:"zja"},zi:{zib:"zib",zia:"zia"}},b:"b"},{sort:null,encode:!1}),"a=a&z[zj][zjb]=zjb&z[zj][zja]=zja&z[zi][zib]=zib&z[zi][zia]=zia&b=b"),a.end()}),a.test("can stringify with custom encoding",function(a){a.equal(qs.stringify({"çœŒ":"å¤§é˜ªåºœ","":""},{encoder:function(a){if(0===a.length)return"";for(var e=iconv.encode(a,"shiftjis"),t=[],n=0;n<e.length;++n)t.push(e.readUInt8(n).toString(16));return"%"+t.join("%")}}),"%8c%a7=%91%e5%8d%e3%95%7b&="),a.end()}),a.test("receives the default encoder as a second argument",function(a){a.plan(8),qs.stringify({a:1,b:new Date,c:!0,d:[1]},{encoder:function(e){return a.match(typeof e,/^(?:string|number|boolean)$/),""}}),a.end()}),a.test("receives the default encoder as a second argument",function(a){a.plan(2),qs.stringify({a:1},{encoder:function(e,t){a.equal(t,utils.encode)}}),a.end()}),a.test("throws error with wrong encoder",function(a){a.throws(function(){qs.stringify({},{encoder:"string"})},new TypeError("Encoder has to be a function.")),a.end()}),a.test("can use custom encoder for a buffer object",{skip:"undefined"==typeof Buffer},function(a){a.equal(qs.stringify({a:SaferBuffer.from([1])},{encoder:function(a){return"string"==typeof a?a:String.fromCharCode(a.readUInt8(0)+97)}}),"a=b"),a.equal(qs.stringify({a:SaferBuffer.from("a b")},{encoder:function(a){return a}}),"a=a b"),a.end()}),a.test("serializeDate option",function(a){var e=new Date;a.equal(qs.stringify({a:e}),"a="+e.toISOString().replace(/:/g,"%3A"),"default is toISOString");var t=new Date;t.toISOString=function(){throw new SyntaxError},a.throws(function(){t.toISOString()},SyntaxError),a.equal(qs.stringify({a:t}),"a="+Date.prototype.toISOString.call(t).replace(/:/g,"%3A"),"toISOString works even when method is not locally present");var n=new Date(6);a.equal(qs.stringify({a:n},{serializeDate:function(a){return 7*a.getTime()}}),"a=42","custom serializeDate function called"),a.equal(qs.stringify({a:[e]},{serializeDate:function(a){return a.getTime()},arrayFormat:"comma"}),"a="+e.getTime(),"works with arrayFormat comma"),a.equal(qs.stringify({a:[e]},{serializeDate:function(a){return a.getTime()},arrayFormat:"comma",commaRoundTrip:!0}),"a%5B%5D="+e.getTime(),"works with arrayFormat comma"),a.end()}),a.test("RFC 1738 serialization",function(a){a.equal(qs.stringify({a:"b c"},{format:qs.formats.RFC1738}),"a=b+c"),a.equal(qs.stringify({"a b":"c d"},{format:qs.formats.RFC1738}),"a+b=c+d"),a.equal(qs.stringify({"a b":SaferBuffer.from("a b")},{format:qs.formats.RFC1738}),"a+b=a+b"),a.equal(qs.stringify({"foo(ref)":"bar"},{format:qs.formats.RFC1738}),"foo(ref)=bar"),a.end()}),a.test("RFC 3986 spaces serialization",function(a){a.equal(qs.stringify({a:"b c"},{format:qs.formats.RFC3986}),"a=b%20c"),a.equal(qs.stringify({"a b":"c d"},{format:qs.formats.RFC3986}),"a%20b=c%20d"),a.equal(qs.stringify({"a b":SaferBuffer.from("a b")},{format:qs.formats.RFC3986}),"a%20b=a%20b"),a.end()}),a.test("Backward compatibility to RFC 3986",function(a){a.equal(qs.stringify({a:"b c"}),"a=b%20c"),a.equal(qs.stringify({"a b":SaferBuffer.from("a b")}),"a%20b=a%20b"),a.end()}),a.test("Edge cases and unknown formats",function(a){["UFO1234",!1,1234,null,{},[]].forEach(function(e){a.throws(function(){qs.stringify({a:"b c"},{format:e})},new TypeError("Unknown format option provided."))}),a.end()}),a.test("encodeValuesOnly",function(a){a.equal(qs.stringify({a:"b",c:["d","e=f"],f:[["g"],["h"]]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a=b&c[0]=d&c[1]=e%3Df&f[0][0]=g&f[1][0]=h","encodeValuesOnly + indices"),a.equal(qs.stringify({a:"b",c:["d","e=f"],f:[["g"],["h"]]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a=b&c[]=d&c[]=e%3Df&f[][]=g&f[][]=h","encodeValuesOnly + brackets"),a.equal(qs.stringify({a:"b",c:["d","e=f"],f:[["g"],["h"]]},{encodeValuesOnly:!0,arrayFormat:"repeat"}),"a=b&c=d&c=e%3Df&f=g&f=h","encodeValuesOnly + repeat"),a.equal(qs.stringify({a:"b",c:["d","e"],f:[["g"],["h"]]},{arrayFormat:"indices"}),"a=b&c%5B0%5D=d&c%5B1%5D=e&f%5B0%5D%5B0%5D=g&f%5B1%5D%5B0%5D=h","no encodeValuesOnly + indices"),a.equal(qs.stringify({a:"b",c:["d","e"],f:[["g"],["h"]]},{arrayFormat:"brackets"}),"a=b&c%5B%5D=d&c%5B%5D=e&f%5B%5D%5B%5D=g&f%5B%5D%5B%5D=h","no encodeValuesOnly + brackets"),a.equal(qs.stringify({a:"b",c:["d","e"],f:[["g"],["h"]]},{arrayFormat:"repeat"}),"a=b&c=d&c=e&f=g&f=h","no encodeValuesOnly + repeat"),a.end()}),a.test("encodeValuesOnly - strictNullHandling",function(a){a.equal(qs.stringify({a:{b:null}},{encodeValuesOnly:!0,strictNullHandling:!0}),"a[b]"),a.end()}),a.test("throws if an invalid charset is specified",function(a){a.throws(function(){qs.stringify({a:"b"},{charset:"foobar"})},new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined")),a.end()}),a.test("respects a charset of iso-8859-1",function(a){a.equal(qs.stringify({"Ã¦":"Ã¦"},{charset:"iso-8859-1"}),"%E6=%E6"),a.end()}),a.test("encodes unrepresentable chars as numeric entities in iso-8859-1 mode",function(a){a.equal(qs.stringify({a:"â˜º"},{charset:"iso-8859-1"}),"a=%26%239786%3B"),a.end()}),a.test("respects an explicit charset of utf-8 (the default)",function(a){a.equal(qs.stringify({a:"Ã¦"},{charset:"utf-8"}),"a=%C3%A6"),a.end()}),a.test("`charsetSentinel` option",function(a){a.equal(qs.stringify({a:"Ã¦"},{charsetSentinel:!0,charset:"utf-8"}),"utf8=%E2%9C%93&a=%C3%A6","adds the right sentinel when instructed to and the charset is utf-8"),a.equal(qs.stringify({a:"Ã¦"},{charsetSentinel:!0,charset:"iso-8859-1"}),"utf8=%26%2310003%3B&a=%E6","adds the right sentinel when instructed to and the charset is iso-8859-1"),a.end()}),a.test("does not mutate the options argument",function(a){var e={};qs.stringify({},e),a.deepEqual(e,{}),a.end()}),a.test("strictNullHandling works with custom filter",function(a){var e={strictNullHandling:!0,filter:function(a,e){return e}};a.equal(qs.stringify({key:null},e),"key"),a.end()}),a.test("strictNullHandling works with null serializeDate",function(a){var e={strictNullHandling:!0,serializeDate:function(){return null}},t=new Date;a.equal(qs.stringify({key:t},e),"key"),a.end()}),a.test("allows for encoding keys and values differently",function(a){a.deepEqual(qs.stringify({KeY:"vAlUe"},{encoder:function(a,e,t,n){if("key"===n)return e(a,e,t,n).toLowerCase();if("value"===n)return e(a,e,t,n).toUpperCase();throw"this should never happen! type: "+n}}),"key=VALUE"),a.end()}),a.test("objects inside arrays",function(a){var e={a:{b:{c:"d",e:"f"}}},t={a:{b:[{c:"d",e:"f"}]}};a.equal(qs.stringify(e,{encode:!1}),"a[b][c]=d&a[b][e]=f","no array, no arrayFormat"),a.equal(qs.stringify(e,{encode:!1,arrayFormat:"brackets"}),"a[b][c]=d&a[b][e]=f","no array, bracket"),a.equal(qs.stringify(e,{encode:!1,arrayFormat:"indices"}),"a[b][c]=d&a[b][e]=f","no array, indices"),a.equal(qs.stringify(e,{encode:!1,arrayFormat:"repeat"}),"a[b][c]=d&a[b][e]=f","no array, repeat"),a.equal(qs.stringify(e,{encode:!1,arrayFormat:"comma"}),"a[b][c]=d&a[b][e]=f","no array, comma"),a.equal(qs.stringify(t,{encode:!1}),"a[b][0][c]=d&a[b][0][e]=f","array, no arrayFormat"),a.equal(qs.stringify(t,{encode:!1,arrayFormat:"brackets"}),"a[b][][c]=d&a[b][][e]=f","array, bracket"),a.equal(qs.stringify(t,{encode:!1,arrayFormat:"indices"}),"a[b][0][c]=d&a[b][0][e]=f","array, indices"),a.equal(qs.stringify(t,{encode:!1,arrayFormat:"repeat"}),"a[b][c]=d&a[b][e]=f","array, repeat"),a.equal(qs.stringify(t,{encode:!1,arrayFormat:"comma"}),"???","array, comma",{skip:"TODO: figure out what this should do"}),a.end()}),a.test("stringifies sparse arrays",function(a){a.equal(qs.stringify({a:[,"2",,,"1"]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[1]=2&a[4]=1"),a.equal(qs.stringify({a:[,"2",,,"1"]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[]=2&a[]=1"),a.equal(qs.stringify({a:[,"2",,,"1"]},{encodeValuesOnly:!0,arrayFormat:"repeat"}),"a=2&a=1"),a.equal(qs.stringify({a:[,{b:[,,{c:"1"}]}]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[1][b][2][c]=1"),a.equal(qs.stringify({a:[,{b:[,,{c:"1"}]}]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[][b][][c]=1"),a.equal(qs.stringify({a:[,{b:[,,{c:"1"}]}]},{encodeValuesOnly:!0,arrayFormat:"repeat"}),"a[b][c]=1"),a.equal(qs.stringify({a:[,[,,[,,,{c:"1"}]]]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[1][2][3][c]=1"),a.equal(qs.stringify({a:[,[,,[,,,{c:"1"}]]]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[][][][c]=1"),a.equal(qs.stringify({a:[,[,,[,,,{c:"1"}]]]},{encodeValuesOnly:!0,arrayFormat:"repeat"}),"a[c]=1"),a.equal(qs.stringify({a:[,[,,[,,,{c:[,"1"]}]]]},{encodeValuesOnly:!0,arrayFormat:"indices"}),"a[1][2][3][c][1]=1"),a.equal(qs.stringify({a:[,[,,[,,,{c:[,"1"]}]]]},{encodeValuesOnly:!0,arrayFormat:"brackets"}),"a[][][][c][]=1"),a.equal(qs.stringify({a:[,[,,[,,,{c:[,"1"]}]]]},{encodeValuesOnly:!0,arrayFormat:"repeat"}),"a[c]=1"),a.end()}),a.test("encodes a very long string",function(a){for(var e=[],t=[],n=0;n<5e3;n++)e.push(" "+n),t.push("%20"+n);var s={foo:e.join("")};a.equal(qs.stringify(s,{arrayFormat:"brackets",charset:"utf-8"}),"foo="+t.join("")),a.end()}),a.end()}),test("stringifies empty keys",function(a){emptyTestCases.forEach(function(e){a.test("stringifies an object with empty string key with "+e.input,function(a){a.deepEqual(qs.stringify(e.withEmptyKeys,{encode:!1,arrayFormat:"indices"}),e.stringifyOutput.indices,"test case: "+e.input+", indices"),a.deepEqual(qs.stringify(e.withEmptyKeys,{encode:!1,arrayFormat:"brackets"}),e.stringifyOutput.brackets,"test case: "+e.input+", brackets"),a.deepEqual(qs.stringify(e.withEmptyKeys,{encode:!1,arrayFormat:"repeat"}),e.stringifyOutput.repeat,"test case: "+e.input+", repeat"),a.end()})}),a.test("edge case with object/arrays",function(a){a.deepEqual(qs.stringify({"":{"":[2,3]}},{encode:!1}),"[][0]=2&[][1]=3"),a.deepEqual(qs.stringify({"":{"":[2,3],a:2}},{encode:!1}),"[][0]=2&[][1]=3&[a]=2"),a.deepEqual(qs.stringify({"":{"":[2,3]}},{encode:!1,arrayFormat:"indices"}),"[][0]=2&[][1]=3"),a.deepEqual(qs.stringify({"":{"":[2,3],a:2}},{encode:!1,arrayFormat:"indices"}),"[][0]=2&[][1]=3&[a]=2"),a.end()}),a.test("stringifies non-string keys",function(a){var e=qs.stringify({a:"b",false:{}},{filter:["a",!1,null],allowDots:!0,encodeDotInKeys:!0});a.equal(e,"a=b","stringifies correctly"),a.end()})});