"use strict";var test=require("tape"),hasPropertyDescriptors=require("has-property-descriptors")(),iconv=require("iconv-lite"),mockProperty=require("mock-property"),hasOverrideMistake=require("has-override-mistake")(),SaferBuffer=require("safer-buffer").Buffer,v=require("es-value-fixtures"),inspect=require("object-inspect"),emptyTestCases=require("./empty-keys-cases").emptyTestCases,hasProto=require("has-proto")(),qs=require("../"),utils=require("../lib/utils");test("parse()",function(e){e.test("parses a simple string",function(e){e.deepEqual(qs.parse("0=foo"),{0:"foo"}),e.deepEqual(qs.parse("foo=c++"),{foo:"c  "}),e.deepEqual(qs.parse("a[>=]=23"),{a:{">=":"23"}}),e.deepEqual(qs.parse("a[<=>]==23"),{a:{"<=>":"=23"}}),e.deepEqual(qs.parse("a[==]=23"),{a:{"==":"23"}}),e.deepEqual(qs.parse("foo",{strictNullHandling:!0}),{foo:null}),e.deepEqual(qs.parse("foo"),{foo:""}),e.deepEqual(qs.parse("foo="),{foo:""}),e.deepEqual(qs.parse("foo=bar"),{foo:"bar"}),e.deepEqual(qs.parse(" foo = bar = baz "),{" foo ":" bar = baz "}),e.deepEqual(qs.parse("foo=bar=baz"),{foo:"bar=baz"}),e.deepEqual(qs.parse("foo=bar&bar=baz"),{foo:"bar",bar:"baz"}),e.deepEqual(qs.parse("foo2=bar2&baz2="),{foo2:"bar2",baz2:""}),e.deepEqual(qs.parse("foo=bar&baz",{strictNullHandling:!0}),{foo:"bar",baz:null}),e.deepEqual(qs.parse("foo=bar&baz"),{foo:"bar",baz:""}),e.deepEqual(qs.parse("cht=p3&chd=t:60,40&chs=250x100&chl=Hello|World"),{cht:"p3",chd:"t:60,40",chs:"250x100",chl:"Hello|World"}),e.end()}),e.test("comma: false",function(e){e.deepEqual(qs.parse("a[]=b&a[]=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a[0]=b&a[1]=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a=b,c"),{a:"b,c"}),e.deepEqual(qs.parse("a=b&a=c"),{a:["b","c"]}),e.end()}),e.test("comma: true",function(e){e.deepEqual(qs.parse("a[]=b&a[]=c",{comma:!0}),{a:["b","c"]}),e.deepEqual(qs.parse("a[0]=b&a[1]=c",{comma:!0}),{a:["b","c"]}),e.deepEqual(qs.parse("a=b,c",{comma:!0}),{a:["b","c"]}),e.deepEqual(qs.parse("a=b&a=c",{comma:!0}),{a:["b","c"]}),e.end()}),e.test("allows enabling dot notation",function(e){e.deepEqual(qs.parse("a.b=c"),{"a.b":"c"}),e.deepEqual(qs.parse("a.b=c",{allowDots:!0}),{a:{b:"c"}}),e.end()}),e.test("decode dot keys correctly",function(e){e.deepEqual(qs.parse("name%252Eobj.first=John&name%252Eobj.last=Doe",{allowDots:!1,decodeDotInKeys:!1}),{"name%2Eobj.first":"John","name%2Eobj.last":"Doe"},"with allowDots false and decodeDotInKeys false"),e.deepEqual(qs.parse("name.obj.first=John&name.obj.last=Doe",{allowDots:!0,decodeDotInKeys:!1}),{name:{obj:{first:"John",last:"Doe"}}},"with allowDots false and decodeDotInKeys false"),e.deepEqual(qs.parse("name%252Eobj.first=John&name%252Eobj.last=Doe",{allowDots:!0,decodeDotInKeys:!1}),{"name%2Eobj":{first:"John",last:"Doe"}},"with allowDots true and decodeDotInKeys false"),e.deepEqual(qs.parse("name%252Eobj.first=John&name%252Eobj.last=Doe",{allowDots:!0,decodeDotInKeys:!0}),{"name.obj":{first:"John",last:"Doe"}},"with allowDots true and decodeDotInKeys true"),e.deepEqual(qs.parse("name%252Eobj%252Esubobject.first%252Egodly%252Ename=John&name%252Eobj%252Esubobject.last=Doe",{allowDots:!1,decodeDotInKeys:!1}),{"name%2Eobj%2Esubobject.first%2Egodly%2Ename":"John","name%2Eobj%2Esubobject.last":"Doe"},"with allowDots false and decodeDotInKeys false"),e.deepEqual(qs.parse("name.obj.subobject.first.godly.name=John&name.obj.subobject.last=Doe",{allowDots:!0,decodeDotInKeys:!1}),{name:{obj:{subobject:{first:{godly:{name:"John"}},last:"Doe"}}}},"with allowDots true and decodeDotInKeys false"),e.deepEqual(qs.parse("name%252Eobj%252Esubobject.first%252Egodly%252Ename=John&name%252Eobj%252Esubobject.last=Doe",{allowDots:!0,decodeDotInKeys:!0}),{"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},"with allowDots true and decodeDotInKeys true"),e.deepEqual(qs.parse("name%252Eobj.first=John&name%252Eobj.last=Doe"),{"name%2Eobj.first":"John","name%2Eobj.last":"Doe"},"with allowDots and decodeDotInKeys undefined"),e.end()}),e.test("decodes dot in key of object, and allow enabling dot notation when decodeDotInKeys is set to true and allowDots is undefined",function(e){e.deepEqual(qs.parse("name%252Eobj%252Esubobject.first%252Egodly%252Ename=John&name%252Eobj%252Esubobject.last=Doe",{decodeDotInKeys:!0}),{"name.obj.subobject":{"first.godly.name":"John",last:"Doe"}},"with allowDots undefined and decodeDotInKeys true"),e.end()}),e.test("throws when decodeDotInKeys is not of type boolean",function(e){e.throws(function(){qs.parse("foo[]&bar=baz",{decodeDotInKeys:"foobar"})},TypeError),e.throws(function(){qs.parse("foo[]&bar=baz",{decodeDotInKeys:0})},TypeError),e.throws(function(){qs.parse("foo[]&bar=baz",{decodeDotInKeys:NaN})},TypeError),e.throws(function(){qs.parse("foo[]&bar=baz",{decodeDotInKeys:null})},TypeError),e.end()}),e.test("allows empty arrays in obj values",function(e){e.deepEqual(qs.parse("foo[]&bar=baz",{allowEmptyArrays:!0}),{foo:[],bar:"baz"}),e.deepEqual(qs.parse("foo[]&bar=baz",{allowEmptyArrays:!1}),{foo:[""],bar:"baz"}),e.end()}),e.test("throws when allowEmptyArrays is not of type boolean",function(e){e.throws(function(){qs.parse("foo[]&bar=baz",{allowEmptyArrays:"foobar"})},TypeError),e.throws(function(){qs.parse("foo[]&bar=baz",{allowEmptyArrays:0})},TypeError),e.throws(function(){qs.parse("foo[]&bar=baz",{allowEmptyArrays:NaN})},TypeError),e.throws(function(){qs.parse("foo[]&bar=baz",{allowEmptyArrays:null})},TypeError),e.end()}),e.test("allowEmptyArrays + strictNullHandling",function(e){e.deepEqual(qs.parse("testEmptyArray[]",{strictNullHandling:!0,allowEmptyArrays:!0}),{testEmptyArray:[]}),e.end()}),e.deepEqual(qs.parse("a[b]=c"),{a:{b:"c"}},"parses a single nested string"),e.deepEqual(qs.parse("a[b][c]=d"),{a:{b:{c:"d"}}},"parses a double nested string"),e.deepEqual(qs.parse("a[b][c][d][e][f][g][h]=i"),{a:{b:{c:{d:{e:{f:{"[g][h]":"i"}}}}}}},"defaults to a depth of 5"),e.test("only parses one level when depth = 1",function(e){e.deepEqual(qs.parse("a[b][c]=d",{depth:1}),{a:{b:{"[c]":"d"}}}),e.deepEqual(qs.parse("a[b][c][d]=e",{depth:1}),{a:{b:{"[c][d]":"e"}}}),e.end()}),e.test("uses original key when depth = 0",function(e){e.deepEqual(qs.parse("a[0]=b&a[1]=c",{depth:0}),{"a[0]":"b","a[1]":"c"}),e.deepEqual(qs.parse("a[0][0]=b&a[0][1]=c&a[1]=d&e=2",{depth:0}),{"a[0][0]":"b","a[0][1]":"c","a[1]":"d",e:"2"}),e.end()}),e.test("uses original key when depth = false",function(e){e.deepEqual(qs.parse("a[0]=b&a[1]=c",{depth:!1}),{"a[0]":"b","a[1]":"c"}),e.deepEqual(qs.parse("a[0][0]=b&a[0][1]=c&a[1]=d&e=2",{depth:!1}),{"a[0][0]":"b","a[0][1]":"c","a[1]":"d",e:"2"}),e.end()}),e.deepEqual(qs.parse("a=b&a=c"),{a:["b","c"]},"parses a simple array"),e.test("parses an explicit array",function(e){e.deepEqual(qs.parse("a[]=b"),{a:["b"]}),e.deepEqual(qs.parse("a[]=b&a[]=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a[]=b&a[]=c&a[]=d"),{a:["b","c","d"]}),e.end()}),e.test("parses a mix of simple and explicit arrays",function(e){e.deepEqual(qs.parse("a=b&a[]=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a[]=b&a=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a[0]=b&a=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a=b&a[0]=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a[1]=b&a=c",{arrayLimit:20}),{a:["b","c"]}),e.deepEqual(qs.parse("a[]=b&a=c",{arrayLimit:0}),{a:["b","c"]}),e.deepEqual(qs.parse("a[]=b&a=c"),{a:["b","c"]}),e.deepEqual(qs.parse("a=b&a[1]=c",{arrayLimit:20}),{a:["b","c"]}),e.deepEqual(qs.parse("a=b&a[]=c",{arrayLimit:0}),{a:["b","c"]}),e.deepEqual(qs.parse("a=b&a[]=c"),{a:["b","c"]}),e.end()}),e.test("parses a nested array",function(e){e.deepEqual(qs.parse("a[b][]=c&a[b][]=d"),{a:{b:["c","d"]}}),e.deepEqual(qs.parse("a[>=]=25"),{a:{">=":"25"}}),e.end()}),e.test("allows to specify array indices",function(e){e.deepEqual(qs.parse("a[1]=c&a[0]=b&a[2]=d"),{a:["b","c","d"]}),e.deepEqual(qs.parse("a[1]=c&a[0]=b"),{a:["b","c"]}),e.deepEqual(qs.parse("a[1]=c",{arrayLimit:20}),{a:["c"]}),e.deepEqual(qs.parse("a[1]=c",{arrayLimit:0}),{a:{1:"c"}}),e.deepEqual(qs.parse("a[1]=c"),{a:["c"]}),e.end()}),e.test("limits specific array indices to arrayLimit",function(e){e.deepEqual(qs.parse("a[20]=a",{arrayLimit:20}),{a:["a"]}),e.deepEqual(qs.parse("a[21]=a",{arrayLimit:20}),{a:{21:"a"}}),e.deepEqual(qs.parse("a[20]=a"),{a:["a"]}),e.deepEqual(qs.parse("a[21]=a"),{a:{21:"a"}}),e.end()}),e.deepEqual(qs.parse("a[12b]=c"),{a:{"12b":"c"}},"supports keys that begin with a number"),e.test("supports encoded = signs",function(e){e.deepEqual(qs.parse("he%3Dllo=th%3Dere"),{"he=llo":"th=ere"}),e.end()}),e.test("is ok with url encoded strings",function(e){e.deepEqual(qs.parse("a[b%20c]=d"),{a:{"b c":"d"}}),e.deepEqual(qs.parse("a[b]=c%20d"),{a:{b:"c d"}}),e.end()}),e.test("allows brackets in the value",function(e){e.deepEqual(qs.parse('pets=["tobi"]'),{pets:'["tobi"]'}),e.deepEqual(qs.parse('operators=[">=", "<="]'),{operators:'[">=", "<="]'}),e.end()}),e.test("allows empty values",function(e){e.deepEqual(qs.parse(""),{}),e.deepEqual(qs.parse(null),{}),e.deepEqual(qs.parse(void 0),{}),e.end()}),e.test("transforms arrays to objects",function(e){e.deepEqual(qs.parse("foo[0]=bar&foo[bad]=baz"),{foo:{0:"bar",bad:"baz"}}),e.deepEqual(qs.parse("foo[bad]=baz&foo[0]=bar"),{foo:{bad:"baz",0:"bar"}}),e.deepEqual(qs.parse("foo[bad]=baz&foo[]=bar"),{foo:{bad:"baz",0:"bar"}}),e.deepEqual(qs.parse("foo[]=bar&foo[bad]=baz"),{foo:{0:"bar",bad:"baz"}}),e.deepEqual(qs.parse("foo[bad]=baz&foo[]=bar&foo[]=foo"),{foo:{bad:"baz",0:"bar",1:"foo"}}),e.deepEqual(qs.parse("foo[0][a]=a&foo[0][b]=b&foo[1][a]=aa&foo[1][b]=bb"),{foo:[{a:"a",b:"b"},{a:"aa",b:"bb"}]}),e.deepEqual(qs.parse("a[]=b&a[t]=u&a[hasOwnProperty]=c",{allowPrototypes:!1}),{a:{0:"b",t:"u"}}),e.deepEqual(qs.parse("a[]=b&a[t]=u&a[hasOwnProperty]=c",{allowPrototypes:!0}),{a:{0:"b",t:"u",hasOwnProperty:"c"}}),e.deepEqual(qs.parse("a[]=b&a[hasOwnProperty]=c&a[x]=y",{allowPrototypes:!1}),{a:{0:"b",x:"y"}}),e.deepEqual(qs.parse("a[]=b&a[hasOwnProperty]=c&a[x]=y",{allowPrototypes:!0}),{a:{0:"b",hasOwnProperty:"c",x:"y"}}),e.end()}),e.test("transforms arrays to objects (dot notation)",function(e){e.deepEqual(qs.parse("foo[0].baz=bar&fool.bad=baz",{allowDots:!0}),{foo:[{baz:"bar"}],fool:{bad:"baz"}}),e.deepEqual(qs.parse("foo[0].baz=bar&fool.bad.boo=baz",{allowDots:!0}),{foo:[{baz:"bar"}],fool:{bad:{boo:"baz"}}}),e.deepEqual(qs.parse("foo[0][0].baz=bar&fool.bad=baz",{allowDots:!0}),{foo:[[{baz:"bar"}]],fool:{bad:"baz"}}),e.deepEqual(qs.parse("foo[0].baz[0]=15&foo[0].bar=2",{allowDots:!0}),{foo:[{baz:["15"],bar:"2"}]}),e.deepEqual(qs.parse("foo[0].baz[0]=15&foo[0].baz[1]=16&foo[0].bar=2",{allowDots:!0}),{foo:[{baz:["15","16"],bar:"2"}]}),e.deepEqual(qs.parse("foo.bad=baz&foo[0]=bar",{allowDots:!0}),{foo:{bad:"baz",0:"bar"}}),e.deepEqual(qs.parse("foo.bad=baz&foo[]=bar",{allowDots:!0}),{foo:{bad:"baz",0:"bar"}}),e.deepEqual(qs.parse("foo[]=bar&foo.bad=baz",{allowDots:!0}),{foo:{0:"bar",bad:"baz"}}),e.deepEqual(qs.parse("foo.bad=baz&foo[]=bar&foo[]=foo",{allowDots:!0}),{foo:{bad:"baz",0:"bar",1:"foo"}}),e.deepEqual(qs.parse("foo[0].a=a&foo[0].b=b&foo[1].a=aa&foo[1].b=bb",{allowDots:!0}),{foo:[{a:"a",b:"b"},{a:"aa",b:"bb"}]}),e.end()}),e.test("correctly prunes undefined values when converting an array to an object",function(e){e.deepEqual(qs.parse("a[2]=b&a[99999999]=c"),{a:{2:"b",99999999:"c"}}),e.end()}),e.test("supports malformed uri characters",function(e){e.deepEqual(qs.parse("{%:%}",{strictNullHandling:!0}),{"{%:%}":null}),e.deepEqual(qs.parse("{%:%}="),{"{%:%}":""}),e.deepEqual(qs.parse("foo=%:%}"),{foo:"%:%}"}),e.end()}),e.test("doesn't produce empty keys",function(e){e.deepEqual(qs.parse("_r=1&"),{_r:"1"}),e.end()}),e.test("cannot access Object prototype",function(e){qs.parse("constructor[prototype][bad]=bad"),qs.parse("bad[constructor][prototype][bad]=bad"),e.equal(typeof Object.prototype.bad,"undefined"),e.end()}),e.test("parses arrays of objects",function(e){e.deepEqual(qs.parse("a[][b]=c"),{a:[{b:"c"}]}),e.deepEqual(qs.parse("a[0][b]=c"),{a:[{b:"c"}]}),e.end()}),e.test("allows for empty strings in arrays",function(e){e.deepEqual(qs.parse("a[]=b&a[]=&a[]=c"),{a:["b","","c"]}),e.deepEqual(qs.parse("a[0]=b&a[1]&a[2]=c&a[19]=",{strictNullHandling:!0,arrayLimit:20}),{a:["b",null,"c",""]},"with arrayLimit 20 + array indices: null then empty string works"),e.deepEqual(qs.parse("a[]=b&a[]&a[]=c&a[]=",{strictNullHandling:!0,arrayLimit:0}),{a:["b",null,"c",""]},"with arrayLimit 0 + array brackets: null then empty string works"),e.deepEqual(qs.parse("a[0]=b&a[1]=&a[2]=c&a[19]",{strictNullHandling:!0,arrayLimit:20}),{a:["b","","c",null]},"with arrayLimit 20 + array indices: empty string then null works"),e.deepEqual(qs.parse("a[]=b&a[]=&a[]=c&a[]",{strictNullHandling:!0,arrayLimit:0}),{a:["b","","c",null]},"with arrayLimit 0 + array brackets: empty string then null works"),e.deepEqual(qs.parse("a[]=&a[]=b&a[]=c"),{a:["","b","c"]},"array brackets: empty strings work"),e.end()}),e.test("compacts sparse arrays",function(e){e.deepEqual(qs.parse("a[10]=1&a[2]=2",{arrayLimit:20}),{a:["2","1"]}),e.deepEqual(qs.parse("a[1][b][2][c]=1",{arrayLimit:20}),{a:[{b:[{c:"1"}]}]}),e.deepEqual(qs.parse("a[1][2][3][c]=1",{arrayLimit:20}),{a:[[[{c:"1"}]]]}),e.deepEqual(qs.parse("a[1][2][3][c][1]=1",{arrayLimit:20}),{a:[[[{c:["1"]}]]]}),e.end()}),e.test("parses sparse arrays",function(e){e.deepEqual(qs.parse("a[4]=1&a[1]=2",{allowSparse:!0}),{a:[,"2",,,"1"]}),e.deepEqual(qs.parse("a[1][b][2][c]=1",{allowSparse:!0}),{a:[,{b:[,,{c:"1"}]}]}),e.deepEqual(qs.parse("a[1][2][3][c]=1",{allowSparse:!0}),{a:[,[,,[,,,{c:"1"}]]]}),e.deepEqual(qs.parse("a[1][2][3][c][1]=1",{allowSparse:!0}),{a:[,[,,[,,,{c:[,"1"]}]]]}),e.end()}),e.test("parses semi-parsed strings",function(e){e.deepEqual(qs.parse({"a[b]":"c"}),{a:{b:"c"}}),e.deepEqual(qs.parse({"a[b]":"c","a[d]":"e"}),{a:{b:"c",d:"e"}}),e.end()}),e.test("parses buffers correctly",function(e){var a=SaferBuffer.from("test");e.deepEqual(qs.parse({a:a}),{a:a}),e.end()}),e.test("parses jquery-param strings",function(e){e.deepEqual(qs.parse("filter%5B0%5D%5B%5D=int1&filter%5B0%5D%5B%5D=%3D&filter%5B0%5D%5B%5D=77&filter%5B%5D=and&filter%5B2%5D%5B%5D=int2&filter%5B2%5D%5B%5D=%3D&filter%5B2%5D%5B%5D=8"),{filter:[["int1","=","77"],"and",["int2","=","8"]]}),e.end()}),e.test("continues parsing when no parent is found",function(e){e.deepEqual(qs.parse("[]=&a=b"),{0:"",a:"b"}),e.deepEqual(qs.parse("[]&a=b",{strictNullHandling:!0}),{0:null,a:"b"}),e.deepEqual(qs.parse("[foo]=bar"),{foo:"bar"}),e.end()}),e.test("does not error when parsing a very long array",function(e){for(var a="a[]=a";Buffer.byteLength(a)<131072;)a=a+"&"+a;e.doesNotThrow(function(){qs.parse(a)}),e.end()}),e.test("does not throw when a native prototype has an enumerable property",function(e){e.intercept(Object.prototype,"crash",{value:""}),e.intercept(Array.prototype,"crash",{value:""}),e.doesNotThrow(qs.parse.bind(null,"a=b")),e.deepEqual(qs.parse("a=b"),{a:"b"}),e.doesNotThrow(qs.parse.bind(null,"a[][b]=c")),e.deepEqual(qs.parse("a[][b]=c"),{a:[{b:"c"}]}),e.end()}),e.test("parses a string with an alternative string delimiter",function(e){e.deepEqual(qs.parse("a=b;c=d",{delimiter:";"}),{a:"b",c:"d"}),e.end()}),e.test("parses a string with an alternative RegExp delimiter",function(e){e.deepEqual(qs.parse("a=b; c=d",{delimiter:/[;,] */}),{a:"b",c:"d"}),e.end()}),e.test("does not use non-splittable objects as delimiters",function(e){e.deepEqual(qs.parse("a=b&c=d",{delimiter:!0}),{a:"b",c:"d"}),e.end()}),e.test("allows overriding parameter limit",function(e){e.deepEqual(qs.parse("a=b&c=d",{parameterLimit:1}),{a:"b"}),e.end()}),e.test("allows setting the parameter limit to Infinity",function(e){e.deepEqual(qs.parse("a=b&c=d",{parameterLimit:1/0}),{a:"b",c:"d"}),e.end()}),e.test("allows overriding array limit",function(e){e.deepEqual(qs.parse("a[0]=b",{arrayLimit:-1}),{a:{0:"b"}}),e.deepEqual(qs.parse("a[0]=b",{arrayLimit:0}),{a:["b"]}),e.deepEqual(qs.parse("a[-1]=b",{arrayLimit:-1}),{a:{"-1":"b"}}),e.deepEqual(qs.parse("a[-1]=b",{arrayLimit:0}),{a:{"-1":"b"}}),e.deepEqual(qs.parse("a[0]=b&a[1]=c",{arrayLimit:-1}),{a:{0:"b",1:"c"}}),e.deepEqual(qs.parse("a[0]=b&a[1]=c",{arrayLimit:0}),{a:{0:"b",1:"c"}}),e.end()}),e.test("allows disabling array parsing",function(e){var a=qs.parse("a[0]=b&a[1]=c",{parseArrays:!1});e.deepEqual(a,{a:{0:"b",1:"c"}}),e.equal(Array.isArray(a.a),!1,"parseArrays:false, indices case is not an array");var t=qs.parse("a[]=b",{parseArrays:!1});e.deepEqual(t,{a:{0:"b"}}),e.equal(Array.isArray(t.a),!1,"parseArrays:false, empty brackets case is not an array"),e.end()}),e.test("allows for query string prefix",function(e){e.deepEqual(qs.parse("?foo=bar",{ignoreQueryPrefix:!0}),{foo:"bar"}),e.deepEqual(qs.parse("foo=bar",{ignoreQueryPrefix:!0}),{foo:"bar"}),e.deepEqual(qs.parse("?foo=bar",{ignoreQueryPrefix:!1}),{"?foo":"bar"}),e.end()}),e.test("parses an object",function(e){var a=qs.parse({"user[name]":{"pop[bob]":3},"user[email]":null});e.deepEqual(a,{user:{name:{"pop[bob]":3},email:null}}),e.end()}),e.test("parses string with comma as array divider",function(e){e.deepEqual(qs.parse("foo=bar,tee",{comma:!0}),{foo:["bar","tee"]}),e.deepEqual(qs.parse("foo[bar]=coffee,tee",{comma:!0}),{foo:{bar:["coffee","tee"]}}),e.deepEqual(qs.parse("foo=",{comma:!0}),{foo:""}),e.deepEqual(qs.parse("foo",{comma:!0}),{foo:""}),e.deepEqual(qs.parse("foo",{comma:!0,strictNullHandling:!0}),{foo:null}),e.deepEqual(qs.parse("a[0]=c"),{a:["c"]}),e.deepEqual(qs.parse("a[]=c"),{a:["c"]}),e.deepEqual(qs.parse("a[]=c",{comma:!0}),{a:["c"]}),e.deepEqual(qs.parse("a[0]=c&a[1]=d"),{a:["c","d"]}),e.deepEqual(qs.parse("a[]=c&a[]=d"),{a:["c","d"]}),e.deepEqual(qs.parse("a=c,d",{comma:!0}),{a:["c","d"]}),e.end()}),e.test("parses values with comma as array divider",function(e){e.deepEqual(qs.parse({foo:"bar,tee"},{comma:!1}),{foo:"bar,tee"}),e.deepEqual(qs.parse({foo:"bar,tee"},{comma:!0}),{foo:["bar","tee"]}),e.end()}),e.test("use number decoder, parses string that has one number with comma option enabled",function(e){var a=function(e,a,t,o){return isNaN(Number(e))?a(e,a,t,o):parseFloat(e)};e.deepEqual(qs.parse("foo=1",{comma:!0,decoder:a}),{foo:1}),e.deepEqual(qs.parse("foo=0",{comma:!0,decoder:a}),{foo:0}),e.end()}),e.test("parses brackets holds array of arrays when having two parts of strings with comma as array divider",function(e){e.deepEqual(qs.parse("foo[]=1,2,3&foo[]=4,5,6",{comma:!0}),{foo:[["1","2","3"],["4","5","6"]]}),e.deepEqual(qs.parse("foo[]=1,2,3&foo[]=",{comma:!0}),{foo:[["1","2","3"],""]}),e.deepEqual(qs.parse("foo[]=1,2,3&foo[]=,",{comma:!0}),{foo:[["1","2","3"],["",""]]}),e.deepEqual(qs.parse("foo[]=1,2,3&foo[]=a",{comma:!0}),{foo:[["1","2","3"],"a"]}),e.end()}),e.test("parses url-encoded brackets holds array of arrays when having two parts of strings with comma as array divider",function(e){e.deepEqual(qs.parse("foo%5B%5D=1,2,3&foo%5B%5D=4,5,6",{comma:!0}),{foo:[["1","2","3"],["4","5","6"]]}),e.deepEqual(qs.parse("foo%5B%5D=1,2,3&foo%5B%5D=",{comma:!0}),{foo:[["1","2","3"],""]}),e.deepEqual(qs.parse("foo%5B%5D=1,2,3&foo%5B%5D=,",{comma:!0}),{foo:[["1","2","3"],["",""]]}),e.deepEqual(qs.parse("foo%5B%5D=1,2,3&foo%5B%5D=a",{comma:!0}),{foo:[["1","2","3"],"a"]}),e.end()}),e.test("parses comma delimited array while having percent-encoded comma treated as normal text",function(e){e.deepEqual(qs.parse("foo=a%2Cb",{comma:!0}),{foo:"a,b"}),e.deepEqual(qs.parse("foo=a%2C%20b,d",{comma:!0}),{foo:["a, b","d"]}),e.deepEqual(qs.parse("foo=a%2C%20b,c%2C%20d",{comma:!0}),{foo:["a, b","c, d"]}),e.end()}),e.test("parses an object in dot notation",function(e){var a=qs.parse({"user.name":{"pop[bob]":3},"user.email.":null},{allowDots:!0});e.deepEqual(a,{user:{name:{"pop[bob]":3},email:null}}),e.end()}),e.test("parses an object and not child values",function(e){var a=qs.parse({"user[name]":{"pop[bob]":{test:3}},"user[email]":null});e.deepEqual(a,{user:{name:{"pop[bob]":{test:3}},email:null}}),e.end()}),e.test("does not blow up when Buffer global is missing",function(e){var a=mockProperty(global,"Buffer",{delete:!0}),t=qs.parse("a=b&c=d");a(),e.deepEqual(t,{a:"b",c:"d"}),e.end()}),e.test("does not crash when parsing circular references",function(e){var a,t={};t.b=t,e.doesNotThrow(function(){a=qs.parse({"foo[bar]":"baz","foo[baz]":t})}),e.equal("foo"in a,!0,'parsed has "foo" property'),e.equal("bar"in a.foo,!0),e.equal("baz"in a.foo,!0),e.equal(a.foo.bar,"baz"),e.deepEqual(a.foo.baz,t),e.end()}),e.test("does not crash when parsing deep objects",function(e){for(var a,t="foo",o=0;o<5e3;o++)t+="[p]";t+="=bar",e.doesNotThrow(function(){a=qs.parse(t,{depth:5e3})}),e.equal("foo"in a,!0,'parsed has "foo" property');for(var r=0,s=a.foo;s=s.p;)r+=1;e.equal(r,5e3,"parsed is 5000 properties deep"),e.end()}),e.test("parses null objects correctly",{skip:!hasProto},function(e){var a={__proto__:null,b:"c"};e.deepEqual(qs.parse(a),{b:"c"});var t=qs.parse({a:a});e.equal("a"in t,!0,'result has "a" property'),e.deepEqual(t.a,a),e.end()}),e.test("parses dates correctly",function(e){var a=new Date;e.deepEqual(qs.parse({a:a}),{a:a}),e.end()}),e.test("parses regular expressions correctly",function(e){var a=/^test$/;e.deepEqual(qs.parse({a:a}),{a:a}),e.end()}),e.test("does not allow overwriting prototype properties",function(e){e.deepEqual(qs.parse("a[hasOwnProperty]=b",{allowPrototypes:!1}),{}),e.deepEqual(qs.parse("hasOwnProperty=b",{allowPrototypes:!1}),{}),e.deepEqual(qs.parse("toString",{allowPrototypes:!1}),{},'bare "toString" results in {}'),e.end()}),e.test("can allow overwriting prototype properties",function(e){e.deepEqual(qs.parse("a[hasOwnProperty]=b",{allowPrototypes:!0}),{a:{hasOwnProperty:"b"}}),e.deepEqual(qs.parse("hasOwnProperty=b",{allowPrototypes:!0}),{hasOwnProperty:"b"}),e.deepEqual(qs.parse("toString",{allowPrototypes:!0}),{toString:""},'bare "toString" results in { toString: "" }'),e.end()}),e.test("does not crash when the global Object prototype is frozen",{skip:!hasPropertyDescriptors||!hasOverrideMistake},function(e){var a;e.teardown(mockProperty(Object.prototype,"frozenProp",{value:"foo",nonWritable:!0,nonEnumerable:!0})),e.throws(function(){},/^TypeError: Cannot assign to read only property 'frozenProp' of (?:object '#<Object>'|#<Object>)/,"regular assignment of an inherited non-writable property throws"),e.doesNotThrow(function(){a=qs.parse("frozenProp",{allowPrototypes:!1})},"parsing a nonwritable Object.prototype property does not throw"),e.deepEqual(a,{},'bare "frozenProp" results in {}'),e.end()}),e.test("params starting with a closing bracket",function(e){e.deepEqual(qs.parse("]=toString"),{"]":"toString"}),e.deepEqual(qs.parse("]]=toString"),{"]]":"toString"}),e.deepEqual(qs.parse("]hello]=toString"),{"]hello]":"toString"}),e.end()}),e.test("params starting with a starting bracket",function(e){e.deepEqual(qs.parse("[=toString"),{"[":"toString"}),e.deepEqual(qs.parse("[[=toString"),{"[[":"toString"}),e.deepEqual(qs.parse("[hello[=toString"),{"[hello[":"toString"}),e.end()}),e.test("add keys to objects",function(e){e.deepEqual(qs.parse("a[b]=c&a=d"),{a:{b:"c",d:!0}},"can add keys to objects"),e.deepEqual(qs.parse("a[b]=c&a=toString"),{a:{b:"c"}},"can not overwrite prototype"),e.deepEqual(qs.parse("a[b]=c&a=toString",{allowPrototypes:!0}),{a:{b:"c",toString:!0}},"can overwrite prototype with allowPrototypes true"),e.deepEqual(qs.parse("a[b]=c&a=toString",{plainObjects:!0}),{__proto__:null,a:{__proto__:null,b:"c",toString:!0}},"can overwrite prototype with plainObjects true"),e.end()}),e.test("dunder proto is ignored",function(e){var a="categories[__proto__]=login&categories[__proto__]&categories[length]=42",t=qs.parse(a,{allowPrototypes:!0});e.deepEqual(t,{categories:{length:"42"}},"silent [[Prototype]] payload");var o=qs.parse(a,{allowPrototypes:!0,plainObjects:!0});e.deepEqual(o,{__proto__:null,categories:{__proto__:null,length:"42"}},"silent [[Prototype]] payload: plain objects");var r=qs.parse("categories[__proto__]=cats&categories[__proto__]=dogs&categories[some][json]=toInject",{allowPrototypes:!0});e.notOk(Array.isArray(r.categories),"is not an array"),e.notOk(r.categories instanceof Array,"is not instanceof an array"),e.deepEqual(r.categories,{some:{json:"toInject"}}),e.equal(JSON.stringify(r.categories),'{"some":{"json":"toInject"}}',"stringifies as a non-array"),e.deepEqual(qs.parse("foo[__proto__][hidden]=value&foo[bar]=stuffs",{allowPrototypes:!0}),{foo:{bar:"stuffs"}},"hidden values"),e.deepEqual(qs.parse("foo[__proto__][hidden]=value&foo[bar]=stuffs",{allowPrototypes:!0,plainObjects:!0}),{__proto__:null,foo:{__proto__:null,bar:"stuffs"}},"hidden values: plain objects"),e.end()}),e.test("can return null objects",{skip:!hasProto},function(e){e.deepEqual(qs.parse("a[b]=c&a[hasOwnProperty]=d",{plainObjects:!0}),{__proto__:null,a:{__proto__:null,b:"c",hasOwnProperty:"d"}}),e.deepEqual(qs.parse(null,{plainObjects:!0}),{__proto__:null});e.deepEqual(qs.parse("a[]=b&a[c]=d",{plainObjects:!0}),{__proto__:null,a:{__proto__:null,0:"b",c:"d"}}),e.end()}),e.test("can parse with custom encoding",function(e){e.deepEqual(qs.parse("%8c%a7=%91%e5%8d%e3%95%7b",{decoder:function(e){for(var a=/%([0-9A-F]{2})/gi,t=[],o=a.exec(e);o;)t.push(parseInt(o[1],16)),o=a.exec(e);return String(iconv.decode(SaferBuffer.from(t),"shift_jis"))}}),{"県":"大阪府"}),e.end()}),e.test("receives the default decoder as a second argument",function(e){e.plan(1),qs.parse("a",{decoder:function(a,t){e.equal(t,utils.decode)}}),e.end()}),e.test("throws error with wrong decoder",function(e){e.throws(function(){qs.parse({},{decoder:"string"})},new TypeError("Decoder has to be a function.")),e.end()}),e.test("does not mutate the options argument",function(e){var a={};qs.parse("a[b]=true",a),e.deepEqual(a,{}),e.end()}),e.test("throws if an invalid charset is specified",function(e){e.throws(function(){qs.parse("a=b",{charset:"foobar"})},new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined")),e.end()}),e.test("parses an iso-8859-1 string if asked to",function(e){e.deepEqual(qs.parse("%A2=%BD",{charset:"iso-8859-1"}),{"¢":"½"}),e.end()});var a="%E2%9C%93",t="%C3%B8",o="%26%2310003%3B",r="%26%239786%3B";e.test("prefers an utf-8 charset specified by the utf8 sentinel to a default charset of iso-8859-1",function(e){e.deepEqual(qs.parse("utf8="+a+"&"+t+"="+t,{charsetSentinel:!0,charset:"iso-8859-1"}),{"ø":"ø"}),e.end()}),e.test("prefers an iso-8859-1 charset specified by the utf8 sentinel to a default charset of utf-8",function(e){e.deepEqual(qs.parse("utf8="+o+"&"+t+"="+t,{charsetSentinel:!0,charset:"utf-8"}),{"Ã¸":"Ã¸"}),e.end()}),e.test("does not require the utf8 sentinel to be defined before the parameters whose decoding it affects",function(e){e.deepEqual(qs.parse("a="+t+"&utf8="+o,{charsetSentinel:!0,charset:"utf-8"}),{a:"Ã¸"}),e.end()}),e.test("ignores an utf8 sentinel with an unknown value",function(e){e.deepEqual(qs.parse("utf8=foo&"+t+"="+t,{charsetSentinel:!0,charset:"utf-8"}),{"ø":"ø"}),e.end()}),e.test("uses the utf8 sentinel to switch to utf-8 when no default charset is given",function(e){e.deepEqual(qs.parse("utf8="+a+"&"+t+"="+t,{charsetSentinel:!0}),{"ø":"ø"}),e.end()}),e.test("uses the utf8 sentinel to switch to iso-8859-1 when no default charset is given",function(e){e.deepEqual(qs.parse("utf8="+o+"&"+t+"="+t,{charsetSentinel:!0}),{"Ã¸":"Ã¸"}),e.end()}),e.test("interprets numeric entities in iso-8859-1 when `interpretNumericEntities`",function(e){e.deepEqual(qs.parse("foo="+r,{charset:"iso-8859-1",interpretNumericEntities:!0}),{foo:"☺"}),e.end()}),e.test("handles a custom decoder returning `null`, in the `iso-8859-1` charset, when `interpretNumericEntities`",function(e){e.deepEqual(qs.parse("foo=&bar="+r,{charset:"iso-8859-1",decoder:function(e,a,t){return e?a(e,a,t):null},interpretNumericEntities:!0}),{foo:null,bar:"☺"}),e.end()}),e.test("does not interpret numeric entities in iso-8859-1 when `interpretNumericEntities` is absent",function(e){e.deepEqual(qs.parse("foo="+r,{charset:"iso-8859-1"}),{foo:"&#9786;"}),e.end()}),e.test("does not interpret numeric entities when the charset is utf-8, even when `interpretNumericEntities`",function(e){e.deepEqual(qs.parse("foo="+r,{charset:"utf-8",interpretNumericEntities:!0}),{foo:"&#9786;"}),e.end()}),e.test("interpretNumericEntities with comma:true and iso charset does not crash",function(e){e.deepEqual(qs.parse("b&a[]=1,"+r,{comma:!0,charset:"iso-8859-1",interpretNumericEntities:!0}),{b:"",a:["1,☺"]}),e.end()}),e.test("does not interpret %uXXXX syntax in iso-8859-1 mode",function(e){e.deepEqual(qs.parse("%u263A=%u263A",{charset:"iso-8859-1"}),{"%u263A":"%u263A"}),e.end()}),e.test("allows for decoding keys and values differently",function(e){e.deepEqual(qs.parse("KeY=vAlUe",{decoder:function(e,a,t,o){if("key"===o)return a(e,a,t,o).toLowerCase();if("value"===o)return a(e,a,t,o).toUpperCase();throw"this should never happen! type: "+o}}),{key:"VALUE"}),e.end()}),e.test("parameter limit tests",function(e){e.test("does not throw error when within parameter limit",function(e){var a=qs.parse("a=1&b=2&c=3",{parameterLimit:5,throwOnLimitExceeded:!0});e.deepEqual(a,{a:"1",b:"2",c:"3"},"parses without errors"),e.end()}),e.test("throws error when throwOnLimitExceeded is present but not boolean",function(e){e.throws(function(){qs.parse("a=1&b=2&c=3&d=4&e=5&f=6",{parameterLimit:3,throwOnLimitExceeded:"true"})},new TypeError("`throwOnLimitExceeded` option must be a boolean"),"throws error when throwOnLimitExceeded is present and not boolean"),e.end()}),e.test("throws error when parameter limit exceeded",function(e){e.throws(function(){qs.parse("a=1&b=2&c=3&d=4&e=5&f=6",{parameterLimit:3,throwOnLimitExceeded:!0})},new RangeError("Parameter limit exceeded. Only 3 parameters allowed."),"throws error when parameter limit is exceeded"),e.end()}),e.test("silently truncates when throwOnLimitExceeded is not given",function(e){var a=qs.parse("a=1&b=2&c=3&d=4&e=5",{parameterLimit:3});e.deepEqual(a,{a:"1",b:"2",c:"3"},"parses and truncates silently"),e.end()}),e.test("silently truncates when parameter limit exceeded without error",function(e){var a=qs.parse("a=1&b=2&c=3&d=4&e=5",{parameterLimit:3,throwOnLimitExceeded:!1});e.deepEqual(a,{a:"1",b:"2",c:"3"},"parses and truncates silently"),e.end()}),e.test("allows unlimited parameters when parameterLimit set to Infinity",function(e){var a=qs.parse("a=1&b=2&c=3&d=4&e=5&f=6",{parameterLimit:1/0});e.deepEqual(a,{a:"1",b:"2",c:"3",d:"4",e:"5",f:"6"},"parses all parameters without truncation"),e.end()}),e.end()}),e.test("array limit tests",function(e){e.test("does not throw error when array is within limit",function(e){var a=qs.parse("a[]=1&a[]=2&a[]=3",{arrayLimit:5,throwOnLimitExceeded:!0});e.deepEqual(a,{a:["1","2","3"]},"parses array without errors"),e.end()}),e.test("throws error when throwOnLimitExceeded is present but not boolean for array limit",function(e){e.throws(function(){qs.parse("a[]=1&a[]=2&a[]=3&a[]=4",{arrayLimit:3,throwOnLimitExceeded:"true"})},new TypeError("`throwOnLimitExceeded` option must be a boolean"),"throws error when throwOnLimitExceeded is present and not boolean for array limit"),e.end()}),e.test("throws error when array limit exceeded",function(e){e.throws(function(){qs.parse("a[]=1&a[]=2&a[]=3&a[]=4",{arrayLimit:3,throwOnLimitExceeded:!0})},new RangeError("Array limit exceeded. Only 3 elements allowed in an array."),"throws error when array limit is exceeded"),e.end()}),e.test("converts array to object if length is greater than limit",function(e){var a=qs.parse("a[1]=1&a[2]=2&a[3]=3&a[4]=4&a[5]=5&a[6]=6",{arrayLimit:5});e.deepEqual(a,{a:{1:"1",2:"2",3:"3",4:"4",5:"5",6:"6"}},"parses into object if array length is greater than limit"),e.end()}),e.end()}),e.end()}),test("parses empty keys",function(e){emptyTestCases.forEach(function(a){e.test("skips empty string key with "+a.input,function(e){e.deepEqual(qs.parse(a.input),a.noEmptyKeys),e.end()})})}),test("`duplicates` option",function(e){v.nonStrings.concat("not a valid option").forEach(function(a){void 0!==a&&e.throws(function(){qs.parse("",{duplicates:a})},TypeError,"throws on invalid option: "+inspect(a))}),e.deepEqual(qs.parse("foo=bar&foo=baz"),{foo:["bar","baz"]},"duplicates: default, combine"),e.deepEqual(qs.parse("foo=bar&foo=baz",{duplicates:"combine"}),{foo:["bar","baz"]},"duplicates: combine"),e.deepEqual(qs.parse("foo=bar&foo=baz",{duplicates:"first"}),{foo:"bar"},"duplicates: first"),e.deepEqual(qs.parse("foo=bar&foo=baz",{duplicates:"last"}),{foo:"baz"},"duplicates: last"),e.end()}),test("qs strictDepth option - throw cases",function(e){e.test("throws an exception when depth exceeds the limit with strictDepth: true",function(e){e.throws(function(){qs.parse("a[b][c][d][e][f][g][h][i]=j",{depth:1,strictDepth:!0})},RangeError,"throws RangeError"),e.end()}),e.test("throws an exception for multiple nested arrays with strictDepth: true",function(e){e.throws(function(){qs.parse("a[0][1][2][3][4]=b",{depth:3,strictDepth:!0})},RangeError,"throws RangeError"),e.end()}),e.test("throws an exception for nested objects and arrays with strictDepth: true",function(e){e.throws(function(){qs.parse("a[b][c][0][d][e]=f",{depth:3,strictDepth:!0})},RangeError,"throws RangeError"),e.end()}),e.test("throws an exception for different types of values with strictDepth: true",function(e){e.throws(function(){qs.parse("a[b][c][d][e]=true&a[b][c][d][f]=42",{depth:3,strictDepth:!0})},RangeError,"throws RangeError"),e.end()})}),test("qs strictDepth option - non-throw cases",function(e){e.test("when depth is 0 and strictDepth true, do not throw",function(e){e.doesNotThrow(function(){qs.parse("a[b][c][d][e]=true&a[b][c][d][f]=42",{depth:0,strictDepth:!0})},RangeError,"does not throw RangeError"),e.end()}),e.test("parses successfully when depth is within the limit with strictDepth: true",function(e){e.doesNotThrow(function(){var a=qs.parse("a[b]=c",{depth:1,strictDepth:!0});e.deepEqual(a,{a:{b:"c"}},"parses correctly")}),e.end()}),e.test("does not throw an exception when depth exceeds the limit with strictDepth: false",function(e){e.doesNotThrow(function(){var a=qs.parse("a[b][c][d][e][f][g][h][i]=j",{depth:1});e.deepEqual(a,{a:{b:{"[c][d][e][f][g][h][i]":"j"}}},"parses with depth limit")}),e.end()}),e.test("parses successfully when depth is within the limit with strictDepth: false",function(e){e.doesNotThrow(function(){var a=qs.parse("a[b]=c",{depth:1});e.deepEqual(a,{a:{b:"c"}},"parses correctly")}),e.end()}),e.test("does not throw when depth is exactly at the limit with strictDepth: true",function(e){e.doesNotThrow(function(){var a=qs.parse("a[b][c]=d",{depth:2,strictDepth:!0});e.deepEqual(a,{a:{b:{c:"d"}}},"parses correctly")}),e.end()})});