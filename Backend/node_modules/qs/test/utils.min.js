"use strict";var test=require("tape"),inspect=require("object-inspect"),SaferBuffer=require("safer-buffer").Buffer,forEach=require("for-each"),v=require("es-value-fixtures"),utils=require("../lib/utils");test("merge()",function(e){e.deepEqual(utils.merge(null,!0),[null,!0],"merges true into null"),e.deepEqual(utils.merge(null,[42]),[null,42],"merges null into an array"),e.deepEqual(utils.merge({a:"b"},{a:"c"}),{a:["b","c"]},"merges two objects with the same key");var a=utils.merge({foo:"bar"},{foo:{first:"123"}});e.deepEqual(a,{foo:["bar",{first:"123"}]},"merges a standalone and an object into an array");var n=utils.merge({foo:["bar",{first:"123"}]},{foo:{second:"456"}});e.deepEqual(n,{foo:{0:"bar",1:{first:"123"},second:"456"}},"merges a standalone and two objects into an array");var t=utils.merge({foo:["bar",{first:"123",second:"456"}]},{foo:"baz"});e.deepEqual(t,{foo:["bar",{first:"123",second:"456"},"baz"]},"merges an object sandwiched by two standalones into an array");var r=utils.merge({foo:["baz"]},{foo:["bar","xyzzy"]});e.deepEqual(r,{foo:["baz","bar","xyzzy"]});var o=utils.merge({foo:"baz"},"bar");e.deepEqual(o,{foo:"baz",bar:!0});var u=function(){};e.deepEqual(utils.merge(u,{foo:"bar"}),[u,{foo:"bar"}],"functions can not be merged into"),u.bar="baz",e.deepEqual(utils.merge({foo:"bar"},u),{foo:"bar",bar:"baz"},"functions can be merge sources"),e.test("avoids invoking array setters unnecessarily",{skip:"function"!=typeof Object.defineProperty},function(e){var a=0,n=0,t=[];Object.defineProperty(t,0,{get:function(){return n+=1,{bar:"baz"}},set:function(){a+=1}}),utils.merge(t,[null]),e.equal(a,0),e.equal(n,1),t[0]=t[0],e.equal(a,1),e.equal(n,2),e.end()}),e.end()}),test("assign()",function(e){var a={a:1,b:2},n={b:3,c:4},t=utils.assign(a,n);e.equal(t,a,"returns the target"),e.deepEqual(a,{a:1,b:3,c:4},"target and source are merged"),e.deepEqual(n,{b:3,c:4},"source is untouched"),e.end()}),test("combine()",function(e){e.test("both arrays",function(e){var a=[1],n=[2],t=utils.combine(a,n);e.deepEqual(a,[1],"a is not mutated"),e.deepEqual(n,[2],"b is not mutated"),e.notEqual(a,t,"a !== combined"),e.notEqual(n,t,"b !== combined"),e.deepEqual(t,[1,2],"combined is a + b"),e.end()}),e.test("one array, one non-array",function(e){var a=[1],n=[2],t=utils.combine(1,n);e.deepEqual(n,[2],"b is not mutated"),e.notEqual(1,t,"aN + b !== aN"),e.notEqual(a,t,"aN + b !== a"),e.notEqual(2,t,"aN + b !== bN"),e.notEqual(n,t,"aN + b !== b"),e.deepEqual([1,2],t,"first argument is array-wrapped when not an array");var r=utils.combine(a,2);e.deepEqual(a,[1],"a is not mutated"),e.notEqual(1,r,"a + bN !== aN"),e.notEqual(a,r,"a + bN !== a"),e.notEqual(2,r,"a + bN !== bN"),e.notEqual(n,r,"a + bN !== b"),e.deepEqual([1,2],r,"second argument is array-wrapped when not an array"),e.end()}),e.test("neither is an array",function(e){var a=utils.combine(1,2);e.notEqual(1,a,"1 + 2 !== 1"),e.notEqual(2,a,"1 + 2 !== 2"),e.deepEqual([1,2],a,"both arguments are array-wrapped when not an array"),e.end()}),e.end()}),test("decode",function(e){e.equal(utils.decode("a+b"),"a b","decodes + to space"),e.equal(utils.decode("name%2Eobj"),"name.obj","decodes a string"),e.equal(utils.decode("name%2Eobj%2Efoo",null,"iso-8859-1"),"name.obj.foo","decodes a string in iso-8859-1"),e.end()}),test("encode",function(e){forEach(v.nullPrimitives,function(a){e.throws(function(){utils.encode(a)},TypeError,inspect(a)+" is not a string")}),e.equal(utils.encode(""),"","empty string returns itself"),e.deepEqual(utils.encode([]),[],"empty array returns itself"),e.deepEqual(utils.encode({length:0}),{length:0},"empty arraylike returns itself"),e.test("symbols",{skip:!v.hasSymbols},function(e){e.equal(utils.encode(Symbol("x")),"Symbol%28x%29","symbol is encoded"),e.end()}),e.equal(utils.encode("(abc)"),"%28abc%29","encodes parentheses"),e.equal(utils.encode({toString:function(){return"(abc)"}}),"%28abc%29","toStrings and encodes parentheses"),e.equal(utils.encode("abc 123 ðŸ’©",null,"iso-8859-1"),"abc%20123%20%26%2355357%3B%26%2356489%3B","encodes in iso-8859-1");for(var a="",n="",t=0;t<1500;t++)a+=" ",n+="%20";e.equal(utils.encode(a),n,"encodes a long string"),e.equal(utils.encode("()"),"%28%29","encodes parens normally"),e.equal(utils.encode("()",null,null,null,"RFC1738"),"()","does not encode parens in RFC1738"),e.equal(utils.encode("Ä€á€€ï¤€"),"%C4%80%E1%80%80%EF%A4%80","encodes multibyte chars"),e.equal(utils.encode("\ud83d \udca9"),"%F0%9F%90%A0%F0%BA%90%80","encodes lone surrogates"),e.end()}),test("isBuffer()",function(e){forEach([null,void 0,!0,!1,"","abc",42,0,NaN,{},[],function(){},/a/g],function(a){e.equal(utils.isBuffer(a),!1,inspect(a)+" is not a buffer")});var a={constructor:Buffer};e.equal(utils.isBuffer(a),!1,"fake buffer is not a buffer");var n=SaferBuffer.from("abc");e.equal(utils.isBuffer(n),!0,"SaferBuffer instance is a buffer");var t=Buffer.from&&Buffer.alloc?Buffer.from("abc"):new Buffer("abc");e.equal(utils.isBuffer(t),!0,"real Buffer instance is a buffer"),e.end()}),test("isRegExp()",function(e){e.equal(utils.isRegExp(/a/g),!0,"RegExp is a RegExp"),e.equal(utils.isRegExp(new RegExp("a","g")),!0,"new RegExp is a RegExp"),e.equal(utils.isRegExp(new Date),!1,"Date is not a RegExp"),forEach(v.primitives,function(a){e.equal(utils.isRegExp(a),!1,inspect(a)+" is not a RegExp")}),e.end()});