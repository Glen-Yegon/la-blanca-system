var url=require("url"),URL=url.URL,http=require("http"),https=require("https"),Writable=require("stream").Writable,assert=require("assert"),debug=require("./debug");!function(){var e="undefined"!=typeof process,t="undefined"!=typeof window&&"undefined"!=typeof document,r=isFunction(Error.captureStackTrace);e||!t&&r||console.warn("The follow-redirects package should be excluded from browser builds.")}();var useNativeURL=!1;try{assert(new URL(""))}catch(e){useNativeURL="ERR_INVALID_URL"===e.code}var preservedUrlFields=["auth","host","hostname","href","path","pathname","port","protocol","query","search","hash"],events=["abort","aborted","connect","error","socket","timeout"],eventHandlers=Object.create(null);events.forEach(function(e){eventHandlers[e]=function(t,r,o){this._redirectable.emit(e,t,r,o)}});var InvalidUrlError=createErrorType("ERR_INVALID_URL","Invalid URL",TypeError),RedirectionError=createErrorType("ERR_FR_REDIRECTION_FAILURE","Redirected request failed"),TooManyRedirectsError=createErrorType("ERR_FR_TOO_MANY_REDIRECTS","Maximum number of redirects exceeded",RedirectionError),MaxBodyLengthExceededError=createErrorType("ERR_FR_MAX_BODY_LENGTH_EXCEEDED","Request body larger than maxBodyLength limit"),WriteAfterEndError=createErrorType("ERR_STREAM_WRITE_AFTER_END","write after end"),destroy=Writable.prototype.destroy||noop;function RedirectableRequest(e,t){Writable.call(this),this._sanitizeOptions(e),this._options=e,this._ended=!1,this._ending=!1,this._redirectCount=0,this._redirects=[],this._requestBodyLength=0,this._requestBodyBuffers=[],t&&this.on("response",t);var r=this;this._onNativeResponse=function(e){try{r._processResponse(e)}catch(e){r.emit("error",e instanceof RedirectionError?e:new RedirectionError({cause:e}))}},this._performRequest()}function wrap(e){var t={maxRedirects:21,maxBodyLength:10485760},r={};return Object.keys(e).forEach(function(o){var s=o+":",i=r[s]=e[o],n=t[o]=Object.create(i);Object.defineProperties(n,{request:{value:function(e,o,i){return isURL(e)?e=spreadUrlObject(e):isString(e)?e=spreadUrlObject(parseUrl(e)):(i=o,o=validateUrl(e),e={protocol:s}),isFunction(o)&&(i=o,o=null),(o=Object.assign({maxRedirects:t.maxRedirects,maxBodyLength:t.maxBodyLength},e,o)).nativeProtocols=r,isString(o.host)||isString(o.hostname)||(o.hostname="::1"),assert.equal(o.protocol,s,"protocol mismatch"),debug("options",o),new RedirectableRequest(o,i)},configurable:!0,enumerable:!0,writable:!0},get:{value:function(e,t,r){var o=n.request(e,t,r);return o.end(),o},configurable:!0,enumerable:!0,writable:!0}})}),t}function noop(){}function parseUrl(e){var t;if(useNativeURL)t=new URL(e);else if(!isString((t=validateUrl(url.parse(e))).protocol))throw new InvalidUrlError({input:e});return t}function resolveUrl(e,t){return useNativeURL?new URL(e,t):parseUrl(url.resolve(t,e))}function validateUrl(e){if(/^\[/.test(e.hostname)&&!/^\[[:0-9a-f]+\]$/i.test(e.hostname))throw new InvalidUrlError({input:e.href||e});if(/^\[/.test(e.host)&&!/^\[[:0-9a-f]+\](:\d+)?$/i.test(e.host))throw new InvalidUrlError({input:e.href||e});return e}function spreadUrlObject(e,t){var r=t||{};for(var o of preservedUrlFields)r[o]=e[o];return r.hostname.startsWith("[")&&(r.hostname=r.hostname.slice(1,-1)),""!==r.port&&(r.port=Number(r.port)),r.path=r.search?r.pathname+r.search:r.pathname,r}function removeMatchingHeaders(e,t){var r;for(var o in t)e.test(o)&&(r=t[o],delete t[o]);return null==r?void 0:String(r).trim()}function createErrorType(e,t,r){function o(r){isFunction(Error.captureStackTrace)&&Error.captureStackTrace(this,this.constructor),Object.assign(this,r||{}),this.code=e,this.message=this.cause?t+": "+this.cause.message:t}return o.prototype=new(r||Error),Object.defineProperties(o.prototype,{constructor:{value:o,enumerable:!1},name:{value:"Error ["+e+"]",enumerable:!1}}),o}function destroyRequest(e,t){for(var r of events)e.removeListener(r,eventHandlers[r]);e.on("error",noop),e.destroy(t)}function isSubdomain(e,t){assert(isString(e)&&isString(t));var r=e.length-t.length-1;return r>0&&"."===e[r]&&e.endsWith(t)}function isString(e){return"string"==typeof e||e instanceof String}function isFunction(e){return"function"==typeof e}function isBuffer(e){return"object"==typeof e&&"length"in e}function isURL(e){return URL&&e instanceof URL}RedirectableRequest.prototype=Object.create(Writable.prototype),RedirectableRequest.prototype.abort=function(){destroyRequest(this._currentRequest),this._currentRequest.abort(),this.emit("abort")},RedirectableRequest.prototype.destroy=function(e){return destroyRequest(this._currentRequest,e),destroy.call(this,e),this},RedirectableRequest.prototype.write=function(e,t,r){if(this._ending)throw new WriteAfterEndError;if(!isString(e)&&!isBuffer(e))throw new TypeError("data should be a string, Buffer or Uint8Array");isFunction(t)&&(r=t,t=null),0!==e.length?this._requestBodyLength+e.length<=this._options.maxBodyLength?(this._requestBodyLength+=e.length,this._requestBodyBuffers.push({data:e,encoding:t}),this._currentRequest.write(e,t,r)):(this.emit("error",new MaxBodyLengthExceededError),this.abort()):r&&r()},RedirectableRequest.prototype.end=function(e,t,r){if(isFunction(e)?(r=e,e=t=null):isFunction(t)&&(r=t,t=null),e){var o=this,s=this._currentRequest;this.write(e,t,function(){o._ended=!0,s.end(null,null,r)}),this._ending=!0}else this._ended=this._ending=!0,this._currentRequest.end(null,null,r)},RedirectableRequest.prototype.setHeader=function(e,t){this._options.headers[e]=t,this._currentRequest.setHeader(e,t)},RedirectableRequest.prototype.removeHeader=function(e){delete this._options.headers[e],this._currentRequest.removeHeader(e)},RedirectableRequest.prototype.setTimeout=function(e,t){var r=this;function o(t){t.setTimeout(e),t.removeListener("timeout",t.destroy),t.addListener("timeout",t.destroy)}function s(t){r._timeout&&clearTimeout(r._timeout),r._timeout=setTimeout(function(){r.emit("timeout"),i()},e),o(t)}function i(){r._timeout&&(clearTimeout(r._timeout),r._timeout=null),r.removeListener("abort",i),r.removeListener("error",i),r.removeListener("response",i),r.removeListener("close",i),t&&r.removeListener("timeout",t),r.socket||r._currentRequest.removeListener("socket",s)}return t&&this.on("timeout",t),this.socket?s(this.socket):this._currentRequest.once("socket",s),this.on("socket",o),this.on("abort",i),this.on("error",i),this.on("response",i),this.on("close",i),this},["flushHeaders","getHeader","setNoDelay","setSocketKeepAlive"].forEach(function(e){RedirectableRequest.prototype[e]=function(t,r){return this._currentRequest[e](t,r)}}),["aborted","connection","socket"].forEach(function(e){Object.defineProperty(RedirectableRequest.prototype,e,{get:function(){return this._currentRequest[e]}})}),RedirectableRequest.prototype._sanitizeOptions=function(e){if(e.headers||(e.headers={}),e.host&&(e.hostname||(e.hostname=e.host),delete e.host),!e.pathname&&e.path){var t=e.path.indexOf("?");t<0?e.pathname=e.path:(e.pathname=e.path.substring(0,t),e.search=e.path.substring(t))}},RedirectableRequest.prototype._performRequest=function(){var e=this._options.protocol,t=this._options.nativeProtocols[e];if(!t)throw new TypeError("Unsupported protocol "+e);if(this._options.agents){var r=e.slice(0,-1);this._options.agent=this._options.agents[r]}var o=this._currentRequest=t.request(this._options,this._onNativeResponse);for(var s of(o._redirectable=this,events))o.on(s,eventHandlers[s]);if(this._currentUrl=/^\//.test(this._options.path)?url.format(this._options):this._options.path,this._isRedirect){var i=0,n=this,a=this._requestBodyBuffers;!function e(t){if(o===n._currentRequest)if(t)n.emit("error",t);else if(i<a.length){var r=a[i++];o.finished||o.write(r.data,r.encoding,e)}else n._ended&&o.end()}()}},RedirectableRequest.prototype._processResponse=function(e){var t=e.statusCode;this._options.trackRedirects&&this._redirects.push({url:this._currentUrl,headers:e.headers,statusCode:t});var r,o=e.headers.location;if(!o||!1===this._options.followRedirects||t<300||t>=400)return e.responseUrl=this._currentUrl,e.redirects=this._redirects,this.emit("response",e),void(this._requestBodyBuffers=[]);if(destroyRequest(this._currentRequest),e.destroy(),++this._redirectCount>this._options.maxRedirects)throw new TooManyRedirectsError;var s=this._options.beforeRedirect;s&&(r=Object.assign({Host:e.req.getHeader("host")},this._options.headers));var i=this._options.method;((301===t||302===t)&&"POST"===this._options.method||303===t&&!/^(?:GET|HEAD)$/.test(this._options.method))&&(this._options.method="GET",this._requestBodyBuffers=[],removeMatchingHeaders(/^content-/i,this._options.headers));var n=removeMatchingHeaders(/^host$/i,this._options.headers),a=parseUrl(this._currentUrl),u=n||a.host,c=/^\w+:/.test(o)?this._currentUrl:url.format(Object.assign(a,{host:u})),h=resolveUrl(o,c);if(debug("redirecting to",h.href),this._isRedirect=!0,spreadUrlObject(h,this._options),(h.protocol!==a.protocol&&"https:"!==h.protocol||h.host!==u&&!isSubdomain(h.host,u))&&removeMatchingHeaders(/^(?:(?:proxy-)?authorization|cookie)$/i,this._options.headers),isFunction(s)){var d={headers:e.headers,statusCode:t},p={url:c,method:i,headers:r};s(this._options,d,p),this._sanitizeOptions(this._options)}this._performRequest()},module.exports=wrap({http:http,https:https}),module.exports.wrap=wrap;