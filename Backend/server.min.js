const express=require("express"),axios=require("axios"),bodyParser=require("body-parser"),cors=require("cors");require("dotenv").config();const app=express();app.use(cors()),app.use(bodyParser.json());const consumerKey=process.env.CONSUMER_KEY,consumerSecret=process.env.CONSUMER_SECRET,shortcode=process.env.SHORTCODE,lipaNaMpesaOnlinePasskey=process.env.PASSKEY,callbackUrl=process.env.CALLBACK_URL,payments={};async function getAccessToken(){console.log("Generating access token...");const e=Buffer.from(`${consumerKey}:${consumerSecret}`).toString("base64"),s=await axios.get("https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials",{headers:{Authorization:`Basic ${e}`}});return console.log("Access token generated:",s.data.access_token),s.data.access_token}app.post("/stkpush",async(e,s)=>{try{const{phone:o,amount:t,accountReference:a,customerName:n}=e.body;console.log("Received STK Push request:",e.body);const c=await getAccessToken(),r=(new Date).toISOString().replace(/[-T:Z.]/g,"").slice(0,14),u=Buffer.from(shortcode+lipaNaMpesaOnlinePasskey+r).toString("base64"),l={BusinessShortCode:shortcode,Password:u,Timestamp:r,TransactionType:"CustomerPayBillOnline",Amount:t,PartyA:o,PartyB:shortcode,PhoneNumber:o,CallBackURL:callbackUrl,AccountReference:a,TransactionDesc:`Payment for carwash by ${n}`};console.log("Sending STK Push payload to Daraja:",l);const p=await axios.post("https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest",l,{headers:{Authorization:`Bearer ${c}`}});console.log("Daraja STK Push response:",p.data);const m=p.data.CheckoutRequestID;console.log("CheckoutRequestID:",m),payments[m]={status:"pending",phone:o,amount:t,customerName:n,accountReference:a},console.log("Payment saved in-memory as pending:",payments[m]),s.json({success:!0,checkoutRequestId:m})}catch(e){console.error("Error sending STK Push:",e.response?.data||e.message),s.json({success:!1,message:"Error sending STK Push"})}}),app.post("/mpesa-callback",(e,s)=>{try{console.log("Received STK callback:",JSON.stringify(e.body,null,2));const o=e.body.Body.stkCallback,t=o.CheckoutRequestID;if(0===Number(o.ResultCode)){const e=o.CallbackMetadata?.Item?.find(e=>"Amount"===e.Name),a=o.CallbackMetadata?.Item?.find(e=>"PhoneNumber"===e.Name),n=o.CallbackMetadata?.Item?.find(e=>"MpesaReceiptNumber"===e.Name),c=e?e.Value:0,r=a?a.Value:"Unknown",u=n?n.Value:"Unknown";console.log(`Payment SUCCESS for ${t}: Phone ${r}, Amount ${c}, Receipt ${u}`),payments[t]?(payments[t].status="completed",payments[t].receipt=u,payments[t].amount=c,console.log("Updated in-memory payment store:",payments[t])):console.warn("CheckoutRequestID not found in in-memory store:",t),s.status(200).json({ResultCode:0,ResultDesc:"Success"})}else console.log(`Payment FAILED for ${t}:`,o),payments[t]&&(payments[t].status="failed",console.log("Updated in-memory payment store as failed:",payments[t])),s.status(200).json({ResultCode:0,ResultDesc:"Received"})}catch(e){console.error("Error handling STK callback:",e),s.status(500).json({ResultCode:1,ResultDesc:"Error"})}}),app.get("/payment-status/:checkoutRequestId",(e,s)=>{const o=e.params.checkoutRequestId,t=payments[o];if(console.log("Checking payment status for:",o,t),!t)return s.json({success:!1,message:"Payment not found"});s.json({success:!0,status:t.status,phone:t.phone,amount:t.amount})});const PORT=3e3;app.listen(3e3,()=>console.log("Server running on port 3000"));