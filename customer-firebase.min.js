import{auth,db,signInWithEmailAndPassword,signOut,onAuthStateChanged,addDoc,setDoc,collection,serverTimestamp,onSnapshot,query,where,orderBy,doc,updateDoc}from"./firebase-config.js";const addBtn=document.getElementById("addBtn"),addForm=document.getElementById("addForm"),customerForm=document.getElementById("customerForm"),cancelBtn=document.getElementById("cancelBtn"),services=document.querySelectorAll(".service"),totalEl=document.getElementById("total"),cardsContainer=document.getElementById("cardsContainer"),loader=document.getElementById("loader"),receiptModal=document.getElementById("receiptModal"),closeReceipt=document.getElementById("closeReceipt"),closeReceiptBtn=document.getElementById("closeReceiptBtn"),r_jobid=document.getElementById("r_jobid"),r_plate=document.getElementById("r_plate"),r_model=document.getElementById("r_model"),r_color=document.getElementById("r_color"),r_phone=document.getElementById("r_phone"),r_services=document.getElementById("r_services"),r_assigned=document.getElementById("r_assigned"),r_total=document.getElementById("r_total"),takeJobBtn=document.getElementById("takeJobBtn"),confirmAssignBtn=document.getElementById("confirmAssignBtn"),takeStaffSelect=document.getElementById("takeStaffSelect"),signinModal=document.getElementById("signinModal"),signinForm=document.getElementById("signinForm"),signInEmail=document.getElementById("signInEmail"),signInPassword=document.getElementById("signInPassword"),managerEmail=document.getElementById("managerEmail"),signOutBtn=document.getElementById("signOutBtn");let selectedServices=new Set,currentJobId=null;function updateTotal(){let e=0;selectedServices.forEach(t=>e+=JSON.parse(t).price),totalEl.textContent=`Kshs ${e}`}addBtn.addEventListener("click",()=>{const e="true"===addBtn.getAttribute("aria-expanded");addBtn.setAttribute("aria-expanded",!e),addForm.setAttribute("aria-hidden",e)}),cancelBtn.addEventListener("click",()=>{selectedServices.clear(),customerForm.reset(),services.forEach(e=>e.setAttribute("aria-pressed","false")),updateTotal(),addBtn.setAttribute("aria-expanded",!1),addForm.setAttribute("aria-hidden",!0)}),services.forEach(e=>{e.addEventListener("click",()=>{const t="true"===e.getAttribute("aria-pressed");e.setAttribute("aria-pressed",!t);const n=Number(e.dataset.price),o=e.querySelector(".service-name").textContent.trim(),a=JSON.stringify({name:o,price:n});t?selectedServices.delete(a):selectedServices.add(a),updateTotal()})});const plateInput=document.getElementById("plate"),modelInput=document.getElementById("model"),colorInput=document.getElementById("color");function startJobsListener(){loader.style.display="flex";const e=query(collection(db,"jobs"),where("status","in",["pending","in_progress"]),orderBy("createdAt","desc"));return onSnapshot(e,e=>{cardsContainer.innerHTML="",e.forEach(e=>renderJobCard(e.id,e.data())),loader.style.display="none"})}function renderJobCard(e,t){const n=document.createElement("div");n.className="card",n.innerHTML=`\n    <div class="left">\n      <div class="plate">${t.plate}</div>\n      <div class="meta">${t.model} • ${t.phone||"No phone"}</div>\n    </div>\n    <div class="right">\n      <div class="tag">${t.status.replace("_"," ")}</div>\n      <button class="small-btn primary">${"pending"===t.status?"Start":"in_progress"===t.status?"Complete":"Completed"}</button>\n      <button class="small-btn ghost">Details</button>\n    </div>\n  `;const o=n.querySelector(".primary");n.querySelector(".ghost").onclick=()=>openJobModal(e,t),o.onclick=async()=>{"pending"===t.status?await updateDoc(doc(db,"jobs",e),{status:"in_progress"}):"in_progress"===t.status&&openCustomerFinalizeModal(e,t)},cardsContainer.appendChild(n)}function openJobModal(e,t){currentJobId=e,r_jobid.textContent=e,r_plate.textContent=t.plate,r_model.textContent=t.model,r_color.textContent=t.color,r_services.innerHTML=t.services.map(e=>`<li>${e.name} — Kshs ${e.price}</li>`).join(""),takeStaffSelect.value=t.assignedTo||"",r_assigned.textContent=t.assignedTo||"—",r_total.textContent=`Kshs ${t.total}`,takeStaffSelect.style.display="block",confirmAssignBtn.style.display="block",takeJobBtn.style.display="pending"===t.status?"block":"none",receiptModal.setAttribute("aria-hidden","false")}function closeModal(){currentJobId=null,receiptModal.setAttribute("aria-hidden","true")}function openCustomerFinalizeModal(e,t){currentJobId=e,openJobModal(e,t);const n=document.getElementById("finishForm");n&&n.remove();r_services.insertAdjacentHTML("afterend",'\n    <form id="finishForm" style="\n      margin-top: 18px;\n      display: flex;\n      flex-direction: column;\n      gap: 12px;\n    ">\n      <input id="cust_name" type="text" placeholder="Customer name" required\n        style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px;">\n      <input id="cust_phone" type="tel" placeholder="+2547XXXXXXXX" required\n        style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px;">\n      <button class="btn primary" type="submit" style="padding: 10px; border-radius: 8px; font-weight: 600;">\n        Save & Send Receipt\n      </button>\n    </form>\n  '),document.getElementById("finishForm").onsubmit=async n=>{n.preventDefault();const o=cust_name.value.trim();let a=cust_phone.value.replace(/\s+/g,"");await setDoc(doc(db,"customers",e),{jobId:e,customerName:o,phone:a,carPlate:t.plate,services:t.services,total:t.total,createdAt:serverTimestamp()}),await updateDoc(doc(db,"jobs",e),{status:"completed"});const s=`https://wa.me/${a.replace("+","")}?text=${encodeURIComponent(`NIAPAY RECEIPT\nPlate: ${t.plate}\nServices:\n${t.services.map(e=>e.name+" - "+e.price).join("\n")}\nTotal: Kshs ${t.total}\n\nThank you for choosing NIAPAY Car Wash.`)}`;window.open(s,"_blank"),closeModal()}}customerForm.addEventListener("submit",async e=>{e.preventDefault();const t=plateInput.value.trim(),n=modelInput.value.trim(),o=colorInput.value.trim(),a=[...selectedServices].map(e=>JSON.parse(e)),s=a.reduce((e,t)=>e+t.price,0);await addDoc(collection(db,"jobs"),{plate:t,model:n,color:o,phone:"",services:a,total:s,assignedTo:"",status:"pending",createdAt:serverTimestamp()}),cancelBtn.click()}),closeReceipt.onclick=closeModal,closeReceiptBtn.onclick=closeModal,takeJobBtn.onclick=async()=>{if(!takeStaffSelect.value)return alert("Select staff before taking job");await updateDoc(doc(db,"jobs",currentJobId),{assignedTo:takeStaffSelect.value,status:"in_progress"}),closeModal()},confirmAssignBtn.onclick=async()=>{if(!takeStaffSelect.value)return alert("Select staff");await updateDoc(doc(db,"jobs",currentJobId),{assignedTo:takeStaffSelect.value}),r_assigned.textContent=takeStaffSelect.value,alert("Assigned person updated")},signinForm.onsubmit=async e=>{e.preventDefault(),await signInWithEmailAndPassword(auth,signInEmail.value,signInPassword.value),signinModal.setAttribute("aria-hidden","true")},signOutBtn.onclick=()=>signOut(auth),onAuthStateChanged(auth,e=>{e?(managerEmail.textContent=e.email,window.unsub||(window.unsub=startJobsListener())):(window.unsub&&window.unsub(),window.location="sign.html")});